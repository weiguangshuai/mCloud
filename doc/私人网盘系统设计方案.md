# 私人网盘系统设计方案

## Context（背景）

用户需要构建一个局域网内的私人网盘系统，供家人使用。主要用于照片的存储、上传、下载和预览，偶尔也会有普通文件的上传下载。系统部署在 Windows 本地电脑上，文件存储在指定文件夹中，可以直接通过文件系统访问。

### 核心需求
- **用户管理**：每个家人有独立账号，需要登录使用
- **文件组织**：支持文件夹/目录结构
- **照片功能**：支持缩略图生成和原图预览
- **文件存储**：文件存储在指定文件夹，可直接通过文件系统访问
- **技术栈**：后端 Go + Gin，前端 Vue，数据库存储元数据

---

## 技术架构设计

### 整体架构
```
┌─────────────┐
│   浏览器     │
│  (Vue 前端)  │
└──────┬──────┘
       │ HTTP/REST API
       │
┌──────▼──────┐
│  Gin 后端   │
│  (Go)       │
└──────┬──────┘
       │
   ┌───┴────┬─────────┐
   │        │         │
┌──▼──┐  ┌─▼────┐  ┌─▼────────┐
│MySql│  │Redis │  │文件系统   │
│数据库│  │缓存  │  │(指定目录) │
└─────┘  └──────┘  └──────────┘
```

### 技术选型
- **后端框架**：Gin (Go)
- **数据库**：MySQL（您已安装，稳定可靠，支持并发访问）
- **前端框架**：Vue 3 + Vite（响应式设计，支持手机浏览器访问）
- **UI 组件库**：Element Plus（自适应布局，移动端友好）
- **��片处理**：Go 标准库 image + imaging 库（生成缩略图）
- **认证方式**：JWT（Bearer Token + localStorage）
- **缓存系统**：Redis（用于存储分片上传进度，支持断点续传）

---

## 数据库设计

### 表结构

**说明**：不使用数据库外键约束，所有关联关系与级联处理由应用层代码维护。

#### 1. users（用户表）
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,  -- bcrypt 加密
    nickname VARCHAR(100),
    avatar VARCHAR(255),
    storage_quota BIGINT DEFAULT 10737418240 COMMENT '存储配额(字节)，默认10GB',
    storage_used BIGINT DEFAULT 0 COMMENT '已使用存储空间(字节)',
    deleted_at TIMESTAMP NULL DEFAULT NULL COMMENT '软删除时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**修复的缺陷**：
- ✅ P0-3：存储配额管理缺失
- ✅ P1-7：软删除和回收站

#### 2. folders（文件夹表）
```sql
CREATE TABLE folders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    parent_id INT NULL,  -- NULL 表示根目录
    user_id INT NOT NULL,
    is_root TINYINT(1) NULL DEFAULT NULL, -- 仅根目录为1，其余为NULL
    path VARCHAR(1000) NOT NULL,  -- 以 / 开头，不以 / 结尾
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_parent_id (parent_id),
    UNIQUE KEY uk_user_root (user_id, is_root),
    UNIQUE KEY uk_sibling_name (user_id, parent_id, name, deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**修复的缺陷**：
- ✅ P1-7：软删除和回收站

#### 3. files（文件表）
```sql
CREATE TABLE files (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    folder_id INT NOT NULL,                -- 指向真实文件夹(root为用户root id)
    user_id INT NOT NULL,
    file_object_id INT NOT NULL,           -- 物理文件对象
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL,
    deleted_by INT NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_folder_id (folder_id),
    INDEX idx_file_object_id (file_object_id),
    INDEX idx_deleted_at (deleted_at),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**修复的缺陷**：
- ✅ P0-2：秒传功能安全隐患（引入物理文件对象 + 引用计数）
- ✅ P1-7：软删除和回收站

### 新增表结构

#### 4. file_objects（物理文件对象表）
```sql
CREATE TABLE file_objects (
    id INT PRIMARY KEY AUTO_INCREMENT,
    file_path VARCHAR(1000) NOT NULL,      -- 实际文件存储路径
    thumbnail_path VARCHAR(1000),          -- 缩略图路径（仅图片）
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100),
    is_image TINYINT(1) DEFAULT 0,
    width INT,                             -- 图片宽度
    height INT,                            -- 图片高度
    file_md5 VARCHAR(32) NOT NULL,         -- 用于秒传与完整性验证
    ref_count INT DEFAULT 1,               -- 引用计数
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_md5 (file_md5),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**设计说明**：
- file_objects 保存物理文件属性；files 保存逻辑文件归属
- 秒传命中时复用同一 file_objects，ref_count +1
- 永久删除逻辑文件时 ref_count -1，归零才删除物理文件
- 存储配额按逻辑文件计费（逻辑新增 +size，永久删除 -size）

#### 5. upload_tasks（上传任务表）
```sql
CREATE TABLE upload_tasks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    upload_id VARCHAR(36) UNIQUE NOT NULL COMMENT 'UUID上传任务ID',
    user_id INT NOT NULL,
    folder_id INT NOT NULL COMMENT '目标文件夹ID(根目录为root id)',
    file_name VARCHAR(255) NOT NULL,
    file_size BIGINT NOT NULL,
    file_md5 VARCHAR(32) NOT NULL,
    total_chunks INT NOT NULL,
    uploaded_chunks TEXT COMMENT 'JSON数组，已上传分片索引',
    status ENUM('pending', 'uploading', 'completed', 'failed') DEFAULT 'pending',
    temp_dir VARCHAR(500) COMMENT '临时文件存储目录',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL COMMENT '过期时间，24小时后',
    INDEX idx_upload_id (upload_id),
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**设计说明**：
- 数据库+Redis混合方案：Redis存储高频操作的分片状态（使用Set数据结构），数据库持久化任务元数据
- 支持定时清理过期任务和临时文件
- uploaded_chunks字段作为Redis的备份

**修复的缺陷**：
- ✅ P0-4：临时文件清理机制不明确
- ✅ P0-5：分片上传完整性验证缺失

#### 6. recycle_bin（回收站表）
```sql
CREATE TABLE recycle_bin (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    original_id INT NOT NULL COMMENT '原文件或文件夹ID',
    original_type ENUM('file', 'folder') NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    original_path VARCHAR(1000) COMMENT '删除前的完整路径',
    original_full_path VARCHAR(1000) COMMENT '删除前完整路径(用于冲突恢复判定)',
    original_folder_id INT COMMENT '删除前所在文件夹ID',
    file_object_id INT NULL COMMENT '物理文件对象ID(仅文件类型)',
    file_size BIGINT COMMENT '文件大小（仅文件类型）',
    deleted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '删除时间',
    expires_at TIMESTAMP NOT NULL COMMENT '回收站过期时间，默认30天',
    metadata JSON COMMENT '额外元数据（缩略图路径、MIME类型等）',
    INDEX idx_user_id (user_id),
    INDEX idx_deleted_at (deleted_at),
    INDEX idx_expires_at (expires_at),
    INDEX idx_original_type (original_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**metadata字段JSON示例**：
```json
{
  "mime_type": "image/jpeg",
  "thumbnail_path": "/storage/thumbnails/user_1/2024/01/uuid_thumb.jpg",
  "is_image": true,
  "width": 1920,
  "height": 1080,
  "file_md5": "abc123def456...",
  "file_object_id": 456
}
```

**修复的缺陷**：
- ✅ P1-7：软删除和回收站

#### 7. thumbnail_tasks（缩略图任务表）
```sql
CREATE TABLE thumbnail_tasks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    file_id INT NOT NULL,
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    retry_count INT DEFAULT 0,
    max_retries INT DEFAULT 3,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL,
    INDEX idx_file_id (file_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**修复的缺陷**：
- ✅ P1-8：缩略图异步生成

---

## 系统时序图

为了更好地理解系统各个模块之间的交互流程，我们提供了详细的时序图。这些时序图展示了用户操作、前端、后端、数据库和文件系统之间的完整交互过程。

### 时序图文件

所有时序图使用 PlantUML 格式编写，存储在 `doc/sequence-diagrams.puml` 文件中。您可以使用 PlantUML 工具或在线服务（如 [PlantUML Online](http://www.plantuml.com/plantuml/uml/)）来查看和渲染这些时序图。

### 包含的时序图

1. **用户注册登录流程** - 展示用户注册、登录和JWT认证的完整流程
2. **文件上传流程** - 展示文件上传、缩略图生成和数据库记录创建的过程
3. **文件下载流程** - 展示文件下载的权限验证和文件传输过程
4. **图片预览流程** - 展示缩略图加载和原图预览的交互流程
5. **文件夹操作流程** - 展示文件夹的创建、重命名和删除操作
6. **文件移动流程** - 展示文件在不同文件夹间移动的过程

### 如何查看时序图

**方法一：使用 PlantUML 在线服务**
1. 打开 [PlantUML Online](http://www.plantuml.com/plantuml/uml/)
2. 将 `doc/sequence-diagrams.puml` 文件内容复制粘贴到编辑器中
3. 点击"Submit"按钮即可查看渲染后的时序图

**方法二：使用 VS Code 插件**
1. 安装 VS Code 插件：PlantUML
2. 打开 `doc/sequence-diagrams.puml` 文件
3. 按 `Alt+D` 预览时序图

**方法三：使用命令行工具**
```bash
# 安装 PlantUML
# 需要先安装 Java 和 Graphviz

# 生成 PNG 图片
java -jar plantuml.jar doc/sequence-diagrams.puml

# 生成 SVG 图片
java -jar plantuml.jar -tsvg doc/sequence-diagrams.puml
```

---

## 后端 API 设计

### API 路由规划

#### 认证相关
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/profile` - 获取当前用户信息

**说明**：登录接口返回 JWT access_token，前端存储在 localStorage 中。
后续请求通过 `Authorization: Bearer <token>` 头携带认证信息。Token 过期需重新登录。

#### 文件夹管理
- `GET /api/folders` - 获取文件夹列表（支持 parent_id 查询）
- `POST /api/folders` - 创建文件夹
- `PUT /api/folders/:id` - 重命名文件夹
- `DELETE /api/folders/:id` - 删除文件夹（软删除，递归标记 + 回收站）

#### 文件管理
- `GET /api/files` - 获取文件列表（支持 folder_id 查询）
- `POST /api/files/upload` - 上传文件（小文件直接上传）
- `POST /api/files/upload/init` - 初始化分片上传任务（大文件）
- `POST /api/files/upload/chunk` - 上传文件分片（支持断点续传）
- `POST /api/files/upload/complete` - 完成分片上传，合并文件
- `GET /api/files/upload/status/:upload_id` - 查询上传进度（断点续传）
- `GET /api/files/:id/download` - 下载文件（支持 Range 请求，断点续传）
- `HEAD /api/files/:id/download` - 获取文件元信息（用于分段下载）
- `GET /api/files/:id/preview` - 预览文件（原图）
- `GET /api/files/:id/thumbnail` - 获取缩略图
- `DELETE /api/files/:id` - 删除文件（已修改为软删除）
- `PUT /api/files/:id/move` - 移动文件到其他文件夹

#### 现有API修改说明

**GET /api/files - 添加分页参数**

修改后的请求格式：
```
GET /api/files?folder_id={folder_id}&page={page}&page_size={page_size}&sort_by={field}&order={asc|desc}
```

新增参数：
- `page`: 页码，默认1，最小1
- `page_size`: 每页数量，默认20，范围1-100
- `sort_by`: 排序字段，可选值：name, created_at, file_size，默认created_at
- `order`: 排序方向，可选值：asc, desc，默认desc

响应格式变更：
```json
{
  "code": 200,
  "data": {
    "files": [...],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 150,
      "total_pages": 8,
      "has_next": true,
      "has_prev": false
    }
  }
}
```

**修复的缺陷**：✅ P0-1 文件列表分页

**POST /api/files/upload/init - 添加配额检查和秒传限制**

修改说明：
1. 上传前检查用户存储配额
2. 秒传查询限制在用户范围内（JOIN files + file_objects）
   - 示例：`SELECT fo.id FROM file_objects fo JOIN files f ON f.file_object_id = fo.id WHERE f.user_id = ? AND fo.file_md5 = ? AND f.deleted_at IS NULL`
3. 秒传成功时：创建 files 记录、file_objects.ref_count +1，并更新用户配额（逻辑计费）

新增响应场景：
```json
// 配额不足
{
  "code": 400,
  "message": "存储空间不足",
  "data": {
    "storage_quota": 10737418240,
    "storage_used": 10500000000,
    "available_space": 237418240,
    "required_space": 52428800
  }
}

// 秒传成功
{
  "code": 200,
  "message": "秒传成功",
  "data": {
    "status": "instant_upload",
    "file_id": 123
  }
}
```

**修复的缺陷**：✅ P0-2 秒传安全、✅ P0-3 存储配额

**POST /api/files/upload/chunk - Redis原子操作**

修改说明：
- 使用Redis Set数据结构存储已上传分片：`SADD upload:{upload_id}:chunks {chunk_index}`
- 检查分片是否已上传：`SISMEMBER upload:{upload_id}:chunks {chunk_index}`
- 获取已上传分片列表：`SMEMBERS upload:{upload_id}:chunks`

**修复的缺陷**：✅ P0-6 Redis原子操作

**DELETE /api/files/:id - 改为软删除**

修改说明：
- 不再物理删除文件，而是设置deleted_at字段
- 将文件信息写入recycle_bin表
- 不立即删除物理文件，而是等待回收站清理
- 永久删除时递减 file_objects.ref_count，归零才删除物理文件

**修复的缺陷**：✅ P1-7 软删除和回收站

#### 新增API

**用户存储管理**
- `GET /api/user/storage/quota` - 查询存储配额和使用情况

**批量操作**
- `POST /api/files/batch/delete` - 批量删除文件
- `POST /api/files/batch/move` - 批量移动文件
- `POST /api/files/thumbnails/batch` - 批量加载缩略图

**回收站管理**
- `GET /api/recycle-bin` - 获取回收站列表（支持分页）
- `POST /api/recycle-bin/:id/restore` - 恢复文件/文件夹
- `DELETE /api/recycle-bin/:id` - 永久删除
- `POST /api/recycle-bin/empty` - 清空回收站
  - 恢复冲突默认策略：自动改名追加 `(restored)` 后缀

**系统监控**
- `GET /api/health` - 健康检查接口

### 后端目录结构
```
backend/
├── main.go                 # 入口文件
├── go.mod                  # Go 模块依赖
├── go.sum
├── config/
│   └── config.go          # 配置管理（数据库路径、文件存储路径等）
├── models/
│   ├── user.go            # 用户模型
│   ├── folder.go          # 文件夹模型
│   ├── file.go            # 文件模型（逻辑文件）
│   └── file_object.go     # 物理文件对象模型
├── database/
│   └── db.go              # 数据库初���化和连接
├── middleware/
│   ├── auth.go            # JWT Bearer Token 认证中间件
│   └── cors.go            # CORS 中间件
├── handlers/
│   ├── auth.go            # 认证相关处理
│   ├── folder.go          # 文件夹相关处理
│   └── file.go            # 文件相关处理
├── services/
│   ├── user_service.go    # 用户业务逻辑
│   ├── folder_service.go  # 文件夹业务逻辑
│   ├── file_service.go    # 文件业务逻辑
│   ├── file_object_service.go # 物理文件对象业务逻辑（可选）
│   └── thumbnail_service.go # 缩略图生成服务
├── utils/
│   ├── jwt.go             # JWT 工具
│   ├── password.go        # 密码加密工具
│   └── response.go        # 统一响应格式
└── storage/               # 文件存储目录（可配置）
    ├── files/             # 原始文件
    └── thumbnails/        # 缩略图
```

---

## 前端设计

### 前端目录结构
```
frontend/
├── public/
├── src/
│   ├── main.js            # 入口文件
│   ├── App.vue            # 根组件
│   ├── router/
│   │   └── index.js       # 路由配置
│   ├── store/
│   │   └── index.js       # Vuex/Pinia 状态管理
│   ├── api/
│   │   ├── auth.js        # 认证 API
│   │   ├── folder.js      # 文件夹 API
│   │   └── file.js        # 文件 API
│   ├── views/
│   │   ├── Login.vue      # 登录页面
│   │   ├── Register.vue   # 注册页面
│   │   └── Home.vue       # 主页面（文件管理）
│   ├── components/
│   │   ├── FileList.vue   # 文件列表组件
│   │   ├── FolderTree.vue # 文件夹树组件
│   │   ├── FileUpload.vue # 文件上传组件
│   │   ├── ImagePreview.vue # 图片预览组件
│   │   └── Breadcrumb.vue # 面包屑导航
│   └── utils/
│       ├── request.js     # Axios 封装
│       └── auth.js        # 认证工具
├── package.json
└── vite.config.js
```

### 主要页面功能

#### 1. 登录/注册页面
- 用户名密码登录
- 新用户注册
- JWT 保存在 localStorage，通过 Authorization 头传递

#### 2. 主页面（文件管理）
- **左侧**：文件夹树形结构
- **中间**：当前文件夹的文件列表
  - 图片显示缩略图
  - 普通文件显示图标
  - 支持列表视图和网格视图切换
- **顶部**：
  - 面包屑导航
  - 上传按钮
  - 新建文件夹按钮
  - 搜索框（可选）
- **功能**：
  - 点击图片预览大图
  - 文件下载
  - 文件/文件夹删除
  - 文件/文件夹重命名
  - 拖拽上传

#### 3. 移动端适配
- **响应式设计**：使用 Element Plus 的响应式布局组件
- **触摸优化**：
  - 增大按钮点击区域
  - 支持触摸滑动操作
  - 优化图片预览手势（捏合缩放、滑动切换）
- **布局调整**：
  - 移动端隐藏文件夹树，改为下拉菜单或抽屉
  - 文件列表自动切换为网格视图
  - 简化顶部导航栏
- **性能优化**：
  - 移��端优先加载缩略图
  - 图片懒加载
  - 减少不必要的动画效果

---

## 文件存储设计

### 存储策略

**逻辑文件与物理文件拆分**：
- `files` 仅记录用户归属与目录结构
- `file_objects` 记录物理文件路径与属性，并通过 `ref_count` 管理生命周期

#### 1. 文件存储路径规则
```
storage/
├── files/
│   └── {user_id}/
│       └── {year}/
│           └── {month}/
│               └── {uuid}_{original_filename}
└── thumbnails/
    └── {user_id}/
        └── {year}/
            └── {month}/
                └── {uuid}_thumb.jpg
```

**优点**：
- 按用户隔离，便于管理
- 按时间分类，避免单目录文件过多
- UUID 前缀避免文件名冲突
- 保留原始文件名，便于直接在文件系统中查看

#### 2. 文件命名规则
- 使用 UUID 作为唯一标识
- 保留原始文件扩展名
- 格式：`{uuid}_{sanitized_original_name}.{ext}`
- 示例：`a1b2c3d4-e5f6-7890-abcd-ef1234567890_family_photo.jpg`

#### 3. 缩略图生成规则
- 仅对图片文件生成缩略图
- 支持格式：JPG, PNG, GIF, BMP, WEBP
- 缩略图尺寸：300x300（保持宽高比）
- 格式统一为 JPEG（减小体积）
- 质量：85%

### 配置文件设计

创建 `config.yaml`：
```yaml
server:
  port: 8080
  host: 0.0.0.0  # 允许局域网访问

database:
  host: "localhost"
  port: 3306
  username: "root"
  password: "your_mysql_password"
  database: "mcloud"
  charset: "utf8mb4"
  max_idle_conns: 10
  max_open_conns: 100

storage:
  base_path: "D:/MyCloudStorage"  # 用户指定的存储路径
  max_file_size: 1073741824       # 1GB
  allowed_extensions: ["*"]        # 允许所有文件类型
  chunk_size: 5242880             # 分片大小 5MB
  chunk_upload_threshold: 5242880 # 大于5MB的��件启用分片上传
  default_user_quota: 10737418240      # 默认用户配额10GB
  temp_file_cleanup_interval: 3600     # 临时文件清理间隔（秒）
  temp_file_retention: 86400           # 临时文件保留时间（秒）

redis:
  host: "localhost"
  port: 6379
  password: ""                    # Redis 密码（如果设置）
  db: 0                           # 数据库编号
  upload_task_expire: 86400       # 上传任务过期时间（24小时）

jwt:
  secret: "your-secret-key-change-in-production"
  expire_hours: 168  # 7天

thumbnail:
  width: 300
  height: 300
  quality: 85
  async_generation: true               # 是否异步生成
  worker_count: 4                      # worker数量
  retry_max: 3                         # 失败重试次数

recycle_bin:
  enabled: true                        # 是否启用回收站
  retention_days: 30                   # 回收站保留天数
  cleanup_interval: 86400              # 清理间隔（秒）
  max_items_per_user: 1000             # 每用户最大项目��

pagination:
  default_page_size: 20                # 默认每页数量
  max_page_size: 100                   # 最大每页数量
  default_sort_by: "created_at"        # 默认排序字段
  default_order: "desc"                # 默认排序方向

health_check:
  enabled: true                        # 是否启用健康检查
  endpoint: "/api/health"              # 健康检查端点
  timeout_ms: 5000                     # 超时时间（毫秒）
```

---

## 关键实现细节

### 1. 文件上传流程（支持断点续传）

#### 小文件上传（< 5MB）
```
1. 前端选择文件 → FormData 封装
2. 后端接收文件 → 验证文件类型和大小
3. 生成 UUID 和存储路径
4. 保存文件到指定目录
5. 如果是图片，生成缩略图
6. 写入 file_objects（物理文件对象）
7. 写入 files（逻辑文件记录，关联 file_object_id）
8. 返回文件信息给前端
```

#### 大文件分片上传（>= 5MB）
```
1. 前端计算文件 MD5，将文件分片（每片 5MB）
2. 调用 /upload/init 接口，检查是否已存在相同 MD5 的文件
   - 如果存在（用户范围内命中）：复用 file_objects，ref_count +1，创建 files 记录
   - 如果不存在：创建上传任务，返回 upload_id
3. 循环上传每个分片到 /upload/chunk
   - 后端保存分片到临时目录
   - 更新 Redis 中的上传进度
   - 前端更新进度条
4. 所有分片上传完成后，调用 /upload/complete
   - 后端合并所有分片
   - 验证文件完整性（MD5）
   - 生成缩略图（如果是图片）
   - 写入 file_objects（物理文件对象）
   - 写入 files（逻辑文件记录，关联 file_object_id）
   - 清理临时文件
```

#### 断点续传
```
1. 上传过程中网络中断，前端保存 upload_id 到 localStorage
2. 用户刷新页面或重新打开，前端检测未完成的任务
3. 调用 /upload/status/:upload_id 获取已上传的分片列表
4. 前端计算未上传的分片，继续从断点处上传
5. 跳过已上传的分片，只上传缺失的部分
```

**Redis 存储结构：**
```json
{
  "key": "upload:{upload_id}",
  "value": {
    "file_md5": "abc123...",
    "file_name": "example.mp4",
    "file_size": 52428800,
    "total_chunks": 10,
    "uploaded_chunks": [0, 1, 2, 5],
    "user_id": 1,
    "folder_id": 2,
    "created_at": "2024-01-01T00:00:00Z"
  },
  "expire": 86400
}
```

### 2. 文件下载流程（支持断点续传）

#### 普通下载
```
1. 前端请求下载文件
2. 后端验证权限，返回文件流
3. 响应头包含：
   - Content-Length: 文件大小
   - Accept-Ranges: bytes（表示支持断点续传）
   - Content-Disposition: attachment
```

#### 断点续传下载
```
1. 下载过程中网络中断
2. 前端记录已下载的字节数
3. 重新发起请求时，添加 Range 头：
   Range: bytes=1048576-
   （从第 1048576 字节开始继续下载）
4. 后端解析 Range 头，返回剩余部分：
   - Status: 206 Partial Content
   - Content-Range: bytes 1048576-10485759/10485760
   - Content-Length: 9437184
5. 浏览器自动追加到已下载部分
```

#### 分段下载（超大文件优化）
```
1. 前端先发送 HEAD 请求获取文件大小
2. 计算分段策略（如每段 10MB）
3. 并发发起多个 Range 请求：
   - Range: bytes=0-10485759
   - Range: bytes=10485760-20971519
   - ...
4. 前端合并所有分段，生成完整文件
```

**HTTP Range 请求示例：**
```
# 请求
GET /api/files/123/download
Range: bytes=1048576-

# 响应
HTTP/1.1 206 Partial Content
Content-Type: application/octet-stream
Content-Length: 9437184
Content-Range: bytes 1048576-10485759/10485760
Accept-Ranges: bytes
```

### 3. 认证流程
```
1. 用户登录 → 验证用户名密码
2. 生成 JWT access_token（包含 user_id，7天有效）
3. 返回 token 给前端，前端存储到 localStorage
4. 后续请求通过 Authorization: Bearer <token> 头携带
5. 后端中间件从 Authorization 头解析并验证 token
6. token 过期需重新登录
7. 从 Token 中提取 user_id，确保用户只能访问自己的文件
```

### 4. 文件夹路径管理
- 使用 `path` 字段存储完整路径（如：`/照片/2024/春节`），统一以 `/` 开头、不以 `/` 结尾
- 每个用户创建一条根目录记录（`is_root = 1`，`path = "/"`）
- 便于面包屑导航和路径查询
- 创建文件夹时自动计算并存储完整路径
- 移动文件夹时需要递归更新子文件夹路径

### 5. 缩略图生成（Go 实现）
```go
// 使用 github.com/disintegration/imaging 库
import "github.com/disintegration/imaging"

func GenerateThumbnail(srcPath, dstPath string, width, height int) error {
    img, err := imaging.Open(srcPath)
    if err != nil {
        return err
    }

    // 保持宽高比缩放
    thumb := imaging.Fit(img, width, height, imaging.Lanczos)

    // 保存为 JPEG
    return imaging.Save(thumb, dstPath, imaging.JPEGQuality(85))
}
```

---

## 项目初始化步骤

### 后端初始化
```bash
# 1. 创建后端目录
mkdir backend
cd backend

# 2. 初始化 Go 模块
go mod init mcloud

# 3. 安装依赖
go get github.com/gin-gonic/gin
go get github.com/golang-jwt/jwt/v5
go get gorm.io/gorm
go get gorm.io/driver/mysql
go get github.com/disintegration/imaging
go get golang.org/x/crypto/bcrypt
go get gopkg.in/yaml.v3
go get github.com/redis/go-redis/v9
```

### 前端初始化
```bash
# 1. 创建 Vue 项目
npm create vite@latest frontend -- --template vue

# 2. 安装依赖
cd frontend
npm install

# 3. 安装额外依赖
npm install vue-router@4
npm install pinia
npm install axios
npm install element-plus
npm install @element-plus/icons-vue
```

---

## 关键文件列表

### 后端核心文件（需要创建）

1. **backend/main.go** - 应用入口，初始化路由和中间件
2. **backend/config/config.go** - 配置管理
3. **backend/database/db.go** - 数据库初始化
4. **backend/models/user.go** - 用户模型
5. **backend/models/folder.go** - 文件夹模型
6. **backend/models/file.go** - 文件模型（逻辑文件）
7. **backend/models/file_object.go** - 物理文件对象模型
8. **backend/middleware/auth.go** - JWT Bearer Token 认证中间件
9. **backend/middleware/cors.go** - CORS 中间件
10. **backend/handlers/auth.go** - 认证处理器
11. **backend/handlers/folder.go** - 文件夹处理器
12. **backend/handlers/file.go** - 文件处理器
13. **backend/services/thumbnail_service.go** - 缩略图生成服务
14. **backend/utils/jwt.go** - JWT 工具
15. **backend/utils/password.go** - 密码加密工具
16. **backend/utils/response.go** - 统一响应格式
17. **backend/config.yaml** - 配置文件

### 前端核心文件（需要创建）

1. **frontend/src/main.js** - 应用入口
2. **frontend/src/App.vue** - 根组件
3. **frontend/src/router/index.js** - 路由配置
4. **frontend/src/store/index.js** - 状态管理
5. **frontend/src/api/request.js** - Axios 封装
6. **frontend/src/api/auth.js** - 认证 API
7. **frontend/src/api/folder.js** - 文件夹 API
8. **frontend/src/api/file.js** - 文件 API
9. **frontend/src/views/Login.vue** - 登录页面
10. **frontend/src/views/Register.vue** - 注册页面
11. **frontend/src/views/Home.vue** - 主页面
12. **frontend/src/components/FileList.vue** - 文件列表组件
13. **frontend/src/components/FolderTree.vue** - 文件夹树组件
14. **frontend/src/components/FileUpload.vue** - 文件上传组件
15. **frontend/src/components/ImagePreview.vue** - 图片预览组件
16. **frontend/vite.config.js** - Vite 配置（代理设置）

---

## 实现顺序建议

### 第一阶段：基础框架搭建
1. 初始化后端项目结构和依赖
2. 初始化前端项目结构和依赖
3. 创建配置文件和数据库初始化代码
4. 实现统一响应格式和错误处理

### 第二阶段：用户认证系统
1. 实现用户模型和数据库表
2. 实现密码加密和 JWT 工具
3. 实现注册、登录 API
4. 注册成功后创建用户 root 目录记录
5. 实现 JWT Bearer Token 认证中间件
6. 实现前端登录/注册页面
7. 实现前端路由守卫

### 第三阶段：文件夹管理
1. 实现文件夹模型和数据库表
2. 实现文件夹 CRUD API
3. 实现前端文件夹树组件
4. 实现文件夹创建、删除、重命名功能

### 第四阶段：文件上传下载
1. 实现文件模型和数据库表
2. 实现文件上传 API（包括存储逻辑）
3. 实现文件下载 API
4. 实现前端文件上传组件
5. 实现前端文件列表展示

### 第五阶段：图片预览和缩略图
1. 实现缩略图生成服务
2. 实现缩略图 API
3. 实现图片预览 API
4. 实现前端图片预览组件
5. 优化图片加载性能

### 第六阶段：优化和完善
1. 添加文件搜索功能（可选）
2. 添加文件移动功能
3. 优化 UI/UX
4. 性能优化和测试
5. 编写部署文档

---

## 验证方案

### 后端验证
1. **启动后端服务**
   ```bash
   cd backend
   go run main.go
   ```
   - 验证服务在 `http://localhost:8080` 启动成功
   - 验证 MySQL 数据库连接成功
   - 验证数据库表自��创建（如果使用 GORM AutoMigrate）
   - 验证存储目录自动创建

2. **API 测试**（使用 Postman 或 curl）
   - 测试用户注册：`POST /api/auth/register`
   - 测试用户登录：`POST /api/auth/login`
   - 测试文件上传：`POST /api/files/upload`（需要 Bearer Token）
   - 测试文件列表：`GET /api/files`
   - 测试文件下载：`GET /api/files/:id/download`
   - 测试缩略图：`GET /api/files/:id/thumbnail`

3. **文件系统验证**
   - 上传文件后，检查指定存储目录是否有文件
   - 验证文件可以直接在文件管理器中打开
   - 验证缩略图是否正确生成

### 前端验证
1. **启动前端服务**
   ```bash
   cd frontend
   npm run dev
   ```
   - 验证服务在 `http://localhost:5173` 启动成功

2. **功能测试**
   - 测试用户注册和登录
   - 测试创建文件夹
   - 测试上传文件（图片和普通文件）
   - 测试文件列表展示
   - 测试图片缩略图显示
   - 测试点击图片预览大图
   - 测试文件���载
   - 测试文件删除
   - 测试文件夹导航

### 端到端测试场景
1. 注册新用户 → 登录
2. 创建文件夹"家庭照片"
3. 进入文件夹，上传多张照片
4. 验证缩略图正常显示
5. 点击照片预览大图
6. 下载照片到本地
7. 在文件管理器中打开存储目录，验证文件存在且可以打开
8. 创建子文件夹"2024春节"
9. 上传普通文件（如 PDF）
10. 测试文件夹导航和面包屑

---

## 部署说明

### Windows 本地部署

#### 0. MySQL 数据库准备
```sql
-- 登录 MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE mcloud CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选，建议使用独立用户）
CREATE USER 'mcloud'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON mcloud.* TO 'mcloud'@'localhost';
FLUSH PRIVILEGES;

-- 使用数据库
USE mcloud;

-- 执行表结构创建（从数据库设计部分的 SQL）
```

#### 0.5. Redis 安装和配置

##### Windows 安装 Redis
```bash
# 方法1: 使用 Chocolatey 安装（推荐）
choco install redis-64

# 方法2: 使用 Memurai（Windows 原生 Redis 替代品）
# 下载地址：https://www.memurai.com/
# 下载并安装 Memurai Developer Edition（免费）

# 方法3: 使用 WSL2 + Docker
wsl --install
docker run -d --name redis -p 6379:6379 redis:latest

# 方法4: 下载 Redis for Windows
# 下载地址：https://github.com/tporadowski/redis/releases
# 解压后运行 redis-server.exe
```

##### 启动 Redis
```bash
# 如果使用 Chocolatey 安装
redis-server

# 如果使用 Memurai
# 安装后会自动作为 Windows 服务运行

# 验证 Redis 是否运行
redis-cli ping
# 应该返回 PONG
```

##### Redis 配置（可选）
```bash
# 如果需要设置密码，编辑 redis.conf
requirepass your_password

# 重启 Redis 服务
```

**注意：**
- 对于家庭局域网使用，Redis 可以不设置密码
- 如果设置了密码，需要在 config.yaml 中配置
- Redis 主要用于存储分��上传的临时信息，数据会自动过期（24小时）
- 如果不想安装 Redis，可以暂时跳过断点续传功能，小文件上传仍可正常使用

#### 1. 后端部署
```bash
# 编译为可执行文件
cd backend
go build -o mcloud.exe main.go

# 运行
./mcloud.exe
```

#### 2. 前端部署
```bash
# 构建生产版本
cd frontend
npm run build

# 将 dist 目录配置到后端静态文件服务
# 或使用 nginx 等 Web 服务器
```

#### 3. 配置文件
修改 `backend/config.yaml`：
```yaml
database:
  host: "localhost"
  port: 3306
  username: "root"  # 或您创建的 mcloud 用户
  password: "your_mysql_password"  # 修改为您的 MySQL 密码
  database: "mcloud"

storage:
  base_path: "D:/MyCloudStorage"  # 修改为您指定的存储路径
```

#### 4. 局域网访问（支持手机浏览器）
- 确保 Windows 防火墙允许端口 8080
- 查看本机 IP：在命令行运行 `ipconfig`，找到 IPv4 地址（如 192.168.1.100）
- **电脑访问**：在浏览器打开 `http://{您的电脑IP}:8080`
- **手机访问**：
  - 确保手机连接到同一局域网（同一 WiFi）
  - 在手机浏览器打开 `http://{您的电脑IP}:8080`
  - 建议添加到手机主屏幕，方便快速访问
  - 响应式设计自动适配手机屏幕
- **测试连接**：
  - 在手机浏览器输入地址后，应该能看到登录页面
  - 如果无法访问，检查防火墙设置或尝试临时关闭防火墙测试

### 开机自启动（可选）
1. 创建批处理文件 `start_mcloud.bat`：
```batch
@echo off
cd /d D:\mcloud\backend
start mcloud.exe
```

2. 将批处理文件添加到 Windows 启动文件夹：
   - 按 `Win + R`，输入 `shell:startup`
   - 将批处理文件快捷方式放入该文件夹

---

## 注意事项和安全建议

### 安全性
1. **JWT Secret**：修改 `config.yaml` 中的 JWT secret 为强密码
2. **Token 安全**：JWT 存储在 localStorage，注意 XSS 防护
3. **CORS 配置**：生产环境应将 Access-Control-Allow-Origin 设为具体域名
4. **密码强度**：建议在注册时添加密码强度验证
5. **文件类型限制**：可以根据需要限制允许上传的文件类型
6. **文件大小限制**：默认限制为 1GB，可根据需要调整
7. **HTTPS**：如果需要外网访问，建议配置 HTTPS

### 性能优化
1. **大文件上传**：考虑实现分片上传（可选）
2. **缩略图缓存**：缩略图生成后缓存，避免重复生成
3. **数据库索引**：在 `user_id`、`folder_id` 等字段上建立索引
4. **静态资源**：前端构建后的静态资源可以由后端直接服务

### 备份建议
1. **数据库备份**：定期备份 SQLite 数据库文件
2. **文件备份**：定期备份存储目录
3. **配置备份**：备份 `config.yaml` 配置文件

### 已实现的高级功能
1. **断点续传**：支持上传和下载的断点续传
   - 大文件分片上传（5MB 每片）
   - 网络中断后可继续传输
   - 使用 Redis 缓存上传进度
   - 支持 HTTP Range 请求下载
   - 秒传功能（基于文件 MD5，复用物理文件并计数）

### 扩展功能（可选）
1. **文件分享**：生成分享链接，允许临时访问
2. **文件搜索**：基于文件名的全文搜索
3. **回收站**：删除文件时先移到回收站
4. **文件标签**：为文件添加标签功能
5. **相册模式**：专门的照片浏览模式
6. **视频预览**：支持视频文件的在线预览
7. **文件版本**：保留文件的历史版本
8. **并发控制**：限制同时上传/下载的文件数量
9. **传输速度限制**：防止占用全部带宽

---

## 技术依赖总结

### 后端依赖
- `github.com/gin-gonic/gin` - Web 框架
- `gorm.io/gorm` - ORM 框架
- `gorm.io/driver/mysql` - MySQL 驱动
- `github.com/golang-jwt/jwt/v5` - JWT 认证
- `github.com/disintegration/imaging` - 图片处理
- `golang.org/x/crypto/bcrypt` - 密码加密
- `gopkg.in/yaml.v3` - 配置文件解析
- `github.com/redis/go-redis/v9` - Redis 客户端（用于断点续传）

### 前��依赖
- `vue@3` - 前端框架
- `vue-router@4` - 路由管理
- `pinia` - 状态管理
- `axios` - HTTP 客户端
- `element-plus` - UI 组件库
- `@element-plus/icons-vue` - 图标库

---

## 总结

这个设计方案提供了一个完整的私人网盘系统架构，满足您的所有需求：

✅ **用户认证**：每个家人独立账号，JWT Bearer Token 认证
✅ **文件组织**：支持文件夹/目录结构
✅ **照片功能**：缩略图生成 + 原图预览
✅ **文件存储**：存储在指定文件夹，可直接通过文件系统访问
✅ **断点续传**：支持大文件分片上传和断点续传下载，网络中断后可继续
✅ **秒传功能**：基于文件 MD5 的秒传，相同文件复用物理文件并计数
✅ **技术栈**：Go + Gin + Vue + MySQL + Redis
✅ **Windows 部署**：适合 Windows 本地部署，支持局域网访问
✅ **移动端支持**：响应式设计，手机浏览器可直接访问使用

该方案采用前后端分离架构，代码结构清晰，易于维护和扩展。数据库使用 MySQL 存储元数据，Redis 缓存上传任务进度，两者配合实现稳定可靠的断点续传功能。文件存储采用用户隔离 + 时间分类的方式，既保证了安全性，又便于直接在文件系统中管理。

前端采用响应式设计，自动适配不同设备屏幕，家人可以通过电脑浏览器或手机浏览器访问，只需连接到同一局域网即可。

实现顺序建议从基础框架开始，逐步完成用户认证、文件夹管理、文件上传下载、图片预览等功能，最后进行移动端优化和完善。

