import{i as pe,r as x,o as C,c as R,a as p,w as v,b as N,j as J,k as we,t as X,h as B,l as me,n as Oe,m as Te,p as je,f as q,F as de,q as Z,v as Pe,x as Ke,y as He,z as ve,A as ee,d as te,B as Ue,C as Je,D as fe,E as W,G as Fe,H as qe,I as Ye,u as Ge,J as Xe,K as Ze,L as We,M as Qe,e as et,N as tt}from"./index-BEiAi5gP.js";import{a as H,_ as se,u as Be,g as nt}from"./_plugin-vue_export-helper-OYLwkH4z.js";function Se(f=0){return H.get("/folders",{params:{parent_id:f}})}function at(f){return H.post("/folders",f)}function lt(f,D){return H.put(`/folders/${f}`,D)}function ot(f){return H.delete(`/folders/${f}`)}const st={class:"folder-tree"},it={class:"node-content"},rt={__name:"FolderTree",emits:["select"],setup(f,{emit:D}){const U=D,O=Be(),k=B(null),F=B([]),M={label:"name",children:"children",isLeaf:"isLeaf"},A=me(()=>{var d;return((d=O.userInfo)==null?void 0:d.root_folder_id)||0});function c(){return[{id:A.value,name:"全部文件",isRoot:!0,isLeaf:!1}]}async function b(d,L){if(d.level===0){L(F.value);return}try{const T=((await Se(d.data.id)).data||[]).map(j=>({id:j.id,name:j.name,isLeaf:!1}));L(T)}catch{L([])}}function w(d,L){const S=[];let T=L;for(;T&&T.level>0;){const j=T.level===1?"根目录":T.data.name;S.unshift({id:T.data.id,name:j}),T=T.parent}S.length===0&&S.push({id:A.value,name:"根目录"}),U("select",{id:d.id,breadcrumbs:S})}return pe(()=>A.value,async()=>{var d;F.value=c(),await Oe(),(d=k.value)==null||d.setCurrentKey(O.currentFolderID||A.value)},{immediate:!0}),pe(()=>O.currentFolderID,d=>{var L;(L=k.value)==null||L.setCurrentKey(d)}),(d,L)=>{const S=x("el-icon"),T=x("el-tree");return C(),R("div",st,[p(T,{ref_key:"treeRef",ref:k,data:F.value,props:M,"node-key":"id",lazy:"",load:b,"highlight-current":"","expand-on-click-node":!1,onNodeClick:w},{default:v(({data:j})=>[N("div",it,[p(S,null,{default:v(()=>[p(J(we))]),_:1}),N("span",null,X(j.name),1)])]),_:1},8,["data"])])}}},ut=se(rt,[["__scopeId","data-v-c92c9de3"]]),Ae=10*60*1e3;function ct(f){return H.get("/files",{params:f})}function dt(f,D){return H.post("/files/upload",f,{headers:{"Content-Type":"multipart/form-data"},timeout:Ae,skipErrorMessage:!0,onUploadProgress:D})}function ft(f){return H.post("/files/upload/init",f,{skipErrorMessage:!0})}function pt(f,D){return H.post("/files/upload/chunk",f,{headers:{"Content-Type":"multipart/form-data"},timeout:Ae,skipErrorMessage:!0,onUploadProgress:D})}function mt(f){return H.post("/files/upload/complete",f,{timeout:Ae,skipErrorMessage:!0})}function xe(f){return H.get(`/files/upload/status/${f}`,{skipErrorMessage:!0})}function vt(f){return H.delete(`/files/${f}`)}function _t(f,D){return H.put(`/files/${f}/rename`,{name:D})}function ht(f,D){return H.put(`/files/${f}/move`,{folder_id:D})}function gt(f){return H.post("/files/batch/delete",{file_ids:f})}function yt(f,D){return H.post("/files/batch/move",{file_ids:f,folder_id:D})}function bt(f){return H.get(`/files/${f}/download`,{responseType:"blob"})}function wt(f){return H.get(`/files/${f}/thumbnail`,{responseType:"blob"})}function Ct(f){return H.get(`/files/${f}/preview`,{responseType:"blob"})}const $t={class:"file-list-container"},kt={key:0,class:"toolbar"},Ut={class:"toolbar-left"},St={class:"toolbar-right"},Ft={key:1,class:"loading"},Bt={key:2,class:"grid-view"},At=["onClick","onContextmenu"],xt={class:"file-name"},Mt=["onClick","onContextmenu"],Tt=["src"],It={class:"file-name"},Rt={class:"file-size"},Dt={class:"list-name-cell"},zt=["src"],Lt={key:4,class:"empty"},Vt={__name:"FileList",props:{folderId:{type:Number,default:0}},emits:["preview"],setup(f,{expose:D,emit:U}){const O=f,k=U,F=Be(),M=B(!1),A=B([]),c=B([]),b=B({page:1,page_size:20,total:0}),w=B("grid"),d=B({visible:!1,x:0,y:0,target:null,type:""}),L=B({}),S=B([]),T=B(!1),j=me(()=>S.value.length>0&&S.value.length<c.value.length),h=B(!1),o=B(null),l=B([]),t=B([]);function e(s){return s.file_object||{}}function n(){for(const s of Object.values(L.value))URL.revokeObjectURL(s);L.value={}}async function a(s=c.value){n();const i=s.filter(y=>e(y).is_image);await Promise.all(i.map(async y=>{try{const E=await wt(y.id);L.value[y.id]=URL.createObjectURL(E)}catch{}}))}function P(s){return L.value[s]||""}const Y=me(()=>{const s=A.value.map(y=>({...y,_type:"folder"})),i=c.value.map(y=>{const E=e(y);return{...y,_type:"file",_isImage:E.is_image,_fileSize:E.file_size}});return[...s,...i]});function u({row:s}){return s._type==="file"&&_("file",s.id)?"selected-row":""}async function r(){var s,i;M.value=!0,S.value=[],T.value=!1;try{const[y,E]=await Promise.all([Se(O.folderId),ct({folder_id:O.folderId,page:b.value.page,page_size:b.value.page_size})]);A.value=y.data||[],c.value=((s=E.data)==null?void 0:s.files)||[],await a(c.value),(i=E.data)!=null&&i.pagination&&(b.value=E.data.pagination)}catch{}M.value=!1}function I(s){const i=[...F.breadcrumbs,{id:s.id,name:s.name}];F.setCurrentFolder(s.id,i)}function $(s){e(s).is_image&&k("preview",s)}function m(s){b.value.page=s,r()}function _(s,i){return S.value.some(y=>y.type===s&&y.id===i)}function K(s,i){const y=S.value.findIndex(E=>E.type===s&&E.id===i);y>=0?S.value.splice(y,1):S.value.push({type:s,id:i}),T.value=S.value.length===c.value.length}function V(s){s?S.value=c.value.map(i=>({type:"file",id:i.id})):S.value=[]}function G(s,i){d.value={visible:!0,x:s.clientX,y:s.clientY,target:i,type:"file"}}function Q(s,i){d.value={visible:!0,x:s.clientX,y:s.clientY,target:i,type:"folder"}}function ie(s,i,y){y.preventDefault(),s._type==="file"?G(y,s):Q(y,s)}function _e(s){s._type==="folder"?I(s):e(s).is_image&&k("preview",s)}async function he(){if(d.value.type==="file")try{const s=await bt(d.value.target.id),i=URL.createObjectURL(s),y=document.createElement("a");y.href=i,y.download=d.value.target.original_name,y.click(),URL.revokeObjectURL(i)}catch{W.error("下载失败")}d.value.visible=!1}async function ge(){const s=d.value.target,i=d.value.type,y=i==="file"?s.original_name:s.name;d.value.visible=!1;try{const{value:E}=await fe.prompt("输入新名称","重命名",{inputValue:y,inputValidator:ae=>ae&&ae.trim()?!0:"名称不能为空"});if(E.trim()===y)return;i==="file"?await _t(s.id,E.trim()):await lt(s.id,{name:E.trim()}),W.success("重命名成功"),r()}catch{}}async function z(){const s=d.value.target,i=d.value.type;d.value.visible=!1;try{await fe.confirm(`确定删除 ${i==="file"?s.original_name:s.name}？`,"确认删除"),i==="file"?await vt(s.id):await ot(s.id),W.success("已移到回收站"),r()}catch{}}async function ne(){const s=S.value.filter(i=>i.type==="file").map(i=>i.id);if(s.length)try{await fe.confirm(`确定删除选中的 ${s.length} 个文件？`,"批量删除"),await gt(s),W.success("已移到回收站"),r()}catch{}}async function re(){var i;const s=((i=F.userInfo)==null?void 0:i.root_folder_id)||0;try{const y=await Se(s);l.value=[{id:s,name:"根目录",children:y.data||[]}]}catch{l.value=[{id:s,name:"根目录",children:[]}]}}function Ce(){t.value=[d.value.target.id],d.value.visible=!1,o.value=null,re(),h.value=!0}function ue(){t.value=S.value.filter(s=>s.type==="file").map(s=>s.id),t.value.length&&(o.value=null,re(),h.value=!0)}function $e(s){o.value=s.id}async function oe(){if(o.value!==null)try{t.value.length===1?await ht(t.value[0],o.value):await yt(t.value,o.value),W.success("移动成功"),h.value=!1,r()}catch{W.error("移动失败")}}function ce(){d.value.visible=!1}function ye(s){if(!s)return"0 B";const i=["B","KB","MB","GB"],y=Math.floor(Math.log(s)/Math.log(1024));return(s/Math.pow(1024,y)).toFixed(1)+" "+i[y]}function Re(s){return s?new Date(s).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""}return pe(()=>O.folderId,()=>{b.value.page=1,r()},{immediate:!0}),Te(()=>document.addEventListener("click",ce)),je(()=>{document.removeEventListener("click",ce),n()}),D({loadFiles:r}),(s,i)=>{const y=x("el-checkbox"),E=x("el-button"),ae=x("el-icon"),De=x("el-button-group"),be=x("el-table-column"),ze=x("el-table"),Le=x("el-empty"),Ve=x("el-pagination"),Ne=x("el-tree"),Ee=x("el-dialog");return C(),R("div",$t,[!M.value&&(A.value.length>0||c.value.length>0||S.value.length>0)?(C(),R("div",kt,[N("div",Ut,[p(y,{modelValue:T.value,"onUpdate:modelValue":i[0]||(i[0]=g=>T.value=g),onChange:V,indeterminate:j.value},{default:v(()=>[...i[8]||(i[8]=[q("全选",-1)])]),_:1},8,["modelValue","indeterminate"]),S.value.length>0?(C(),R(de,{key:0},[p(E,{size:"small",type:"danger",onClick:ne},{default:v(()=>[q("删除 ("+X(S.value.length)+")",1)]),_:1}),p(E,{size:"small",onClick:ue},{default:v(()=>[q("移动 ("+X(S.value.length)+")",1)]),_:1})],64)):Z("",!0)]),N("div",St,[p(De,null,{default:v(()=>[p(E,{size:"small",type:w.value==="grid"?"primary":"",onClick:i[1]||(i[1]=g=>w.value="grid")},{default:v(()=>[p(ae,null,{default:v(()=>[p(J(Pe))]),_:1})]),_:1},8,["type"]),p(E,{size:"small",type:w.value==="list"?"primary":"",onClick:i[2]||(i[2]=g=>w.value="list")},{default:v(()=>[p(ae,null,{default:v(()=>[p(J(Ke))]),_:1})]),_:1},8,["type"])]),_:1})])])):Z("",!0),M.value?(C(),R("div",Ft,[p(ae,{class:"is-loading"},{default:v(()=>[p(J(He))]),_:1}),i[9]||(i[9]=q(" 加载中...",-1))])):Z("",!0),w.value==="grid"?(C(),R("div",Bt,[(C(!0),R(de,null,ve(A.value,g=>(C(),R("div",{key:"f-"+g.id,class:"file-item folder",onClick:le=>I(g),onContextmenu:te(le=>Q(le,g),["prevent"])},[p(ae,{size:48,color:"#f0c040"},{default:v(()=>[p(J(we))]),_:1}),N("span",xt,X(g.name),1)],40,At))),128)),(C(!0),R(de,null,ve(c.value,g=>(C(),R("div",{key:"file-"+g.id,class:Fe(["file-item",{selected:_("file",g.id)}]),onClick:[te(le=>$(g),["exact"]),te(le=>K("file",g.id),["ctrl"])],onContextmenu:te(le=>G(le,g),["prevent"])},[p(y,{class:"item-checkbox","model-value":_("file",g.id),onChange:le=>K("file",g.id),onClick:i[3]||(i[3]=te(()=>{},["stop"]))},null,8,["model-value","onChange"]),e(g).is_image?(C(),R("img",{key:0,src:P(g.id),class:"thumbnail",loading:"lazy"},null,8,Tt)):(C(),ee(ae,{key:1,size:48,color:"#909399"},{default:v(()=>[p(J(Ue))]),_:1})),N("span",It,X(g.original_name),1),N("span",Rt,X(ye(e(g).file_size)),1)],42,Mt))),128))])):Z("",!0),w.value==="list"&&!M.value?(C(),ee(ze,{key:3,data:Y.value,onRowContextmenu:ie,onRowClick:_e,style:{width:"100%"},"row-class-name":u},{default:v(()=>[p(be,{width:"40"},{header:v(()=>[p(y,{modelValue:T.value,"onUpdate:modelValue":i[4]||(i[4]=g=>T.value=g),onChange:V,indeterminate:j.value},null,8,["modelValue","indeterminate"])]),default:v(({row:g})=>[g._type==="file"?(C(),ee(y,{key:0,"model-value":_("file",g.id),onChange:le=>K("file",g.id),onClick:i[5]||(i[5]=te(()=>{},["stop"]))},null,8,["model-value","onChange"])):Z("",!0)]),_:1}),p(be,{label:"名称","min-width":"200"},{default:v(({row:g})=>[N("div",Dt,[g._type==="folder"?(C(),ee(ae,{key:0,size:20,color:"#f0c040"},{default:v(()=>[p(J(we))]),_:1})):g._isImage?(C(),R("img",{key:1,src:P(g.id),class:"list-thumb"},null,8,zt)):(C(),ee(ae,{key:2,size:20,color:"#909399"},{default:v(()=>[p(J(Ue))]),_:1})),N("span",null,X(g._type==="folder"?g.name:g.original_name),1)])]),_:1}),p(be,{label:"大小",width:"100"},{default:v(({row:g})=>[q(X(g._type==="file"?ye(g._fileSize):"-"),1)]),_:1}),p(be,{label:"修改时间",width:"170"},{default:v(({row:g})=>[q(X(Re(g.created_at||g.CreatedAt)),1)]),_:1})]),_:1},8,["data"])):Z("",!0),!M.value&&A.value.length===0&&c.value.length===0?(C(),R("div",Lt,[p(Le,{description:"暂无文件"})])):Z("",!0),b.value.total>b.value.page_size?(C(),ee(Ve,{key:5,"current-page":b.value.page,"page-size":b.value.page_size,total:b.value.total,layout:"prev, pager, next",onCurrentChange:m,class:"pagination"},null,8,["current-page","page-size","total"])):Z("",!0),d.value.visible?(C(),R("div",{key:6,class:"context-menu",style:Je({left:d.value.x+"px",top:d.value.y+"px"})},[d.value.type==="file"?(C(),R("div",{key:0,class:"menu-item",onClick:he},"下载")):Z("",!0),N("div",{class:"menu-item",onClick:ge},"重命名"),d.value.type==="file"?(C(),R("div",{key:1,class:"menu-item",onClick:Ce},"移动")):Z("",!0),N("div",{class:"menu-item menu-item-danger",onClick:z},"删除")],4)):Z("",!0),p(Ee,{modelValue:h.value,"onUpdate:modelValue":i[7]||(i[7]=g=>h.value=g),title:"移动到",width:"400px"},{footer:v(()=>[p(E,{onClick:i[6]||(i[6]=g=>h.value=!1)},{default:v(()=>[...i[10]||(i[10]=[q("取消",-1)])]),_:1}),p(E,{type:"primary",onClick:oe,disabled:o.value===null},{default:v(()=>[...i[11]||(i[11]=[q("确定",-1)])]),_:1},8,["disabled"])]),default:v(()=>[p(Ne,{data:l.value,props:{label:"name",children:"children"},"node-key":"id","highlight-current":"",onNodeClick:$e},null,8,["data"])]),_:1},8,["modelValue"])])}}},Nt=se(Vt,[["__scopeId","data-v-cc9565cc"]]);var Ie={exports:{}};(function(f,D){(function(U){f.exports=U()})(function(U){var O=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function k(o,l){var t=o[0],e=o[1],n=o[2],a=o[3];t+=(e&n|~e&a)+l[0]-680876936|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+l[1]-389564586|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+l[2]+606105819|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+l[3]-1044525330|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+l[4]-176418897|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+l[5]+1200080426|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+l[6]-1473231341|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+l[7]-45705983|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+l[8]+1770035416|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+l[9]-1958414417|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+l[10]-42063|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+l[11]-1990404162|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+l[12]+1804603682|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+l[13]-40341101|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+l[14]-1502002290|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+l[15]+1236535329|0,e=(e<<22|e>>>10)+n|0,t+=(e&a|n&~a)+l[1]-165796510|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+l[6]-1069501632|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+l[11]+643717713|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+l[0]-373897302|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+l[5]-701558691|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+l[10]+38016083|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+l[15]-660478335|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+l[4]-405537848|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+l[9]+568446438|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+l[14]-1019803690|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+l[3]-187363961|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+l[8]+1163531501|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+l[13]-1444681467|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+l[2]-51403784|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+l[7]+1735328473|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+l[12]-1926607734|0,e=(e<<20|e>>>12)+n|0,t+=(e^n^a)+l[5]-378558|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+l[8]-2022574463|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+l[11]+1839030562|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+l[14]-35309556|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+l[1]-1530992060|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+l[4]+1272893353|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+l[7]-155497632|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+l[10]-1094730640|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+l[13]+681279174|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+l[0]-358537222|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+l[3]-722521979|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+l[6]+76029189|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+l[9]-640364487|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+l[12]-421815835|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+l[15]+530742520|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+l[2]-995338651|0,e=(e<<23|e>>>9)+n|0,t+=(n^(e|~a))+l[0]-198630844|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+l[7]+1126891415|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+l[14]-1416354905|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+l[5]-57434055|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+l[12]+1700485571|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+l[3]-1894986606|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+l[10]-1051523|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+l[1]-2054922799|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+l[8]+1873313359|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+l[15]-30611744|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+l[6]-1560198380|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+l[13]+1309151649|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+l[4]-145523070|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+l[11]-1120210379|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+l[2]+718787259|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+l[9]-343485551|0,e=(e<<21|e>>>11)+n|0,o[0]=t+o[0]|0,o[1]=e+o[1]|0,o[2]=n+o[2]|0,o[3]=a+o[3]|0}function F(o){var l=[],t;for(t=0;t<64;t+=4)l[t>>2]=o.charCodeAt(t)+(o.charCodeAt(t+1)<<8)+(o.charCodeAt(t+2)<<16)+(o.charCodeAt(t+3)<<24);return l}function M(o){var l=[],t;for(t=0;t<64;t+=4)l[t>>2]=o[t]+(o[t+1]<<8)+(o[t+2]<<16)+(o[t+3]<<24);return l}function A(o){var l=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,n,a,P,Y,u;for(e=64;e<=l;e+=64)k(t,F(o.substring(e-64,e)));for(o=o.substring(e-64),n=o.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)a[e>>2]|=o.charCodeAt(e)<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(k(t,a),e=0;e<16;e+=1)a[e]=0;return P=l*8,P=P.toString(16).match(/(.*?)(.{0,8})$/),Y=parseInt(P[2],16),u=parseInt(P[1],16)||0,a[14]=Y,a[15]=u,k(t,a),t}function c(o){var l=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,n,a,P,Y,u;for(e=64;e<=l;e+=64)k(t,M(o.subarray(e-64,e)));for(o=e-64<l?o.subarray(e-64):new Uint8Array(0),n=o.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)a[e>>2]|=o[e]<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(k(t,a),e=0;e<16;e+=1)a[e]=0;return P=l*8,P=P.toString(16).match(/(.*?)(.{0,8})$/),Y=parseInt(P[2],16),u=parseInt(P[1],16)||0,a[14]=Y,a[15]=u,k(t,a),t}function b(o){var l="",t;for(t=0;t<4;t+=1)l+=O[o>>t*8+4&15]+O[o>>t*8&15];return l}function w(o){var l;for(l=0;l<o.length;l+=1)o[l]=b(o[l]);return o.join("")}w(A("hello")),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function o(l,t){return l=l|0||0,l<0?Math.max(l+t,0):Math.min(l,t)}ArrayBuffer.prototype.slice=function(l,t){var e=this.byteLength,n=o(l,e),a=e,P,Y,u,r;return t!==U&&(a=o(t,e)),n>a?new ArrayBuffer(0):(P=a-n,Y=new ArrayBuffer(P),u=new Uint8Array(Y),r=new Uint8Array(this,n,P),u.set(r),Y)}}();function d(o){return/[\u0080-\uFFFF]/.test(o)&&(o=unescape(encodeURIComponent(o))),o}function L(o,l){var t=o.length,e=new ArrayBuffer(t),n=new Uint8Array(e),a;for(a=0;a<t;a+=1)n[a]=o.charCodeAt(a);return l?n:e}function S(o){return String.fromCharCode.apply(null,new Uint8Array(o))}function T(o,l,t){var e=new Uint8Array(o.byteLength+l.byteLength);return e.set(new Uint8Array(o)),e.set(new Uint8Array(l),o.byteLength),e}function j(o){var l=[],t=o.length,e;for(e=0;e<t-1;e+=2)l.push(parseInt(o.substr(e,2),16));return String.fromCharCode.apply(String,l)}function h(){this.reset()}return h.prototype.append=function(o){return this.appendBinary(d(o)),this},h.prototype.appendBinary=function(o){this._buff+=o,this._length+=o.length;var l=this._buff.length,t;for(t=64;t<=l;t+=64)k(this._hash,F(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},h.prototype.end=function(o){var l=this._buff,t=l.length,e,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a;for(e=0;e<t;e+=1)n[e>>2]|=l.charCodeAt(e)<<(e%4<<3);return this._finish(n,t),a=w(this._hash),o&&(a=j(a)),this.reset(),a},h.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},h.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},h.prototype.setState=function(o){return this._buff=o.buff,this._length=o.length,this._hash=o.hash,this},h.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},h.prototype._finish=function(o,l){var t=l,e,n,a;if(o[t>>2]|=128<<(t%4<<3),t>55)for(k(this._hash,o),t=0;t<16;t+=1)o[t]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(e[2],16),a=parseInt(e[1],16)||0,o[14]=n,o[15]=a,k(this._hash,o)},h.hash=function(o,l){return h.hashBinary(d(o),l)},h.hashBinary=function(o,l){var t=A(o),e=w(t);return l?j(e):e},h.ArrayBuffer=function(){this.reset()},h.ArrayBuffer.prototype.append=function(o){var l=T(this._buff.buffer,o),t=l.length,e;for(this._length+=o.byteLength,e=64;e<=t;e+=64)k(this._hash,M(l.subarray(e-64,e)));return this._buff=e-64<t?new Uint8Array(l.buffer.slice(e-64)):new Uint8Array(0),this},h.ArrayBuffer.prototype.end=function(o){var l=this._buff,t=l.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n,a;for(n=0;n<t;n+=1)e[n>>2]|=l[n]<<(n%4<<3);return this._finish(e,t),a=w(this._hash),o&&(a=j(a)),this.reset(),a},h.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},h.ArrayBuffer.prototype.getState=function(){var o=h.prototype.getState.call(this);return o.buff=S(o.buff),o},h.ArrayBuffer.prototype.setState=function(o){return o.buff=L(o.buff,!0),h.prototype.setState.call(this,o)},h.ArrayBuffer.prototype.destroy=h.prototype.destroy,h.ArrayBuffer.prototype._finish=h.prototype._finish,h.ArrayBuffer.hash=function(o,l){var t=c(new Uint8Array(o)),e=w(t);return l?j(e):e},h})})(Ie);var Et=Ie.exports;const Ot=qe(Et),jt={key:0,class:"drag-overlay"},Pt={class:"upload-name"},Kt={class:"upload-status-text"},Me=5*1024*1024,Ht=5*1024*1024,ke=3,Jt=1e3,qt={__name:"FileUpload",props:{folderId:{type:Number,default:0}},emits:["uploaded"],setup(f,{expose:D,emit:U}){const O=f,k=U,F=B(null),M=B(null),A=B(!1),c=B([]),b=B(!1);function w(){var u;(u=F.value)==null||u.click()}function d(){b.value=!0}function L(){b.value=!1}function S(u){b.value=!1;const r=Array.from(u.dataTransfer.files);r.length&&j(r)}function T(u){const r=Array.from(u.target.files);r.length&&j(r),F.value.value=""}async function j(u){var I,$;A.value=!0;const r=c.value.length;c.value.push(...u.map(m=>({name:m.name,progress:0,status:"",statusText:"等待中..."})));for(let m=0;m<u.length;m++){const _=r+m,K=u[m];try{K.size>Ht?await o(K,_):await h(K,_),c.value[_].status="done",c.value[_].progress=100,c.value[_].statusText="上传完成"}catch(V){c.value[_].status="error";const G=(($=(I=V==null?void 0:V.response)==null?void 0:I.data)==null?void 0:$.message)||(V==null?void 0:V.message)||"上传失败";c.value[_].statusText=G,W.error(`${K.name}: ${G}`)}}k("uploaded")}async function h(u,r){c.value[r].statusText="上传中...";const I=new FormData;I.append("file",u),I.append("folder_id",O.folderId),await dt(I,$=>{$.total&&(c.value[r].progress=Math.round($.loaded/$.total*100))})}async function o(u,r){var Q,ie,_e,he,ge;c.value[r].statusText="计算文件指纹...";const I=await l(u,z=>{c.value[r].progress=Math.round(z*20)});let $="",m=0,_=Me,K=new Set;const V=e(u.name,u.size,I);if(V){c.value[r].statusText="检测到断点，校验任务状态...";try{$=V.uploadId,m=V.totalChunks;const z=await xe($);if(Number.isInteger((Q=z.data)==null?void 0:Q.total_chunks)&&z.data.total_chunks>0&&(m=z.data.total_chunks),((ie=z.data)==null?void 0:ie.status)==="completed"){Y($),c.value[r].statusText="上传已完成",c.value[r].progress=100;return}(_e=z.data)!=null&&_e.uploaded_chunks&&z.data.uploaded_chunks.forEach(ne=>K.add(ne))}catch{Y($),$="",m=0,K=new Set}}if(!$){c.value[r].statusText="检查秒传...";const z=await ft({file_name:u.name,file_size:u.size,file_md5:I,folder_id:O.folderId});if(((he=z.data)==null?void 0:he.status)==="instant_upload"){c.value[r].statusText="秒传完成",c.value[r].progress=100;return}$=z.data.upload_id,m=z.data.total_chunks,_=z.data.chunk_size||Me,t($,u.name,u.size,I,m);try{const ne=await xe($);(ge=ne.data)!=null&&ge.uploaded_chunks&&ne.data.uploaded_chunks.forEach(re=>K.add(re))}catch{K=new Set}}let G=K.size;c.value[r].statusText="分片上传中...";for(let z=0;z<m;z++){if(K.has(z))continue;const ne=z*_,re=Math.min(ne+_,u.size),Ce=u.slice(ne,re),ue=new FormData;ue.append("upload_id",$),ue.append("chunk_index",z),ue.append("chunk",Ce),c.value[r].statusText=`分片上传中... (${z+1}/${m})`,await P(ue,$,z,oe=>{if(!oe.total||m<=0)return;const ce=oe.loaded/oe.total,ye=(G+ce)/m;c.value[r].progress=Math.round(20+ye*70)},(oe,ce)=>{c.value[r].statusText=`网络波动，重试分片... (${z+1}/${m}, ${oe}/${ce})`}),G++,c.value[r].statusText=`分片上传中... (${Math.min(z+1,m)}/${m})`;const $e=G/m*70;c.value[r].progress=Math.round(20+$e)}c.value[r].statusText="合并文件...",c.value[r].progress=90,await mt({upload_id:$}),c.value[r].progress=100,Y($)}function l(u,r){return new Promise((I,$)=>{const m=new Ot.ArrayBuffer,_=new FileReader,K=Math.ceil(u.size/(2*1024*1024));let V=0;_.onload=Q=>{m.append(Q.target.result),V++,r&&r(V/K),V<K?G():I(m.end())},_.onerror=()=>$(new Error("MD5计算失败"));function G(){const Q=V*2*1024*1024,ie=Math.min(Q+2*1024*1024,u.size);_.readAsArrayBuffer(u.slice(Q,ie))}G()})}function t(u,r,I,$,m){const _=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");_[u]={fileName:r,fileSize:I,md5:$,totalChunks:m,savedAt:Date.now()},localStorage.setItem("mcloud_upload_tasks",JSON.stringify(_))}function e(u,r,I){const $=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");for(const[m,_]of Object.entries($))if(_.fileName===u&&_.fileSize===r&&_.md5===I)return{uploadId:m,totalChunks:_.totalChunks};return null}function n(u){return(u==null?void 0:u.code)==="ECONNABORTED"?!0:String((u==null?void 0:u.message)||"").toLowerCase().includes("timeout")}function a(u){return new Promise(r=>setTimeout(r,u))}async function P(u,r,I,$,m){let _=null;const K=ke+1;for(let V=0;V<=ke;V++)try{await pt(u,$);return}catch(G){_=G;const Q=n(G)?" timeout":"";if(console.warn(`[upload] chunk failed${Q}: upload_id=${r}, chunk=${I}, attempt=${V+1}`,G),V===ke)break;m&&m(V+2,K,G),await a(Jt*(V+1))}throw _}function Y(u){const r=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");delete r[u],localStorage.setItem("mcloud_upload_tasks",JSON.stringify(r))}return Te(()=>{const u=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}"),r=Date.now();let I=!1;for(const[m,_]of Object.entries(u))r-_.savedAt>24*60*60*1e3&&(delete u[m],I=!0);I&&localStorage.setItem("mcloud_upload_tasks",JSON.stringify(u));const $=Object.keys(u).length;$>0&&W.info(`检测到 ${$} 个未完成上传任务，请重新选择对应文件继续上传`)}),D({triggerUpload:w}),(u,r)=>{const I=x("el-progress"),$=x("el-button"),m=x("el-dialog");return C(),R("div",{ref_key:"dropZone",ref:M,class:Fe(["upload-wrapper",{"drag-over":b.value}]),onDragover:te(d,["prevent"]),onDragleave:te(L,["prevent"]),onDrop:te(S,["prevent"])},[N("input",{ref_key:"fileInput",ref:F,type:"file",multiple:"",hidden:"",onChange:T},null,544),b.value?(C(),R("div",jt,"释放文件以上传")):Z("",!0),p(m,{modelValue:A.value,"onUpdate:modelValue":r[1]||(r[1]=_=>A.value=_),title:"上传文件","close-on-click-modal":!1,width:"500px"},{footer:v(()=>[p($,{onClick:r[0]||(r[0]=_=>A.value=!1)},{default:v(()=>[...r[2]||(r[2]=[q("关闭",-1)])]),_:1})]),default:v(()=>[(C(!0),R(de,null,ve(c.value,(_,K)=>(C(),R("div",{key:K,class:"upload-item"},[N("div",Pt,X(_.name),1),N("div",Kt,X(_.statusText),1),p(I,{percentage:_.progress,status:_.status==="error"?"exception":_.status==="done"?"success":""},null,8,["percentage","status"])]))),128))]),_:1},8,["modelValue"])],34)}}},Yt=se(qt,[["__scopeId","data-v-3b732c9b"]]),Gt=["src"],Xt={__name:"ImagePreview",props:{visible:{type:Boolean,default:!1},file:{type:Object,default:null}},emits:["update:visible"],setup(f,{emit:D}){const U=f,O=D,k=B(""),F=me({get:()=>U.visible,set:c=>O("update:visible",c)});function M(){k.value&&(URL.revokeObjectURL(k.value),k.value="")}async function A(){if(M(),!!U.file)try{const c=await Ct(U.file.id);k.value=URL.createObjectURL(c)}catch{k.value=""}}return pe(()=>{var c;return[U.visible,(c=U.file)==null?void 0:c.id]},([c])=>{c?A():M()},{immediate:!0}),Ye(()=>{M()}),(c,b)=>{var d;const w=x("el-dialog");return C(),ee(w,{modelValue:F.value,"onUpdate:modelValue":b[2]||(b[2]=L=>F.value=L),title:(d=f.file)==null?void 0:d.original_name,fullscreen:"","append-to-body":""},{default:v(()=>[N("div",{class:"preview-container",onClick:b[1]||(b[1]=L=>F.value=!1)},[k.value?(C(),R("img",{key:0,src:k.value,class:"preview-image",onClick:b[0]||(b[0]=te(()=>{},["stop"]))},null,8,Gt)):Z("",!0)])]),_:1},8,["modelValue","title"])}}},Zt=se(Xt,[["__scopeId","data-v-f463ea88"]]),Wt=["onClick"],Qt={key:1},en={__name:"Breadcrumb",props:{items:{type:Array,default:()=>[]}},emits:["navigate"],setup(f,{emit:D}){const U=f,O=D;function k(F,M){const A=U.items.slice(0,M+1);O("navigate",{id:F.id,breadcrumbs:A})}return(F,M)=>{const A=x("el-breadcrumb-item"),c=x("el-breadcrumb");return C(),ee(c,{separator:"/"},{default:v(()=>[(C(!0),R(de,null,ve(f.items,(b,w)=>(C(),ee(A,{key:b.id},{default:v(()=>[w<f.items.length-1?(C(),R("a",{key:0,href:"#",onClick:te(d=>k(b,w),["prevent"])},X(b.name),9,Wt)):(C(),R("span",Qt,X(b.name),1))]),_:2},1024))),128))]),_:1})}}},tn=se(en,[["__scopeId","data-v-7d4131d2"]]);function nn(f){return H.get("/recycle-bin",{params:f})}function an(f){return H.post(`/recycle-bin/${f}/restore`)}function ln(f){return H.delete(`/recycle-bin/${f}`)}function on(){return H.post("/recycle-bin/empty")}const sn={key:0,class:"empty"},rn={class:"item-info"},un={class:"item-actions"},cn={__name:"RecycleBin",props:{visible:{type:Boolean,default:!1}},emits:["update:visible","restored"],setup(f,{emit:D}){const U=f,O=D,k=me({get:()=>U.visible,set:w=>O("update:visible",w)}),F=B([]);async function M(){var w;try{const d=await nn({page:1,page_size:50});F.value=((w=d.data)==null?void 0:w.items)||[]}catch{}}async function A(w){try{await an(w),W.success("恢复成功"),M(),O("restored")}catch{}}async function c(w){try{await fe.confirm("永久删除后无法恢复，确定？","确认"),await ln(w),W.success("已永久删除"),M()}catch{}}async function b(){try{await fe.confirm("确定清空回收站？此操作不可恢复","确认"),await on(),W.success("回收站已清空"),F.value=[]}catch{}}return pe(()=>U.visible,w=>{w&&M()}),(w,d)=>{const L=x("el-empty"),S=x("el-icon"),T=x("el-button"),j=x("el-drawer");return C(),ee(j,{modelValue:k.value,"onUpdate:modelValue":d[0]||(d[0]=h=>k.value=h),title:"回收站",size:"400px"},{footer:v(()=>[p(T,{type:"danger",onClick:b,disabled:F.value.length===0},{default:v(()=>[...d[3]||(d[3]=[q("清空回收站",-1)])]),_:1},8,["disabled"])]),default:v(()=>[F.value.length===0?(C(),R("div",sn,[p(L,{description:"回收站为空"})])):Z("",!0),(C(!0),R(de,null,ve(F.value,h=>(C(),R("div",{key:h.id,class:"recycle-item"},[N("div",rn,[p(S,null,{default:v(()=>[h.original_type==="file"?(C(),ee(J(Ue),{key:0})):(C(),ee(J(we),{key:1}))]),_:2},1024),N("span",null,X(h.original_name),1)]),N("div",un,[p(T,{size:"small",type:"primary",text:"",onClick:o=>A(h.id)},{default:v(()=>[...d[1]||(d[1]=[q("恢复",-1)])]),_:1},8,["onClick"]),p(T,{size:"small",type:"danger",text:"",onClick:o=>c(h.id)},{default:v(()=>[...d[2]||(d[2]=[q("删除",-1)])]),_:1},8,["onClick"])])]))),128))]),_:1},8,["modelValue"])}}},dn=se(cn,[["__scopeId","data-v-70c3eeda"]]),fn={class:"home-container"},pn={class:"header-left"},mn={class:"header-right"},vn={class:"user-info"},_n={class:"main-content"},hn={class:"content"},gn={__name:"Home",setup(f){const D=Ge(),U=Be(),O=B(null),k=B(null),F=B(!0),M=B(!1),A=B(null),c=B(!1),b=B(!1),w=B("");async function d(){try{const e=await nt();U.setUser(e.data),U.resetToRoot()}catch{D.push("/login")}}d();function L(e){U.setCurrentFolder(e.id,e.breadcrumbs)}function S(e){U.setCurrentFolder(e.id,e.breadcrumbs)}function T(e){A.value=e,M.value=!0}function j(){var e;(e=O.value)==null||e.loadFiles()}function h(){w.value="",b.value=!0}async function o(){if(!w.value.trim()){W.warning("请输入文件夹名称");return}try{await at({name:w.value.trim(),parent_id:U.currentFolderID}),W.success("文件夹创建成功"),b.value=!1,j()}catch{}}function l(e){var n,a;e==="logout"?fe.confirm("确定退出登录？","提示").then(()=>{tt(),U.clearUser(),D.push("/login")}).catch(()=>{}):e==="quota"&&W.info(`已用 ${t((n=U.userInfo)==null?void 0:n.storage_used)} / ${t((a=U.userInfo)==null?void 0:a.storage_quota)}`)}function t(e){if(!e)return"0 B";const n=["B","KB","MB","GB","TB"],a=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,a)).toFixed(1)+" "+n[a]}return(e,n)=>{const a=x("el-button"),P=x("el-dropdown-item"),Y=x("el-dropdown-menu"),u=x("el-dropdown"),r=x("el-header"),I=x("el-input"),$=x("el-dialog");return C(),R("div",fn,[p(r,{class:"header"},{default:v(()=>[N("div",pn,[p(a,{class:"menu-btn",icon:J(Xe),onClick:n[0]||(n[0]=m=>F.value=!F.value)},null,8,["icon"]),n[8]||(n[8]=N("h3",null,"mCloud",-1))]),N("div",mn,[p(a,{type:"primary",icon:J(Ze),onClick:n[1]||(n[1]=m=>{var _;return(_=k.value)==null?void 0:_.triggerUpload()})},{default:v(()=>[...n[9]||(n[9]=[q("上传",-1)])]),_:1},8,["icon"]),p(a,{icon:J(We),onClick:h},{default:v(()=>[...n[10]||(n[10]=[q("新建文件夹",-1)])]),_:1},8,["icon"]),p(a,{icon:J(Qe),onClick:n[2]||(n[2]=m=>c.value=!0)},{default:v(()=>[...n[11]||(n[11]=[q("回收站",-1)])]),_:1},8,["icon"]),p(u,{onCommand:l},{dropdown:v(()=>[p(Y,null,{default:v(()=>[p(P,{command:"quota"},{default:v(()=>[...n[12]||(n[12]=[q("存储空间",-1)])]),_:1}),p(P,{command:"logout",divided:""},{default:v(()=>[...n[13]||(n[13]=[q("退出登录",-1)])]),_:1})]),_:1})]),default:v(()=>{var m,_;return[N("span",vn,X(((m=J(U).userInfo)==null?void 0:m.nickname)||((_=J(U).userInfo)==null?void 0:_.username)),1)]}),_:1})])]),_:1}),N("div",_n,[N("aside",{class:Fe(["sidebar",{visible:F.value}])},[p(ut,{onSelect:L})],2),N("main",hn,[p(tn,{items:J(U).breadcrumbs,onNavigate:S},null,8,["items"]),p(Nt,{"folder-id":J(U).currentFolderID,ref_key:"fileListRef",ref:O,onPreview:T},null,8,["folder-id"])])]),p(Yt,{ref_key:"uploadRef",ref:k,"folder-id":J(U).currentFolderID,onUploaded:j},null,8,["folder-id"]),p(Zt,{visible:M.value,"onUpdate:visible":n[3]||(n[3]=m=>M.value=m),file:A.value},null,8,["visible","file"]),p(dn,{visible:c.value,"onUpdate:visible":n[4]||(n[4]=m=>c.value=m),onRestored:j},null,8,["visible"]),p($,{modelValue:b.value,"onUpdate:modelValue":n[7]||(n[7]=m=>b.value=m),title:"新建文件夹",width:"400px"},{footer:v(()=>[p(a,{onClick:n[6]||(n[6]=m=>b.value=!1)},{default:v(()=>[...n[14]||(n[14]=[q("取消",-1)])]),_:1}),p(a,{type:"primary",onClick:o},{default:v(()=>[...n[15]||(n[15]=[q("创建",-1)])]),_:1})]),default:v(()=>[p(I,{modelValue:w.value,"onUpdate:modelValue":n[5]||(n[5]=m=>w.value=m),placeholder:"请输入文件夹名称",onKeyup:et(o,["enter"])},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}},wn=se(gn,[["__scopeId","data-v-c8ef7c20"]]);export{wn as default};
