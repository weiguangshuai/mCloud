import{i as fe,r as x,o as C,c as M,a as p,w as v,b as L,j as J,k as we,t as G,h as B,l as pe,n as Ee,m as Re,p as je,f as q,F as ue,q as X,v as Pe,x as Ke,y as He,z as me,A as Q,d as ee,B as Ue,C as Je,D as de,E as Z,G as Se,H as qe,I as Ye,u as Ge,J as Xe,K as Ze,L as We,M as Qe,e as et,N as tt}from"./index-DtofCPvg.js";import{a as K,_ as oe,u as Fe,g as nt}from"./_plugin-vue_export-helper-Dn21ojkh.js";function $e(f=0){return K.get("/folders",{params:{parent_id:f}})}function at(f){return K.post("/folders",f)}function lt(f,D){return K.put(`/folders/${f}`,D)}function ot(f){return K.delete(`/folders/${f}`)}const it={class:"folder-tree"},st={class:"node-content"},rt={__name:"FolderTree",emits:["select"],setup(f,{emit:D}){const $=D,E=Fe(),U=B(null),F=B([]),I={label:"name",children:"children",isLeaf:"isLeaf"},A=pe(()=>{var c;return((c=E.userInfo)==null?void 0:c.root_folder_id)||0});function d(){return[{id:A.value,name:"全部文件",isRoot:!0,isLeaf:!1}]}async function b(c,z){if(c.level===0){z(F.value);return}try{const R=((await $e(c.data.id)).data||[]).map(j=>({id:j.id,name:j.name,isLeaf:!1}));z(R)}catch{z([])}}function w(c,z){const S=[];let R=z;for(;R&&R.level>0;){const j=R.level===1?"根目录":R.data.name;S.unshift({id:R.data.id,name:j}),R=R.parent}S.length===0&&S.push({id:A.value,name:"根目录"}),$("select",{id:c.id,breadcrumbs:S})}return fe(()=>A.value,async()=>{var c;F.value=d(),await Ee(),(c=U.value)==null||c.setCurrentKey(E.currentFolderID||A.value)},{immediate:!0}),fe(()=>E.currentFolderID,c=>{var z;(z=U.value)==null||z.setCurrentKey(c)}),(c,z)=>{const S=x("el-icon"),R=x("el-tree");return C(),M("div",it,[p(R,{ref_key:"treeRef",ref:U,data:F.value,props:I,"node-key":"id",lazy:"",load:b,"highlight-current":"","expand-on-click-node":!1,onNodeClick:w},{default:v(({data:j})=>[L("div",st,[p(S,null,{default:v(()=>[p(J(we))]),_:1}),L("span",null,G(j.name),1)])]),_:1},8,["data"])])}}},ut=oe(rt,[["__scopeId","data-v-c92c9de3"]]),Be=10*60*1e3;function dt(f){return K.get("/files",{params:f})}function ct(f,D){return K.post("/files/upload",f,{headers:{"Content-Type":"multipart/form-data"},timeout:Be,onUploadProgress:D})}function ft(f){return K.post("/files/upload/init",f)}function pt(f,D){return K.post("/files/upload/chunk",f,{headers:{"Content-Type":"multipart/form-data"},timeout:Be,onUploadProgress:D})}function mt(f){return K.post("/files/upload/complete",f,{timeout:Be})}function Ae(f){return K.get(`/files/upload/status/${f}`)}function vt(f){return K.delete(`/files/${f}`)}function _t(f,D){return K.put(`/files/${f}/rename`,{name:D})}function ht(f,D){return K.put(`/files/${f}/move`,{folder_id:D})}function gt(f){return K.post("/files/batch/delete",{file_ids:f})}function yt(f,D){return K.post("/files/batch/move",{file_ids:f,folder_id:D})}function bt(f){return K.get(`/files/${f}/download`,{responseType:"blob"})}function wt(f){return K.get(`/files/${f}/thumbnail`,{responseType:"blob"})}function Ct(f){return K.get(`/files/${f}/preview`,{responseType:"blob"})}const kt={class:"file-list-container"},Ut={key:0,class:"toolbar"},$t={class:"toolbar-left"},St={class:"toolbar-right"},Ft={key:1,class:"loading"},Bt={key:2,class:"grid-view"},At=["onClick","onContextmenu"],xt={class:"file-name"},It=["onClick","onContextmenu"],Rt=["src"],Tt={class:"file-name"},Mt={class:"file-size"},Dt={class:"list-name-cell"},zt=["src"],Lt={key:4,class:"empty"},Vt={__name:"FileList",props:{folderId:{type:Number,default:0}},emits:["preview"],setup(f,{expose:D,emit:$}){const E=f,U=$,F=Fe(),I=B(!1),A=B([]),d=B([]),b=B({page:1,page_size:20,total:0}),w=B("grid"),c=B({visible:!1,x:0,y:0,target:null,type:""}),z=B({}),S=B([]),R=B(!1),j=pe(()=>S.value.length>0&&S.value.length<d.value.length),h=B(!1),o=B(null),l=B([]),t=B([]);function e(i){return i.file_object||{}}function n(){for(const i of Object.values(z.value))URL.revokeObjectURL(i);z.value={}}async function a(i=d.value){n();const s=i.filter(y=>e(y).is_image);await Promise.all(s.map(async y=>{try{const O=await wt(y.id);z.value[y.id]=URL.createObjectURL(O)}catch{}}))}function P(i){return z.value[i]||""}const Y=pe(()=>{const i=A.value.map(y=>({...y,_type:"folder"})),s=d.value.map(y=>{const O=e(y);return{...y,_type:"file",_isImage:O.is_image,_fileSize:O.file_size}});return[...i,...s]});function u({row:i}){return i._type==="file"&&m("file",i.id)?"selected-row":""}async function r(){var i,s;I.value=!0,S.value=[],R.value=!1;try{const[y,O]=await Promise.all([$e(E.folderId),dt({folder_id:E.folderId,page:b.value.page,page_size:b.value.page_size})]);A.value=y.data||[],d.value=((i=O.data)==null?void 0:i.files)||[],await a(d.value),(s=O.data)!=null&&s.pagination&&(b.value=O.data.pagination)}catch{}I.value=!1}function T(i){const s=[...F.breadcrumbs,{id:i.id,name:i.name}];F.setCurrentFolder(i.id,s)}function k(i){e(i).is_image&&U("preview",i)}function _(i){b.value.page=i,r()}function m(i,s){return S.value.some(y=>y.type===i&&y.id===s)}function V(i,s){const y=S.value.findIndex(O=>O.type===i&&O.id===s);y>=0?S.value.splice(y,1):S.value.push({type:i,id:s}),R.value=S.value.length===d.value.length}function H(i){i?S.value=d.value.map(s=>({type:"file",id:s.id})):S.value=[]}function W(i,s){c.value={visible:!0,x:i.clientX,y:i.clientY,target:s,type:"file"}}function te(i,s){c.value={visible:!0,x:i.clientX,y:i.clientY,target:s,type:"folder"}}function ie(i,s,y){y.preventDefault(),i._type==="file"?W(y,i):te(y,i)}function ve(i){i._type==="folder"?T(i):e(i).is_image&&U("preview",i)}async function _e(){if(c.value.type==="file")try{const i=await bt(c.value.target.id),s=URL.createObjectURL(i),y=document.createElement("a");y.href=s,y.download=c.value.target.original_name,y.click(),URL.revokeObjectURL(s)}catch{Z.error("下载失败")}c.value.visible=!1}async function he(){const i=c.value.target,s=c.value.type,y=s==="file"?i.original_name:i.name;c.value.visible=!1;try{const{value:O}=await de.prompt("输入新名称","重命名",{inputValue:y,inputValidator:ae=>ae&&ae.trim()?!0:"名称不能为空"});if(O.trim()===y)return;s==="file"?await _t(i.id,O.trim()):await lt(i.id,{name:O.trim()}),Z.success("重命名成功"),r()}catch{}}async function N(){const i=c.value.target,s=c.value.type;c.value.visible=!1;try{await de.confirm(`确定删除 ${s==="file"?i.original_name:i.name}？`,"确认删除"),s==="file"?await vt(i.id):await ot(i.id),Z.success("已移到回收站"),r()}catch{}}async function ne(){const i=S.value.filter(s=>s.type==="file").map(s=>s.id);if(i.length)try{await de.confirm(`确定删除选中的 ${i.length} 个文件？`,"批量删除"),await gt(i),Z.success("已移到回收站"),r()}catch{}}async function se(){var s;const i=((s=F.userInfo)==null?void 0:s.root_folder_id)||0;try{const y=await $e(i);l.value=[{id:i,name:"根目录",children:y.data||[]}]}catch{l.value=[{id:i,name:"根目录",children:[]}]}}function Ce(){t.value=[c.value.target.id],c.value.visible=!1,o.value=null,se(),h.value=!0}function re(){t.value=S.value.filter(i=>i.type==="file").map(i=>i.id),t.value.length&&(o.value=null,se(),h.value=!0)}function ke(i){o.value=i.id}async function ce(){if(o.value!==null)try{t.value.length===1?await ht(t.value[0],o.value):await yt(t.value,o.value),Z.success("移动成功"),h.value=!1,r()}catch{Z.error("移动失败")}}function ge(){c.value.visible=!1}function ye(i){if(!i)return"0 B";const s=["B","KB","MB","GB"],y=Math.floor(Math.log(i)/Math.log(1024));return(i/Math.pow(1024,y)).toFixed(1)+" "+s[y]}function Me(i){return i?new Date(i).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""}return fe(()=>E.folderId,()=>{b.value.page=1,r()},{immediate:!0}),Re(()=>document.addEventListener("click",ge)),je(()=>{document.removeEventListener("click",ge),n()}),D({loadFiles:r}),(i,s)=>{const y=x("el-checkbox"),O=x("el-button"),ae=x("el-icon"),De=x("el-button-group"),be=x("el-table-column"),ze=x("el-table"),Le=x("el-empty"),Ve=x("el-pagination"),Ne=x("el-tree"),Oe=x("el-dialog");return C(),M("div",kt,[!I.value&&(A.value.length>0||d.value.length>0||S.value.length>0)?(C(),M("div",Ut,[L("div",$t,[p(y,{modelValue:R.value,"onUpdate:modelValue":s[0]||(s[0]=g=>R.value=g),onChange:H,indeterminate:j.value},{default:v(()=>[...s[8]||(s[8]=[q("全选",-1)])]),_:1},8,["modelValue","indeterminate"]),S.value.length>0?(C(),M(ue,{key:0},[p(O,{size:"small",type:"danger",onClick:ne},{default:v(()=>[q("删除 ("+G(S.value.length)+")",1)]),_:1}),p(O,{size:"small",onClick:re},{default:v(()=>[q("移动 ("+G(S.value.length)+")",1)]),_:1})],64)):X("",!0)]),L("div",St,[p(De,null,{default:v(()=>[p(O,{size:"small",type:w.value==="grid"?"primary":"",onClick:s[1]||(s[1]=g=>w.value="grid")},{default:v(()=>[p(ae,null,{default:v(()=>[p(J(Pe))]),_:1})]),_:1},8,["type"]),p(O,{size:"small",type:w.value==="list"?"primary":"",onClick:s[2]||(s[2]=g=>w.value="list")},{default:v(()=>[p(ae,null,{default:v(()=>[p(J(Ke))]),_:1})]),_:1},8,["type"])]),_:1})])])):X("",!0),I.value?(C(),M("div",Ft,[p(ae,{class:"is-loading"},{default:v(()=>[p(J(He))]),_:1}),s[9]||(s[9]=q(" 加载中...",-1))])):X("",!0),w.value==="grid"?(C(),M("div",Bt,[(C(!0),M(ue,null,me(A.value,g=>(C(),M("div",{key:"f-"+g.id,class:"file-item folder",onClick:le=>T(g),onContextmenu:ee(le=>te(le,g),["prevent"])},[p(ae,{size:48,color:"#f0c040"},{default:v(()=>[p(J(we))]),_:1}),L("span",xt,G(g.name),1)],40,At))),128)),(C(!0),M(ue,null,me(d.value,g=>(C(),M("div",{key:"file-"+g.id,class:Se(["file-item",{selected:m("file",g.id)}]),onClick:[ee(le=>k(g),["exact"]),ee(le=>V("file",g.id),["ctrl"])],onContextmenu:ee(le=>W(le,g),["prevent"])},[p(y,{class:"item-checkbox","model-value":m("file",g.id),onChange:le=>V("file",g.id),onClick:s[3]||(s[3]=ee(()=>{},["stop"]))},null,8,["model-value","onChange"]),e(g).is_image?(C(),M("img",{key:0,src:P(g.id),class:"thumbnail",loading:"lazy"},null,8,Rt)):(C(),Q(ae,{key:1,size:48,color:"#909399"},{default:v(()=>[p(J(Ue))]),_:1})),L("span",Tt,G(g.original_name),1),L("span",Mt,G(ye(e(g).file_size)),1)],42,It))),128))])):X("",!0),w.value==="list"&&!I.value?(C(),Q(ze,{key:3,data:Y.value,onRowContextmenu:ie,onRowClick:ve,style:{width:"100%"},"row-class-name":u},{default:v(()=>[p(be,{width:"40"},{header:v(()=>[p(y,{modelValue:R.value,"onUpdate:modelValue":s[4]||(s[4]=g=>R.value=g),onChange:H,indeterminate:j.value},null,8,["modelValue","indeterminate"])]),default:v(({row:g})=>[g._type==="file"?(C(),Q(y,{key:0,"model-value":m("file",g.id),onChange:le=>V("file",g.id),onClick:s[5]||(s[5]=ee(()=>{},["stop"]))},null,8,["model-value","onChange"])):X("",!0)]),_:1}),p(be,{label:"名称","min-width":"200"},{default:v(({row:g})=>[L("div",Dt,[g._type==="folder"?(C(),Q(ae,{key:0,size:20,color:"#f0c040"},{default:v(()=>[p(J(we))]),_:1})):g._isImage?(C(),M("img",{key:1,src:P(g.id),class:"list-thumb"},null,8,zt)):(C(),Q(ae,{key:2,size:20,color:"#909399"},{default:v(()=>[p(J(Ue))]),_:1})),L("span",null,G(g._type==="folder"?g.name:g.original_name),1)])]),_:1}),p(be,{label:"大小",width:"100"},{default:v(({row:g})=>[q(G(g._type==="file"?ye(g._fileSize):"-"),1)]),_:1}),p(be,{label:"修改时间",width:"170"},{default:v(({row:g})=>[q(G(Me(g.created_at||g.CreatedAt)),1)]),_:1})]),_:1},8,["data"])):X("",!0),!I.value&&A.value.length===0&&d.value.length===0?(C(),M("div",Lt,[p(Le,{description:"暂无文件"})])):X("",!0),b.value.total>b.value.page_size?(C(),Q(Ve,{key:5,"current-page":b.value.page,"page-size":b.value.page_size,total:b.value.total,layout:"prev, pager, next",onCurrentChange:_,class:"pagination"},null,8,["current-page","page-size","total"])):X("",!0),c.value.visible?(C(),M("div",{key:6,class:"context-menu",style:Je({left:c.value.x+"px",top:c.value.y+"px"})},[c.value.type==="file"?(C(),M("div",{key:0,class:"menu-item",onClick:_e},"下载")):X("",!0),L("div",{class:"menu-item",onClick:he},"重命名"),c.value.type==="file"?(C(),M("div",{key:1,class:"menu-item",onClick:Ce},"移动")):X("",!0),L("div",{class:"menu-item menu-item-danger",onClick:N},"删除")],4)):X("",!0),p(Oe,{modelValue:h.value,"onUpdate:modelValue":s[7]||(s[7]=g=>h.value=g),title:"移动到",width:"400px"},{footer:v(()=>[p(O,{onClick:s[6]||(s[6]=g=>h.value=!1)},{default:v(()=>[...s[10]||(s[10]=[q("取消",-1)])]),_:1}),p(O,{type:"primary",onClick:ce,disabled:o.value===null},{default:v(()=>[...s[11]||(s[11]=[q("确定",-1)])]),_:1},8,["disabled"])]),default:v(()=>[p(Ne,{data:l.value,props:{label:"name",children:"children"},"node-key":"id","highlight-current":"",onNodeClick:ke},null,8,["data"])]),_:1},8,["modelValue"])])}}},Nt=oe(Vt,[["__scopeId","data-v-cc9565cc"]]);var Te={exports:{}};(function(f,D){(function($){f.exports=$()})(function($){var E=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function U(o,l){var t=o[0],e=o[1],n=o[2],a=o[3];t+=(e&n|~e&a)+l[0]-680876936|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+l[1]-389564586|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+l[2]+606105819|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+l[3]-1044525330|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+l[4]-176418897|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+l[5]+1200080426|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+l[6]-1473231341|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+l[7]-45705983|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+l[8]+1770035416|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+l[9]-1958414417|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+l[10]-42063|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+l[11]-1990404162|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+l[12]+1804603682|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+l[13]-40341101|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+l[14]-1502002290|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+l[15]+1236535329|0,e=(e<<22|e>>>10)+n|0,t+=(e&a|n&~a)+l[1]-165796510|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+l[6]-1069501632|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+l[11]+643717713|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+l[0]-373897302|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+l[5]-701558691|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+l[10]+38016083|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+l[15]-660478335|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+l[4]-405537848|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+l[9]+568446438|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+l[14]-1019803690|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+l[3]-187363961|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+l[8]+1163531501|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+l[13]-1444681467|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+l[2]-51403784|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+l[7]+1735328473|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+l[12]-1926607734|0,e=(e<<20|e>>>12)+n|0,t+=(e^n^a)+l[5]-378558|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+l[8]-2022574463|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+l[11]+1839030562|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+l[14]-35309556|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+l[1]-1530992060|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+l[4]+1272893353|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+l[7]-155497632|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+l[10]-1094730640|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+l[13]+681279174|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+l[0]-358537222|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+l[3]-722521979|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+l[6]+76029189|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+l[9]-640364487|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+l[12]-421815835|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+l[15]+530742520|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+l[2]-995338651|0,e=(e<<23|e>>>9)+n|0,t+=(n^(e|~a))+l[0]-198630844|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+l[7]+1126891415|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+l[14]-1416354905|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+l[5]-57434055|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+l[12]+1700485571|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+l[3]-1894986606|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+l[10]-1051523|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+l[1]-2054922799|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+l[8]+1873313359|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+l[15]-30611744|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+l[6]-1560198380|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+l[13]+1309151649|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+l[4]-145523070|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+l[11]-1120210379|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+l[2]+718787259|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+l[9]-343485551|0,e=(e<<21|e>>>11)+n|0,o[0]=t+o[0]|0,o[1]=e+o[1]|0,o[2]=n+o[2]|0,o[3]=a+o[3]|0}function F(o){var l=[],t;for(t=0;t<64;t+=4)l[t>>2]=o.charCodeAt(t)+(o.charCodeAt(t+1)<<8)+(o.charCodeAt(t+2)<<16)+(o.charCodeAt(t+3)<<24);return l}function I(o){var l=[],t;for(t=0;t<64;t+=4)l[t>>2]=o[t]+(o[t+1]<<8)+(o[t+2]<<16)+(o[t+3]<<24);return l}function A(o){var l=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,n,a,P,Y,u;for(e=64;e<=l;e+=64)U(t,F(o.substring(e-64,e)));for(o=o.substring(e-64),n=o.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)a[e>>2]|=o.charCodeAt(e)<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(U(t,a),e=0;e<16;e+=1)a[e]=0;return P=l*8,P=P.toString(16).match(/(.*?)(.{0,8})$/),Y=parseInt(P[2],16),u=parseInt(P[1],16)||0,a[14]=Y,a[15]=u,U(t,a),t}function d(o){var l=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,n,a,P,Y,u;for(e=64;e<=l;e+=64)U(t,I(o.subarray(e-64,e)));for(o=e-64<l?o.subarray(e-64):new Uint8Array(0),n=o.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)a[e>>2]|=o[e]<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(U(t,a),e=0;e<16;e+=1)a[e]=0;return P=l*8,P=P.toString(16).match(/(.*?)(.{0,8})$/),Y=parseInt(P[2],16),u=parseInt(P[1],16)||0,a[14]=Y,a[15]=u,U(t,a),t}function b(o){var l="",t;for(t=0;t<4;t+=1)l+=E[o>>t*8+4&15]+E[o>>t*8&15];return l}function w(o){var l;for(l=0;l<o.length;l+=1)o[l]=b(o[l]);return o.join("")}w(A("hello")),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function o(l,t){return l=l|0||0,l<0?Math.max(l+t,0):Math.min(l,t)}ArrayBuffer.prototype.slice=function(l,t){var e=this.byteLength,n=o(l,e),a=e,P,Y,u,r;return t!==$&&(a=o(t,e)),n>a?new ArrayBuffer(0):(P=a-n,Y=new ArrayBuffer(P),u=new Uint8Array(Y),r=new Uint8Array(this,n,P),u.set(r),Y)}}();function c(o){return/[\u0080-\uFFFF]/.test(o)&&(o=unescape(encodeURIComponent(o))),o}function z(o,l){var t=o.length,e=new ArrayBuffer(t),n=new Uint8Array(e),a;for(a=0;a<t;a+=1)n[a]=o.charCodeAt(a);return l?n:e}function S(o){return String.fromCharCode.apply(null,new Uint8Array(o))}function R(o,l,t){var e=new Uint8Array(o.byteLength+l.byteLength);return e.set(new Uint8Array(o)),e.set(new Uint8Array(l),o.byteLength),e}function j(o){var l=[],t=o.length,e;for(e=0;e<t-1;e+=2)l.push(parseInt(o.substr(e,2),16));return String.fromCharCode.apply(String,l)}function h(){this.reset()}return h.prototype.append=function(o){return this.appendBinary(c(o)),this},h.prototype.appendBinary=function(o){this._buff+=o,this._length+=o.length;var l=this._buff.length,t;for(t=64;t<=l;t+=64)U(this._hash,F(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},h.prototype.end=function(o){var l=this._buff,t=l.length,e,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a;for(e=0;e<t;e+=1)n[e>>2]|=l.charCodeAt(e)<<(e%4<<3);return this._finish(n,t),a=w(this._hash),o&&(a=j(a)),this.reset(),a},h.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},h.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},h.prototype.setState=function(o){return this._buff=o.buff,this._length=o.length,this._hash=o.hash,this},h.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},h.prototype._finish=function(o,l){var t=l,e,n,a;if(o[t>>2]|=128<<(t%4<<3),t>55)for(U(this._hash,o),t=0;t<16;t+=1)o[t]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(e[2],16),a=parseInt(e[1],16)||0,o[14]=n,o[15]=a,U(this._hash,o)},h.hash=function(o,l){return h.hashBinary(c(o),l)},h.hashBinary=function(o,l){var t=A(o),e=w(t);return l?j(e):e},h.ArrayBuffer=function(){this.reset()},h.ArrayBuffer.prototype.append=function(o){var l=R(this._buff.buffer,o),t=l.length,e;for(this._length+=o.byteLength,e=64;e<=t;e+=64)U(this._hash,I(l.subarray(e-64,e)));return this._buff=e-64<t?new Uint8Array(l.buffer.slice(e-64)):new Uint8Array(0),this},h.ArrayBuffer.prototype.end=function(o){var l=this._buff,t=l.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n,a;for(n=0;n<t;n+=1)e[n>>2]|=l[n]<<(n%4<<3);return this._finish(e,t),a=w(this._hash),o&&(a=j(a)),this.reset(),a},h.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},h.ArrayBuffer.prototype.getState=function(){var o=h.prototype.getState.call(this);return o.buff=S(o.buff),o},h.ArrayBuffer.prototype.setState=function(o){return o.buff=z(o.buff,!0),h.prototype.setState.call(this,o)},h.ArrayBuffer.prototype.destroy=h.prototype.destroy,h.ArrayBuffer.prototype._finish=h.prototype._finish,h.ArrayBuffer.hash=function(o,l){var t=d(new Uint8Array(o)),e=w(t);return l?j(e):e},h})})(Te);var Ot=Te.exports;const Et=qe(Ot),jt={key:0,class:"drag-overlay"},Pt={class:"upload-name"},Kt={class:"upload-status-text"},xe=5*1024*1024,Ht=5*1024*1024,Ie=3,Jt=1e3,qt={__name:"FileUpload",props:{folderId:{type:Number,default:0}},emits:["uploaded"],setup(f,{expose:D,emit:$}){const E=f,U=$,F=B(null),I=B(null),A=B(!1),d=B([]),b=B(!1);function w(){var u;(u=F.value)==null||u.click()}function c(){b.value=!0}function z(){b.value=!1}function S(u){b.value=!1;const r=Array.from(u.dataTransfer.files);r.length&&j(r)}function R(u){const r=Array.from(u.target.files);r.length&&j(r),F.value.value=""}async function j(u){var T,k;A.value=!0;const r=d.value.length;d.value.push(...u.map(_=>({name:_.name,progress:0,status:"",statusText:"等待中..."})));for(let _=0;_<u.length;_++){const m=r+_,V=u[_];try{V.size>Ht?await o(V,m):await h(V,m),d.value[m].status="done",d.value[m].progress=100,d.value[m].statusText="上传完成"}catch(H){d.value[m].status="error";const W=((k=(T=H==null?void 0:H.response)==null?void 0:T.data)==null?void 0:k.message)||(H==null?void 0:H.message)||"上传失败";d.value[m].statusText=W,Z.error(`${V.name}: ${W}`)}}U("uploaded")}async function h(u,r){d.value[r].statusText="上传中...";const T=new FormData;T.append("file",u),T.append("folder_id",E.folderId),await ct(T,k=>{k.total&&(d.value[r].progress=Math.round(k.loaded/k.total*100))})}async function o(u,r){var te,ie,ve,_e,he;d.value[r].statusText="计算文件指纹...";const T=await l(u,N=>{d.value[r].progress=Math.round(N*20)});let k="",_=0,m=xe,V=new Set;const H=e(u.name,u.size,T);if(H){d.value[r].statusText="检测到断点，校验任务状态...";try{k=H.uploadId,_=H.totalChunks;const N=await Ae(k);if(Number.isInteger((te=N.data)==null?void 0:te.total_chunks)&&N.data.total_chunks>0&&(_=N.data.total_chunks),((ie=N.data)==null?void 0:ie.status)==="completed"){Y(k),d.value[r].statusText="上传已完成",d.value[r].progress=100;return}(ve=N.data)!=null&&ve.uploaded_chunks&&N.data.uploaded_chunks.forEach(ne=>V.add(ne))}catch{Y(k),k="",_=0,V=new Set}}if(!k){d.value[r].statusText="检查秒传...";const N=await ft({file_name:u.name,file_size:u.size,file_md5:T,folder_id:E.folderId});if(((_e=N.data)==null?void 0:_e.status)==="instant_upload"){d.value[r].statusText="秒传完成",d.value[r].progress=100;return}k=N.data.upload_id,_=N.data.total_chunks,m=N.data.chunk_size||xe,t(k,u.name,u.size,T,_);try{const ne=await Ae(k);(he=ne.data)!=null&&he.uploaded_chunks&&ne.data.uploaded_chunks.forEach(se=>V.add(se))}catch{V=new Set}}let W=V.size;d.value[r].statusText="分片上传中...";for(let N=0;N<_;N++){if(V.has(N))continue;const ne=N*m,se=Math.min(ne+m,u.size),Ce=u.slice(ne,se),re=new FormData;re.append("upload_id",k),re.append("chunk_index",N),re.append("chunk",Ce),d.value[r].statusText=`分片上传中... (${N+1}/${_})`,await P(re,k,N,ce=>{if(!ce.total||_<=0)return;const ge=ce.loaded/ce.total,ye=(W+ge)/_;d.value[r].progress=Math.round(20+ye*70)}),W++;const ke=W/_*70;d.value[r].progress=Math.round(20+ke)}d.value[r].statusText="合并文件...",d.value[r].progress=90,await mt({upload_id:k}),d.value[r].progress=100,Y(k)}function l(u,r){return new Promise((T,k)=>{const _=new Et.ArrayBuffer,m=new FileReader,V=Math.ceil(u.size/(2*1024*1024));let H=0;m.onload=te=>{_.append(te.target.result),H++,r&&r(H/V),H<V?W():T(_.end())},m.onerror=()=>k(new Error("MD5计算失败"));function W(){const te=H*2*1024*1024,ie=Math.min(te+2*1024*1024,u.size);m.readAsArrayBuffer(u.slice(te,ie))}W()})}function t(u,r,T,k,_){const m=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");m[u]={fileName:r,fileSize:T,md5:k,totalChunks:_,savedAt:Date.now()},localStorage.setItem("mcloud_upload_tasks",JSON.stringify(m))}function e(u,r,T){const k=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");for(const[_,m]of Object.entries(k))if(m.fileName===u&&m.fileSize===r&&m.md5===T)return{uploadId:_,totalChunks:m.totalChunks};return null}function n(u){return(u==null?void 0:u.code)==="ECONNABORTED"?!0:String((u==null?void 0:u.message)||"").toLowerCase().includes("timeout")}function a(u){return new Promise(r=>setTimeout(r,u))}async function P(u,r,T,k){let _=null;for(let m=0;m<=Ie;m++)try{await pt(u,k);return}catch(V){_=V;const H=n(V)?" timeout":"";if(console.warn(`[upload] chunk failed${H}: upload_id=${r}, chunk=${T}, attempt=${m+1}`,V),m===Ie)break;await a(Jt*(m+1))}throw _}function Y(u){const r=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");delete r[u],localStorage.setItem("mcloud_upload_tasks",JSON.stringify(r))}return Re(()=>{const u=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}"),r=Date.now();let T=!1;for(const[_,m]of Object.entries(u))r-m.savedAt>24*60*60*1e3&&(delete u[_],T=!0);T&&localStorage.setItem("mcloud_upload_tasks",JSON.stringify(u));const k=Object.keys(u).length;k>0&&Z.info(`检测到 ${k} 个未完成上传任务，请重新选择对应文件继续上传`)}),D({triggerUpload:w}),(u,r)=>{const T=x("el-progress"),k=x("el-button"),_=x("el-dialog");return C(),M("div",{ref_key:"dropZone",ref:I,class:Se(["upload-wrapper",{"drag-over":b.value}]),onDragover:ee(c,["prevent"]),onDragleave:ee(z,["prevent"]),onDrop:ee(S,["prevent"])},[L("input",{ref_key:"fileInput",ref:F,type:"file",multiple:"",hidden:"",onChange:R},null,544),b.value?(C(),M("div",jt,"释放文件以上传")):X("",!0),p(_,{modelValue:A.value,"onUpdate:modelValue":r[1]||(r[1]=m=>A.value=m),title:"上传文件","close-on-click-modal":!1,width:"500px"},{footer:v(()=>[p(k,{onClick:r[0]||(r[0]=m=>A.value=!1)},{default:v(()=>[...r[2]||(r[2]=[q("关闭",-1)])]),_:1})]),default:v(()=>[(C(!0),M(ue,null,me(d.value,(m,V)=>(C(),M("div",{key:V,class:"upload-item"},[L("div",Pt,G(m.name),1),L("div",Kt,G(m.statusText),1),p(T,{percentage:m.progress,status:m.status==="error"?"exception":m.status==="done"?"success":""},null,8,["percentage","status"])]))),128))]),_:1},8,["modelValue"])],34)}}},Yt=oe(qt,[["__scopeId","data-v-a9e6d911"]]),Gt=["src"],Xt={__name:"ImagePreview",props:{visible:{type:Boolean,default:!1},file:{type:Object,default:null}},emits:["update:visible"],setup(f,{emit:D}){const $=f,E=D,U=B(""),F=pe({get:()=>$.visible,set:d=>E("update:visible",d)});function I(){U.value&&(URL.revokeObjectURL(U.value),U.value="")}async function A(){if(I(),!!$.file)try{const d=await Ct($.file.id);U.value=URL.createObjectURL(d)}catch{U.value=""}}return fe(()=>{var d;return[$.visible,(d=$.file)==null?void 0:d.id]},([d])=>{d?A():I()},{immediate:!0}),Ye(()=>{I()}),(d,b)=>{var c;const w=x("el-dialog");return C(),Q(w,{modelValue:F.value,"onUpdate:modelValue":b[2]||(b[2]=z=>F.value=z),title:(c=f.file)==null?void 0:c.original_name,fullscreen:"","append-to-body":""},{default:v(()=>[L("div",{class:"preview-container",onClick:b[1]||(b[1]=z=>F.value=!1)},[U.value?(C(),M("img",{key:0,src:U.value,class:"preview-image",onClick:b[0]||(b[0]=ee(()=>{},["stop"]))},null,8,Gt)):X("",!0)])]),_:1},8,["modelValue","title"])}}},Zt=oe(Xt,[["__scopeId","data-v-f463ea88"]]),Wt=["onClick"],Qt={key:1},en={__name:"Breadcrumb",props:{items:{type:Array,default:()=>[]}},emits:["navigate"],setup(f,{emit:D}){const $=f,E=D;function U(F,I){const A=$.items.slice(0,I+1);E("navigate",{id:F.id,breadcrumbs:A})}return(F,I)=>{const A=x("el-breadcrumb-item"),d=x("el-breadcrumb");return C(),Q(d,{separator:"/"},{default:v(()=>[(C(!0),M(ue,null,me(f.items,(b,w)=>(C(),Q(A,{key:b.id},{default:v(()=>[w<f.items.length-1?(C(),M("a",{key:0,href:"#",onClick:ee(c=>U(b,w),["prevent"])},G(b.name),9,Wt)):(C(),M("span",Qt,G(b.name),1))]),_:2},1024))),128))]),_:1})}}},tn=oe(en,[["__scopeId","data-v-7d4131d2"]]);function nn(f){return K.get("/recycle-bin",{params:f})}function an(f){return K.post(`/recycle-bin/${f}/restore`)}function ln(f){return K.delete(`/recycle-bin/${f}`)}function on(){return K.post("/recycle-bin/empty")}const sn={key:0,class:"empty"},rn={class:"item-info"},un={class:"item-actions"},dn={__name:"RecycleBin",props:{visible:{type:Boolean,default:!1}},emits:["update:visible","restored"],setup(f,{emit:D}){const $=f,E=D,U=pe({get:()=>$.visible,set:w=>E("update:visible",w)}),F=B([]);async function I(){var w;try{const c=await nn({page:1,page_size:50});F.value=((w=c.data)==null?void 0:w.items)||[]}catch{}}async function A(w){try{await an(w),Z.success("恢复成功"),I(),E("restored")}catch{}}async function d(w){try{await de.confirm("永久删除后无法恢复，确定？","确认"),await ln(w),Z.success("已永久删除"),I()}catch{}}async function b(){try{await de.confirm("确定清空回收站？此操作不可恢复","确认"),await on(),Z.success("回收站已清空"),F.value=[]}catch{}}return fe(()=>$.visible,w=>{w&&I()}),(w,c)=>{const z=x("el-empty"),S=x("el-icon"),R=x("el-button"),j=x("el-drawer");return C(),Q(j,{modelValue:U.value,"onUpdate:modelValue":c[0]||(c[0]=h=>U.value=h),title:"回收站",size:"400px"},{footer:v(()=>[p(R,{type:"danger",onClick:b,disabled:F.value.length===0},{default:v(()=>[...c[3]||(c[3]=[q("清空回收站",-1)])]),_:1},8,["disabled"])]),default:v(()=>[F.value.length===0?(C(),M("div",sn,[p(z,{description:"回收站为空"})])):X("",!0),(C(!0),M(ue,null,me(F.value,h=>(C(),M("div",{key:h.id,class:"recycle-item"},[L("div",rn,[p(S,null,{default:v(()=>[h.original_type==="file"?(C(),Q(J(Ue),{key:0})):(C(),Q(J(we),{key:1}))]),_:2},1024),L("span",null,G(h.original_name),1)]),L("div",un,[p(R,{size:"small",type:"primary",text:"",onClick:o=>A(h.id)},{default:v(()=>[...c[1]||(c[1]=[q("恢复",-1)])]),_:1},8,["onClick"]),p(R,{size:"small",type:"danger",text:"",onClick:o=>d(h.id)},{default:v(()=>[...c[2]||(c[2]=[q("删除",-1)])]),_:1},8,["onClick"])])]))),128))]),_:1},8,["modelValue"])}}},cn=oe(dn,[["__scopeId","data-v-70c3eeda"]]),fn={class:"home-container"},pn={class:"header-left"},mn={class:"header-right"},vn={class:"user-info"},_n={class:"main-content"},hn={class:"content"},gn={__name:"Home",setup(f){const D=Ge(),$=Fe(),E=B(null),U=B(null),F=B(!0),I=B(!1),A=B(null),d=B(!1),b=B(!1),w=B("");async function c(){try{const e=await nt();$.setUser(e.data),$.resetToRoot()}catch{D.push("/login")}}c();function z(e){$.setCurrentFolder(e.id,e.breadcrumbs)}function S(e){$.setCurrentFolder(e.id,e.breadcrumbs)}function R(e){A.value=e,I.value=!0}function j(){var e;(e=E.value)==null||e.loadFiles()}function h(){w.value="",b.value=!0}async function o(){if(!w.value.trim()){Z.warning("请输入文件夹名称");return}try{await at({name:w.value.trim(),parent_id:$.currentFolderID}),Z.success("文件夹创建成功"),b.value=!1,j()}catch{}}function l(e){var n,a;e==="logout"?de.confirm("确定退出登录？","提示").then(()=>{tt(),$.clearUser(),D.push("/login")}).catch(()=>{}):e==="quota"&&Z.info(`已用 ${t((n=$.userInfo)==null?void 0:n.storage_used)} / ${t((a=$.userInfo)==null?void 0:a.storage_quota)}`)}function t(e){if(!e)return"0 B";const n=["B","KB","MB","GB","TB"],a=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,a)).toFixed(1)+" "+n[a]}return(e,n)=>{const a=x("el-button"),P=x("el-dropdown-item"),Y=x("el-dropdown-menu"),u=x("el-dropdown"),r=x("el-header"),T=x("el-input"),k=x("el-dialog");return C(),M("div",fn,[p(r,{class:"header"},{default:v(()=>[L("div",pn,[p(a,{class:"menu-btn",icon:J(Xe),onClick:n[0]||(n[0]=_=>F.value=!F.value)},null,8,["icon"]),n[8]||(n[8]=L("h3",null,"mCloud",-1))]),L("div",mn,[p(a,{type:"primary",icon:J(Ze),onClick:n[1]||(n[1]=_=>{var m;return(m=U.value)==null?void 0:m.triggerUpload()})},{default:v(()=>[...n[9]||(n[9]=[q("上传",-1)])]),_:1},8,["icon"]),p(a,{icon:J(We),onClick:h},{default:v(()=>[...n[10]||(n[10]=[q("新建文件夹",-1)])]),_:1},8,["icon"]),p(a,{icon:J(Qe),onClick:n[2]||(n[2]=_=>d.value=!0)},{default:v(()=>[...n[11]||(n[11]=[q("回收站",-1)])]),_:1},8,["icon"]),p(u,{onCommand:l},{dropdown:v(()=>[p(Y,null,{default:v(()=>[p(P,{command:"quota"},{default:v(()=>[...n[12]||(n[12]=[q("存储空间",-1)])]),_:1}),p(P,{command:"logout",divided:""},{default:v(()=>[...n[13]||(n[13]=[q("退出登录",-1)])]),_:1})]),_:1})]),default:v(()=>{var _,m;return[L("span",vn,G(((_=J($).userInfo)==null?void 0:_.nickname)||((m=J($).userInfo)==null?void 0:m.username)),1)]}),_:1})])]),_:1}),L("div",_n,[L("aside",{class:Se(["sidebar",{visible:F.value}])},[p(ut,{onSelect:z})],2),L("main",hn,[p(tn,{items:J($).breadcrumbs,onNavigate:S},null,8,["items"]),p(Nt,{"folder-id":J($).currentFolderID,ref_key:"fileListRef",ref:E,onPreview:R},null,8,["folder-id"])])]),p(Yt,{ref_key:"uploadRef",ref:U,"folder-id":J($).currentFolderID,onUploaded:j},null,8,["folder-id"]),p(Zt,{visible:I.value,"onUpdate:visible":n[3]||(n[3]=_=>I.value=_),file:A.value},null,8,["visible","file"]),p(cn,{visible:d.value,"onUpdate:visible":n[4]||(n[4]=_=>d.value=_),onRestored:j},null,8,["visible"]),p(k,{modelValue:b.value,"onUpdate:modelValue":n[7]||(n[7]=_=>b.value=_),title:"新建文件夹",width:"400px"},{footer:v(()=>[p(a,{onClick:n[6]||(n[6]=_=>b.value=!1)},{default:v(()=>[...n[14]||(n[14]=[q("取消",-1)])]),_:1}),p(a,{type:"primary",onClick:o},{default:v(()=>[...n[15]||(n[15]=[q("创建",-1)])]),_:1})]),default:v(()=>[p(T,{modelValue:w.value,"onUpdate:modelValue":n[5]||(n[5]=_=>w.value=_),placeholder:"请输入文件夹名称",onKeyup:et(o,["enter"])},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}},wn=oe(gn,[["__scopeId","data-v-c8ef7c20"]]);export{wn as default};
