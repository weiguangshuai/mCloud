import{i as ue,r as I,o as b,c as D,a as c,w as p,b as V,j as J,k as pe,t as q,h as B,l as de,n as Ne,m as $e,p as Oe,f as H,F as oe,q as G,v as je,x as Pe,y as Ee,z as ce,A as X,d as Q,B as _e,C as Ke,D as ie,E as Z,G as ge,H as Je,I as He,u as qe,J as Ge,K as Ze,L as Xe,M as Ye,e as Qe,N as We}from"./index-DLUryMbh.js";import{a as j,_ as ae,u as ye,g as et}from"./_plugin-vue_export-helper-DhhmKej2.js";function he(d=0){return j.get("/folders",{params:{parent_id:d}})}function tt(d){return j.post("/folders",d)}function nt(d,M){return j.put(`/folders/${d}`,M)}function at(d){return j.delete(`/folders/${d}`)}const lt={class:"folder-tree"},ot={class:"node-content"},it={__name:"FolderTree",emits:["select"],setup(d,{emit:M}){const $=M,N=ye(),U=B(null),F=B([]),R={label:"name",children:"children",isLeaf:"isLeaf"},x=de(()=>{var u;return((u=N.userInfo)==null?void 0:u.root_folder_id)||0});function f(){return[{id:x.value,name:"全部文件",isRoot:!0,isLeaf:!1}]}async function g(u,T){if(u.level===0){T(F.value);return}try{const z=((await he(u.data.id)).data||[]).map(O=>({id:O.id,name:O.name,isLeaf:!1}));T(z)}catch{T([])}}function y(u,T){const S=[];let z=T;for(;z&&z.level>0;){const O=z.level===1?"根目录":z.data.name;S.unshift({id:z.data.id,name:O}),z=z.parent}S.length===0&&S.push({id:x.value,name:"根目录"}),$("select",{id:u.id,breadcrumbs:S})}return ue(()=>x.value,async()=>{var u;F.value=f(),await Ne(),(u=U.value)==null||u.setCurrentKey(N.currentFolderID||x.value)},{immediate:!0}),ue(()=>N.currentFolderID,u=>{var T;(T=U.value)==null||T.setCurrentKey(u)}),(u,T)=>{const S=I("el-icon"),z=I("el-tree");return b(),D("div",lt,[c(z,{ref_key:"treeRef",ref:U,data:F.value,props:R,"node-key":"id",lazy:"",load:g,"highlight-current":"","expand-on-click-node":!1,onNodeClick:y},{default:p(({data:O})=>[V("div",ot,[c(S,null,{default:p(()=>[c(J(pe))]),_:1}),V("span",null,q(O.name),1)])]),_:1},8,["data"])])}}},st=ae(it,[["__scopeId","data-v-c92c9de3"]]);function rt(d){return j.get("/files",{params:d})}function ut(d,M){return j.post("/files/upload",d,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:M})}function dt(d){return j.post("/files/upload/init",d)}function ct(d,M){return j.post("/files/upload/chunk",d,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:M})}function ft(d){return j.post("/files/upload/complete",d)}function Ue(d){return j.get(`/files/upload/status/${d}`)}function pt(d){return j.delete(`/files/${d}`)}function mt(d,M){return j.put(`/files/${d}/rename`,{name:M})}function vt(d,M){return j.put(`/files/${d}/move`,{folder_id:M})}function _t(d){return j.post("/files/batch/delete",{file_ids:d})}function ht(d,M){return j.post("/files/batch/move",{file_ids:d,folder_id:M})}function gt(d){return j.get(`/files/${d}/download`,{responseType:"blob"})}function yt(d){return j.get(`/files/${d}/thumbnail`,{responseType:"blob"})}function bt(d){return j.get(`/files/${d}/preview`,{responseType:"blob"})}const wt={class:"file-list-container"},Ct={key:0,class:"toolbar"},Ut={class:"toolbar-left"},kt={class:"toolbar-right"},$t={key:1,class:"loading"},St={key:2,class:"grid-view"},Ft=["onClick","onContextmenu"],Bt={class:"file-name"},xt=["onClick","onContextmenu"],At=["src"],It={class:"file-name"},Rt={class:"file-size"},zt={class:"list-name-cell"},Dt=["src"],Mt={key:4,class:"empty"},Tt={__name:"FileList",props:{folderId:{type:Number,default:0}},emits:["preview"],setup(d,{expose:M,emit:$}){const N=d,U=$,F=ye(),R=B(!1),x=B([]),f=B([]),g=B({page:1,page_size:20,total:0}),y=B("grid"),u=B({visible:!1,x:0,y:0,target:null,type:""}),T=B({}),S=B([]),z=B(!1),O=de(()=>S.value.length>0&&S.value.length<f.value.length),m=B(!1),o=B(null),l=B([]),n=B([]);function e(i){return i.file_object||{}}function a(){for(const i of Object.values(T.value))URL.revokeObjectURL(i);T.value={}}async function t(i=f.value){a();const s=i.filter(h=>e(h).is_image);await Promise.all(s.map(async h=>{try{const L=await yt(h.id);T.value[h.id]=URL.createObjectURL(L)}catch{}}))}function r(i){return T.value[i]||""}const k=de(()=>{const i=x.value.map(h=>({...h,_type:"folder"})),s=f.value.map(h=>{const L=e(h);return{...h,_type:"file",_isImage:L.is_image,_fileSize:L.file_size}});return[...i,...s]});function v({row:i}){return i._type==="file"&&K("file",i.id)?"selected-row":""}async function C(){var i,s;R.value=!0,S.value=[],z.value=!1;try{const[h,L]=await Promise.all([he(N.folderId),rt({folder_id:N.folderId,page:g.value.page,page_size:g.value.page_size})]);x.value=h.data||[],f.value=((i=L.data)==null?void 0:i.files)||[],await t(f.value),(s=L.data)!=null&&s.pagination&&(g.value=L.data.pagination)}catch{}R.value=!1}function w(i){const s=[...F.breadcrumbs,{id:i.id,name:i.name}];F.setCurrentFolder(i.id,s)}function E(i){e(i).is_image&&U("preview",i)}function A(i){g.value.page=i,C()}function K(i,s){return S.value.some(h=>h.type===i&&h.id===s)}function Y(i,s){const h=S.value.findIndex(L=>L.type===i&&L.id===s);h>=0?S.value.splice(h,1):S.value.push({type:i,id:s}),z.value=S.value.length===f.value.length}function ne(i){i?S.value=f.value.map(s=>({type:"file",id:s.id})):S.value=[]}function se(i,s){u.value={visible:!0,x:i.clientX,y:i.clientY,target:s,type:"file"}}function P(i,s){u.value={visible:!0,x:i.clientX,y:i.clientY,target:s,type:"folder"}}function W(i,s,h){h.preventDefault(),i._type==="file"?se(h,i):P(h,i)}function re(i){i._type==="folder"?w(i):e(i).is_image&&U("preview",i)}async function me(){if(u.value.type==="file")try{const i=await gt(u.value.target.id),s=URL.createObjectURL(i),h=document.createElement("a");h.href=s,h.download=u.value.target.original_name,h.click(),URL.revokeObjectURL(s)}catch{Z.error("下载失败")}u.value.visible=!1}async function le(){const i=u.value.target,s=u.value.type,h=s==="file"?i.original_name:i.name;u.value.visible=!1;try{const{value:L}=await ie.prompt("输入新名称","重命名",{inputValue:h,inputValidator:ee=>ee&&ee.trim()?!0:"名称不能为空"});if(L.trim()===h)return;s==="file"?await mt(i.id,L.trim()):await nt(i.id,{name:L.trim()}),Z.success("重命名成功"),C()}catch{}}async function ve(){const i=u.value.target,s=u.value.type;u.value.visible=!1;try{await ie.confirm(`确定删除 ${s==="file"?i.original_name:i.name}？`,"确认删除"),s==="file"?await pt(i.id):await at(i.id),Z.success("已移到回收站"),C()}catch{}}async function Fe(){const i=S.value.filter(s=>s.type==="file").map(s=>s.id);if(i.length)try{await ie.confirm(`确定删除选中的 ${i.length} 个文件？`,"批量删除"),await _t(i),Z.success("已移到回收站"),C()}catch{}}async function be(){var s;const i=((s=F.userInfo)==null?void 0:s.root_folder_id)||0;try{const h=await he(i);l.value=[{id:i,name:"根目录",children:h.data||[]}]}catch{l.value=[{id:i,name:"根目录",children:[]}]}}function Be(){n.value=[u.value.target.id],u.value.visible=!1,o.value=null,be(),m.value=!0}function xe(){n.value=S.value.filter(i=>i.type==="file").map(i=>i.id),n.value.length&&(o.value=null,be(),m.value=!0)}function Ae(i){o.value=i.id}async function Ie(){if(o.value!==null)try{n.value.length===1?await vt(n.value[0],o.value):await ht(n.value,o.value),Z.success("移动成功"),m.value=!1,C()}catch{Z.error("移动失败")}}function we(){u.value.visible=!1}function Ce(i){if(!i)return"0 B";const s=["B","KB","MB","GB"],h=Math.floor(Math.log(i)/Math.log(1024));return(i/Math.pow(1024,h)).toFixed(1)+" "+s[h]}function Re(i){return i?new Date(i).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""}return ue(()=>N.folderId,()=>{g.value.page=1,C()},{immediate:!0}),$e(()=>document.addEventListener("click",we)),Oe(()=>{document.removeEventListener("click",we),a()}),M({loadFiles:C}),(i,s)=>{const h=I("el-checkbox"),L=I("el-button"),ee=I("el-icon"),ze=I("el-button-group"),fe=I("el-table-column"),De=I("el-table"),Me=I("el-empty"),Te=I("el-pagination"),Ve=I("el-tree"),Le=I("el-dialog");return b(),D("div",wt,[!R.value&&(x.value.length>0||f.value.length>0||S.value.length>0)?(b(),D("div",Ct,[V("div",Ut,[c(h,{modelValue:z.value,"onUpdate:modelValue":s[0]||(s[0]=_=>z.value=_),onChange:ne,indeterminate:O.value},{default:p(()=>[...s[8]||(s[8]=[H("全选",-1)])]),_:1},8,["modelValue","indeterminate"]),S.value.length>0?(b(),D(oe,{key:0},[c(L,{size:"small",type:"danger",onClick:Fe},{default:p(()=>[H("删除 ("+q(S.value.length)+")",1)]),_:1}),c(L,{size:"small",onClick:xe},{default:p(()=>[H("移动 ("+q(S.value.length)+")",1)]),_:1})],64)):G("",!0)]),V("div",kt,[c(ze,null,{default:p(()=>[c(L,{size:"small",type:y.value==="grid"?"primary":"",onClick:s[1]||(s[1]=_=>y.value="grid")},{default:p(()=>[c(ee,null,{default:p(()=>[c(J(je))]),_:1})]),_:1},8,["type"]),c(L,{size:"small",type:y.value==="list"?"primary":"",onClick:s[2]||(s[2]=_=>y.value="list")},{default:p(()=>[c(ee,null,{default:p(()=>[c(J(Pe))]),_:1})]),_:1},8,["type"])]),_:1})])])):G("",!0),R.value?(b(),D("div",$t,[c(ee,{class:"is-loading"},{default:p(()=>[c(J(Ee))]),_:1}),s[9]||(s[9]=H(" 加载中...",-1))])):G("",!0),y.value==="grid"?(b(),D("div",St,[(b(!0),D(oe,null,ce(x.value,_=>(b(),D("div",{key:"f-"+_.id,class:"file-item folder",onClick:te=>w(_),onContextmenu:Q(te=>P(te,_),["prevent"])},[c(ee,{size:48,color:"#f0c040"},{default:p(()=>[c(J(pe))]),_:1}),V("span",Bt,q(_.name),1)],40,Ft))),128)),(b(!0),D(oe,null,ce(f.value,_=>(b(),D("div",{key:"file-"+_.id,class:ge(["file-item",{selected:K("file",_.id)}]),onClick:[Q(te=>E(_),["exact"]),Q(te=>Y("file",_.id),["ctrl"])],onContextmenu:Q(te=>se(te,_),["prevent"])},[c(h,{class:"item-checkbox","model-value":K("file",_.id),onChange:te=>Y("file",_.id),onClick:s[3]||(s[3]=Q(()=>{},["stop"]))},null,8,["model-value","onChange"]),e(_).is_image?(b(),D("img",{key:0,src:r(_.id),class:"thumbnail",loading:"lazy"},null,8,At)):(b(),X(ee,{key:1,size:48,color:"#909399"},{default:p(()=>[c(J(_e))]),_:1})),V("span",It,q(_.original_name),1),V("span",Rt,q(Ce(e(_).file_size)),1)],42,xt))),128))])):G("",!0),y.value==="list"&&!R.value?(b(),X(De,{key:3,data:k.value,onRowContextmenu:W,onRowClick:re,style:{width:"100%"},"row-class-name":v},{default:p(()=>[c(fe,{width:"40"},{header:p(()=>[c(h,{modelValue:z.value,"onUpdate:modelValue":s[4]||(s[4]=_=>z.value=_),onChange:ne,indeterminate:O.value},null,8,["modelValue","indeterminate"])]),default:p(({row:_})=>[_._type==="file"?(b(),X(h,{key:0,"model-value":K("file",_.id),onChange:te=>Y("file",_.id),onClick:s[5]||(s[5]=Q(()=>{},["stop"]))},null,8,["model-value","onChange"])):G("",!0)]),_:1}),c(fe,{label:"名称","min-width":"200"},{default:p(({row:_})=>[V("div",zt,[_._type==="folder"?(b(),X(ee,{key:0,size:20,color:"#f0c040"},{default:p(()=>[c(J(pe))]),_:1})):_._isImage?(b(),D("img",{key:1,src:r(_.id),class:"list-thumb"},null,8,Dt)):(b(),X(ee,{key:2,size:20,color:"#909399"},{default:p(()=>[c(J(_e))]),_:1})),V("span",null,q(_._type==="folder"?_.name:_.original_name),1)])]),_:1}),c(fe,{label:"大小",width:"100"},{default:p(({row:_})=>[H(q(_._type==="file"?Ce(_._fileSize):"-"),1)]),_:1}),c(fe,{label:"修改时间",width:"170"},{default:p(({row:_})=>[H(q(Re(_.created_at||_.CreatedAt)),1)]),_:1})]),_:1},8,["data"])):G("",!0),!R.value&&x.value.length===0&&f.value.length===0?(b(),D("div",Mt,[c(Me,{description:"暂无文件"})])):G("",!0),g.value.total>g.value.page_size?(b(),X(Te,{key:5,"current-page":g.value.page,"page-size":g.value.page_size,total:g.value.total,layout:"prev, pager, next",onCurrentChange:A,class:"pagination"},null,8,["current-page","page-size","total"])):G("",!0),u.value.visible?(b(),D("div",{key:6,class:"context-menu",style:Ke({left:u.value.x+"px",top:u.value.y+"px"})},[u.value.type==="file"?(b(),D("div",{key:0,class:"menu-item",onClick:me},"下载")):G("",!0),V("div",{class:"menu-item",onClick:le},"重命名"),u.value.type==="file"?(b(),D("div",{key:1,class:"menu-item",onClick:Be},"移动")):G("",!0),V("div",{class:"menu-item menu-item-danger",onClick:ve},"删除")],4)):G("",!0),c(Le,{modelValue:m.value,"onUpdate:modelValue":s[7]||(s[7]=_=>m.value=_),title:"移动到",width:"400px"},{footer:p(()=>[c(L,{onClick:s[6]||(s[6]=_=>m.value=!1)},{default:p(()=>[...s[10]||(s[10]=[H("取消",-1)])]),_:1}),c(L,{type:"primary",onClick:Ie,disabled:o.value===null},{default:p(()=>[...s[11]||(s[11]=[H("确定",-1)])]),_:1},8,["disabled"])]),default:p(()=>[c(Ve,{data:l.value,props:{label:"name",children:"children"},"node-key":"id","highlight-current":"",onNodeClick:Ae},null,8,["data"])]),_:1},8,["modelValue"])])}}},Vt=ae(Tt,[["__scopeId","data-v-cc9565cc"]]);var Se={exports:{}};(function(d,M){(function($){d.exports=$()})(function($){var N=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function U(o,l){var n=o[0],e=o[1],a=o[2],t=o[3];n+=(e&a|~e&t)+l[0]-680876936|0,n=(n<<7|n>>>25)+e|0,t+=(n&e|~n&a)+l[1]-389564586|0,t=(t<<12|t>>>20)+n|0,a+=(t&n|~t&e)+l[2]+606105819|0,a=(a<<17|a>>>15)+t|0,e+=(a&t|~a&n)+l[3]-1044525330|0,e=(e<<22|e>>>10)+a|0,n+=(e&a|~e&t)+l[4]-176418897|0,n=(n<<7|n>>>25)+e|0,t+=(n&e|~n&a)+l[5]+1200080426|0,t=(t<<12|t>>>20)+n|0,a+=(t&n|~t&e)+l[6]-1473231341|0,a=(a<<17|a>>>15)+t|0,e+=(a&t|~a&n)+l[7]-45705983|0,e=(e<<22|e>>>10)+a|0,n+=(e&a|~e&t)+l[8]+1770035416|0,n=(n<<7|n>>>25)+e|0,t+=(n&e|~n&a)+l[9]-1958414417|0,t=(t<<12|t>>>20)+n|0,a+=(t&n|~t&e)+l[10]-42063|0,a=(a<<17|a>>>15)+t|0,e+=(a&t|~a&n)+l[11]-1990404162|0,e=(e<<22|e>>>10)+a|0,n+=(e&a|~e&t)+l[12]+1804603682|0,n=(n<<7|n>>>25)+e|0,t+=(n&e|~n&a)+l[13]-40341101|0,t=(t<<12|t>>>20)+n|0,a+=(t&n|~t&e)+l[14]-1502002290|0,a=(a<<17|a>>>15)+t|0,e+=(a&t|~a&n)+l[15]+1236535329|0,e=(e<<22|e>>>10)+a|0,n+=(e&t|a&~t)+l[1]-165796510|0,n=(n<<5|n>>>27)+e|0,t+=(n&a|e&~a)+l[6]-1069501632|0,t=(t<<9|t>>>23)+n|0,a+=(t&e|n&~e)+l[11]+643717713|0,a=(a<<14|a>>>18)+t|0,e+=(a&n|t&~n)+l[0]-373897302|0,e=(e<<20|e>>>12)+a|0,n+=(e&t|a&~t)+l[5]-701558691|0,n=(n<<5|n>>>27)+e|0,t+=(n&a|e&~a)+l[10]+38016083|0,t=(t<<9|t>>>23)+n|0,a+=(t&e|n&~e)+l[15]-660478335|0,a=(a<<14|a>>>18)+t|0,e+=(a&n|t&~n)+l[4]-405537848|0,e=(e<<20|e>>>12)+a|0,n+=(e&t|a&~t)+l[9]+568446438|0,n=(n<<5|n>>>27)+e|0,t+=(n&a|e&~a)+l[14]-1019803690|0,t=(t<<9|t>>>23)+n|0,a+=(t&e|n&~e)+l[3]-187363961|0,a=(a<<14|a>>>18)+t|0,e+=(a&n|t&~n)+l[8]+1163531501|0,e=(e<<20|e>>>12)+a|0,n+=(e&t|a&~t)+l[13]-1444681467|0,n=(n<<5|n>>>27)+e|0,t+=(n&a|e&~a)+l[2]-51403784|0,t=(t<<9|t>>>23)+n|0,a+=(t&e|n&~e)+l[7]+1735328473|0,a=(a<<14|a>>>18)+t|0,e+=(a&n|t&~n)+l[12]-1926607734|0,e=(e<<20|e>>>12)+a|0,n+=(e^a^t)+l[5]-378558|0,n=(n<<4|n>>>28)+e|0,t+=(n^e^a)+l[8]-2022574463|0,t=(t<<11|t>>>21)+n|0,a+=(t^n^e)+l[11]+1839030562|0,a=(a<<16|a>>>16)+t|0,e+=(a^t^n)+l[14]-35309556|0,e=(e<<23|e>>>9)+a|0,n+=(e^a^t)+l[1]-1530992060|0,n=(n<<4|n>>>28)+e|0,t+=(n^e^a)+l[4]+1272893353|0,t=(t<<11|t>>>21)+n|0,a+=(t^n^e)+l[7]-155497632|0,a=(a<<16|a>>>16)+t|0,e+=(a^t^n)+l[10]-1094730640|0,e=(e<<23|e>>>9)+a|0,n+=(e^a^t)+l[13]+681279174|0,n=(n<<4|n>>>28)+e|0,t+=(n^e^a)+l[0]-358537222|0,t=(t<<11|t>>>21)+n|0,a+=(t^n^e)+l[3]-722521979|0,a=(a<<16|a>>>16)+t|0,e+=(a^t^n)+l[6]+76029189|0,e=(e<<23|e>>>9)+a|0,n+=(e^a^t)+l[9]-640364487|0,n=(n<<4|n>>>28)+e|0,t+=(n^e^a)+l[12]-421815835|0,t=(t<<11|t>>>21)+n|0,a+=(t^n^e)+l[15]+530742520|0,a=(a<<16|a>>>16)+t|0,e+=(a^t^n)+l[2]-995338651|0,e=(e<<23|e>>>9)+a|0,n+=(a^(e|~t))+l[0]-198630844|0,n=(n<<6|n>>>26)+e|0,t+=(e^(n|~a))+l[7]+1126891415|0,t=(t<<10|t>>>22)+n|0,a+=(n^(t|~e))+l[14]-1416354905|0,a=(a<<15|a>>>17)+t|0,e+=(t^(a|~n))+l[5]-57434055|0,e=(e<<21|e>>>11)+a|0,n+=(a^(e|~t))+l[12]+1700485571|0,n=(n<<6|n>>>26)+e|0,t+=(e^(n|~a))+l[3]-1894986606|0,t=(t<<10|t>>>22)+n|0,a+=(n^(t|~e))+l[10]-1051523|0,a=(a<<15|a>>>17)+t|0,e+=(t^(a|~n))+l[1]-2054922799|0,e=(e<<21|e>>>11)+a|0,n+=(a^(e|~t))+l[8]+1873313359|0,n=(n<<6|n>>>26)+e|0,t+=(e^(n|~a))+l[15]-30611744|0,t=(t<<10|t>>>22)+n|0,a+=(n^(t|~e))+l[6]-1560198380|0,a=(a<<15|a>>>17)+t|0,e+=(t^(a|~n))+l[13]+1309151649|0,e=(e<<21|e>>>11)+a|0,n+=(a^(e|~t))+l[4]-145523070|0,n=(n<<6|n>>>26)+e|0,t+=(e^(n|~a))+l[11]-1120210379|0,t=(t<<10|t>>>22)+n|0,a+=(n^(t|~e))+l[2]+718787259|0,a=(a<<15|a>>>17)+t|0,e+=(t^(a|~n))+l[9]-343485551|0,e=(e<<21|e>>>11)+a|0,o[0]=n+o[0]|0,o[1]=e+o[1]|0,o[2]=a+o[2]|0,o[3]=t+o[3]|0}function F(o){var l=[],n;for(n=0;n<64;n+=4)l[n>>2]=o.charCodeAt(n)+(o.charCodeAt(n+1)<<8)+(o.charCodeAt(n+2)<<16)+(o.charCodeAt(n+3)<<24);return l}function R(o){var l=[],n;for(n=0;n<64;n+=4)l[n>>2]=o[n]+(o[n+1]<<8)+(o[n+2]<<16)+(o[n+3]<<24);return l}function x(o){var l=o.length,n=[1732584193,-271733879,-1732584194,271733878],e,a,t,r,k,v;for(e=64;e<=l;e+=64)U(n,F(o.substring(e-64,e)));for(o=o.substring(e-64),a=o.length,t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<a;e+=1)t[e>>2]|=o.charCodeAt(e)<<(e%4<<3);if(t[e>>2]|=128<<(e%4<<3),e>55)for(U(n,t),e=0;e<16;e+=1)t[e]=0;return r=l*8,r=r.toString(16).match(/(.*?)(.{0,8})$/),k=parseInt(r[2],16),v=parseInt(r[1],16)||0,t[14]=k,t[15]=v,U(n,t),n}function f(o){var l=o.length,n=[1732584193,-271733879,-1732584194,271733878],e,a,t,r,k,v;for(e=64;e<=l;e+=64)U(n,R(o.subarray(e-64,e)));for(o=e-64<l?o.subarray(e-64):new Uint8Array(0),a=o.length,t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<a;e+=1)t[e>>2]|=o[e]<<(e%4<<3);if(t[e>>2]|=128<<(e%4<<3),e>55)for(U(n,t),e=0;e<16;e+=1)t[e]=0;return r=l*8,r=r.toString(16).match(/(.*?)(.{0,8})$/),k=parseInt(r[2],16),v=parseInt(r[1],16)||0,t[14]=k,t[15]=v,U(n,t),n}function g(o){var l="",n;for(n=0;n<4;n+=1)l+=N[o>>n*8+4&15]+N[o>>n*8&15];return l}function y(o){var l;for(l=0;l<o.length;l+=1)o[l]=g(o[l]);return o.join("")}y(x("hello")),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function o(l,n){return l=l|0||0,l<0?Math.max(l+n,0):Math.min(l,n)}ArrayBuffer.prototype.slice=function(l,n){var e=this.byteLength,a=o(l,e),t=e,r,k,v,C;return n!==$&&(t=o(n,e)),a>t?new ArrayBuffer(0):(r=t-a,k=new ArrayBuffer(r),v=new Uint8Array(k),C=new Uint8Array(this,a,r),v.set(C),k)}}();function u(o){return/[\u0080-\uFFFF]/.test(o)&&(o=unescape(encodeURIComponent(o))),o}function T(o,l){var n=o.length,e=new ArrayBuffer(n),a=new Uint8Array(e),t;for(t=0;t<n;t+=1)a[t]=o.charCodeAt(t);return l?a:e}function S(o){return String.fromCharCode.apply(null,new Uint8Array(o))}function z(o,l,n){var e=new Uint8Array(o.byteLength+l.byteLength);return e.set(new Uint8Array(o)),e.set(new Uint8Array(l),o.byteLength),e}function O(o){var l=[],n=o.length,e;for(e=0;e<n-1;e+=2)l.push(parseInt(o.substr(e,2),16));return String.fromCharCode.apply(String,l)}function m(){this.reset()}return m.prototype.append=function(o){return this.appendBinary(u(o)),this},m.prototype.appendBinary=function(o){this._buff+=o,this._length+=o.length;var l=this._buff.length,n;for(n=64;n<=l;n+=64)U(this._hash,F(this._buff.substring(n-64,n)));return this._buff=this._buff.substring(n-64),this},m.prototype.end=function(o){var l=this._buff,n=l.length,e,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t;for(e=0;e<n;e+=1)a[e>>2]|=l.charCodeAt(e)<<(e%4<<3);return this._finish(a,n),t=y(this._hash),o&&(t=O(t)),this.reset(),t},m.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},m.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},m.prototype.setState=function(o){return this._buff=o.buff,this._length=o.length,this._hash=o.hash,this},m.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},m.prototype._finish=function(o,l){var n=l,e,a,t;if(o[n>>2]|=128<<(n%4<<3),n>55)for(U(this._hash,o),n=0;n<16;n+=1)o[n]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),a=parseInt(e[2],16),t=parseInt(e[1],16)||0,o[14]=a,o[15]=t,U(this._hash,o)},m.hash=function(o,l){return m.hashBinary(u(o),l)},m.hashBinary=function(o,l){var n=x(o),e=y(n);return l?O(e):e},m.ArrayBuffer=function(){this.reset()},m.ArrayBuffer.prototype.append=function(o){var l=z(this._buff.buffer,o),n=l.length,e;for(this._length+=o.byteLength,e=64;e<=n;e+=64)U(this._hash,R(l.subarray(e-64,e)));return this._buff=e-64<n?new Uint8Array(l.buffer.slice(e-64)):new Uint8Array(0),this},m.ArrayBuffer.prototype.end=function(o){var l=this._buff,n=l.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a,t;for(a=0;a<n;a+=1)e[a>>2]|=l[a]<<(a%4<<3);return this._finish(e,n),t=y(this._hash),o&&(t=O(t)),this.reset(),t},m.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},m.ArrayBuffer.prototype.getState=function(){var o=m.prototype.getState.call(this);return o.buff=S(o.buff),o},m.ArrayBuffer.prototype.setState=function(o){return o.buff=T(o.buff,!0),m.prototype.setState.call(this,o)},m.ArrayBuffer.prototype.destroy=m.prototype.destroy,m.ArrayBuffer.prototype._finish=m.prototype._finish,m.ArrayBuffer.hash=function(o,l){var n=f(new Uint8Array(o)),e=y(n);return l?O(e):e},m})})(Se);var Lt=Se.exports;const Nt=Je(Lt),Ot={key:0,class:"drag-overlay"},jt={class:"upload-name"},Pt={class:"upload-status-text"},ke=5*1024*1024,Et=5*1024*1024,Kt={__name:"FileUpload",props:{folderId:{type:Number,default:0}},emits:["uploaded"],setup(d,{expose:M,emit:$}){const N=d,U=$,F=B(null),R=B(null),x=B(!1),f=B([]),g=B(!1);function y(){var t;(t=F.value)==null||t.click()}function u(){g.value=!0}function T(){g.value=!1}function S(t){g.value=!1;const r=Array.from(t.dataTransfer.files);r.length&&O(r)}function z(t){const r=Array.from(t.target.files);r.length&&O(r),F.value.value=""}async function O(t){var k,v;x.value=!0;const r=f.value.length;f.value.push(...t.map(C=>({name:C.name,progress:0,status:"",statusText:"等待中..."})));for(let C=0;C<t.length;C++){const w=r+C,E=t[C];try{E.size>Et?await o(E,w):await m(E,w),f.value[w].status="done",f.value[w].progress=100,f.value[w].statusText="上传完成"}catch(A){f.value[w].status="error";const K=((v=(k=A==null?void 0:A.response)==null?void 0:k.data)==null?void 0:v.message)||"上传失败";f.value[w].statusText=K,Z.error(`${E.name}: ${K}`)}}U("uploaded")}async function m(t,r){f.value[r].statusText="上传中...";const k=new FormData;k.append("file",t),k.append("folder_id",N.folderId),await ut(k,v=>{v.total&&(f.value[r].progress=Math.round(v.loaded/v.total*100))})}async function o(t,r){var K,Y,ne,se;f.value[r].statusText="计算文件指纹...";const k=await l(t,P=>{f.value[r].progress=Math.round(P*20)});let v="",C=0,w=ke,E=new Set;const A=e(t.name,t.size,k);if(A){f.value[r].statusText="检测到断点，校验任务状态...";try{v=A.uploadId,C=A.totalChunks;const P=await Ue(v);if(((K=P.data)==null?void 0:K.status)==="completed"){a(v),f.value[r].statusText="上传已完成",f.value[r].progress=100;return}(Y=P.data)!=null&&Y.uploaded_chunks&&P.data.uploaded_chunks.forEach(W=>E.add(W))}catch{a(v),v="",C=0,E=new Set}}if(!v){f.value[r].statusText="检查秒传...";const P=await dt({file_name:t.name,file_size:t.size,file_md5:k,folder_id:N.folderId});if(((ne=P.data)==null?void 0:ne.status)==="instant_upload"){f.value[r].statusText="秒传完成",f.value[r].progress=100;return}v=P.data.upload_id,C=P.data.total_chunks,w=P.data.chunk_size||ke,n(v,t.name,t.size,k,C);try{const W=await Ue(v);(se=W.data)!=null&&se.uploaded_chunks&&W.data.uploaded_chunks.forEach(re=>E.add(re))}catch{E=new Set}}f.value[r].statusText="分片上传中...";for(let P=0;P<C;P++){if(E.has(P))continue;const W=P*w,re=Math.min(W+w,t.size),me=t.slice(W,re),le=new FormData;le.append("upload_id",v),le.append("chunk_index",P),le.append("chunk",me),await ct(le);const ve=(P+1)/C*70;f.value[r].progress=Math.round(20+ve)}f.value[r].statusText="合并文件...",f.value[r].progress=90,await ft({upload_id:v}),f.value[r].progress=100,a(v)}function l(t,r){return new Promise((k,v)=>{const C=new Nt.ArrayBuffer,w=new FileReader,E=Math.ceil(t.size/(2*1024*1024));let A=0;w.onload=Y=>{C.append(Y.target.result),A++,r&&r(A/E),A<E?K():k(C.end())},w.onerror=()=>v(new Error("MD5计算失败"));function K(){const Y=A*2*1024*1024,ne=Math.min(Y+2*1024*1024,t.size);w.readAsArrayBuffer(t.slice(Y,ne))}K()})}function n(t,r,k,v,C){const w=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");w[t]={fileName:r,fileSize:k,md5:v,totalChunks:C,savedAt:Date.now()},localStorage.setItem("mcloud_upload_tasks",JSON.stringify(w))}function e(t,r,k){const v=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");for(const[C,w]of Object.entries(v))if(w.fileName===t&&w.fileSize===r&&w.md5===k)return{uploadId:C,totalChunks:w.totalChunks};return null}function a(t){const r=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");delete r[t],localStorage.setItem("mcloud_upload_tasks",JSON.stringify(r))}return $e(()=>{const t=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}"),r=Date.now();let k=!1;for(const[C,w]of Object.entries(t))r-w.savedAt>24*60*60*1e3&&(delete t[C],k=!0);k&&localStorage.setItem("mcloud_upload_tasks",JSON.stringify(t));const v=Object.keys(t).length;v>0&&Z.info(`检测到 ${v} 个未完成上传任务，请重新选择对应文件继续上传`)}),M({triggerUpload:y}),(t,r)=>{const k=I("el-progress"),v=I("el-button"),C=I("el-dialog");return b(),D("div",{ref_key:"dropZone",ref:R,class:ge(["upload-wrapper",{"drag-over":g.value}]),onDragover:Q(u,["prevent"]),onDragleave:Q(T,["prevent"]),onDrop:Q(S,["prevent"])},[V("input",{ref_key:"fileInput",ref:F,type:"file",multiple:"",hidden:"",onChange:z},null,544),g.value?(b(),D("div",Ot,"释放文件以上传")):G("",!0),c(C,{modelValue:x.value,"onUpdate:modelValue":r[1]||(r[1]=w=>x.value=w),title:"上传文件","close-on-click-modal":!1,width:"500px"},{footer:p(()=>[c(v,{onClick:r[0]||(r[0]=w=>x.value=!1)},{default:p(()=>[...r[2]||(r[2]=[H("关闭",-1)])]),_:1})]),default:p(()=>[(b(!0),D(oe,null,ce(f.value,(w,E)=>(b(),D("div",{key:E,class:"upload-item"},[V("div",jt,q(w.name),1),V("div",Pt,q(w.statusText),1),c(k,{percentage:w.progress,status:w.status==="error"?"exception":w.status==="done"?"success":""},null,8,["percentage","status"])]))),128))]),_:1},8,["modelValue"])],34)}}},Jt=ae(Kt,[["__scopeId","data-v-062db9f0"]]),Ht=["src"],qt={__name:"ImagePreview",props:{visible:{type:Boolean,default:!1},file:{type:Object,default:null}},emits:["update:visible"],setup(d,{emit:M}){const $=d,N=M,U=B(""),F=de({get:()=>$.visible,set:f=>N("update:visible",f)});function R(){U.value&&(URL.revokeObjectURL(U.value),U.value="")}async function x(){if(R(),!!$.file)try{const f=await bt($.file.id);U.value=URL.createObjectURL(f)}catch{U.value=""}}return ue(()=>{var f;return[$.visible,(f=$.file)==null?void 0:f.id]},([f])=>{f?x():R()},{immediate:!0}),He(()=>{R()}),(f,g)=>{var u;const y=I("el-dialog");return b(),X(y,{modelValue:F.value,"onUpdate:modelValue":g[2]||(g[2]=T=>F.value=T),title:(u=d.file)==null?void 0:u.original_name,fullscreen:"","append-to-body":""},{default:p(()=>[V("div",{class:"preview-container",onClick:g[1]||(g[1]=T=>F.value=!1)},[U.value?(b(),D("img",{key:0,src:U.value,class:"preview-image",onClick:g[0]||(g[0]=Q(()=>{},["stop"]))},null,8,Ht)):G("",!0)])]),_:1},8,["modelValue","title"])}}},Gt=ae(qt,[["__scopeId","data-v-f463ea88"]]),Zt=["onClick"],Xt={key:1},Yt={__name:"Breadcrumb",props:{items:{type:Array,default:()=>[]}},emits:["navigate"],setup(d,{emit:M}){const $=d,N=M;function U(F,R){const x=$.items.slice(0,R+1);N("navigate",{id:F.id,breadcrumbs:x})}return(F,R)=>{const x=I("el-breadcrumb-item"),f=I("el-breadcrumb");return b(),X(f,{separator:"/"},{default:p(()=>[(b(!0),D(oe,null,ce(d.items,(g,y)=>(b(),X(x,{key:g.id},{default:p(()=>[y<d.items.length-1?(b(),D("a",{key:0,href:"#",onClick:Q(u=>U(g,y),["prevent"])},q(g.name),9,Zt)):(b(),D("span",Xt,q(g.name),1))]),_:2},1024))),128))]),_:1})}}},Qt=ae(Yt,[["__scopeId","data-v-7d4131d2"]]);function Wt(d){return j.get("/recycle-bin",{params:d})}function en(d){return j.post(`/recycle-bin/${d}/restore`)}function tn(d){return j.delete(`/recycle-bin/${d}`)}function nn(){return j.post("/recycle-bin/empty")}const an={key:0,class:"empty"},ln={class:"item-info"},on={class:"item-actions"},sn={__name:"RecycleBin",props:{visible:{type:Boolean,default:!1}},emits:["update:visible","restored"],setup(d,{emit:M}){const $=d,N=M,U=de({get:()=>$.visible,set:y=>N("update:visible",y)}),F=B([]);async function R(){var y;try{const u=await Wt({page:1,page_size:50});F.value=((y=u.data)==null?void 0:y.items)||[]}catch{}}async function x(y){try{await en(y),Z.success("恢复成功"),R(),N("restored")}catch{}}async function f(y){try{await ie.confirm("永久删除后无法恢复，确定？","确认"),await tn(y),Z.success("已永久删除"),R()}catch{}}async function g(){try{await ie.confirm("确定清空回收站？此操作不可恢复","确认"),await nn(),Z.success("回收站已清空"),F.value=[]}catch{}}return ue(()=>$.visible,y=>{y&&R()}),(y,u)=>{const T=I("el-empty"),S=I("el-icon"),z=I("el-button"),O=I("el-drawer");return b(),X(O,{modelValue:U.value,"onUpdate:modelValue":u[0]||(u[0]=m=>U.value=m),title:"回收站",size:"400px"},{footer:p(()=>[c(z,{type:"danger",onClick:g,disabled:F.value.length===0},{default:p(()=>[...u[3]||(u[3]=[H("清空回收站",-1)])]),_:1},8,["disabled"])]),default:p(()=>[F.value.length===0?(b(),D("div",an,[c(T,{description:"回收站为空"})])):G("",!0),(b(!0),D(oe,null,ce(F.value,m=>(b(),D("div",{key:m.id,class:"recycle-item"},[V("div",ln,[c(S,null,{default:p(()=>[m.original_type==="file"?(b(),X(J(_e),{key:0})):(b(),X(J(pe),{key:1}))]),_:2},1024),V("span",null,q(m.original_name),1)]),V("div",on,[c(z,{size:"small",type:"primary",text:"",onClick:o=>x(m.id)},{default:p(()=>[...u[1]||(u[1]=[H("恢复",-1)])]),_:1},8,["onClick"]),c(z,{size:"small",type:"danger",text:"",onClick:o=>f(m.id)},{default:p(()=>[...u[2]||(u[2]=[H("删除",-1)])]),_:1},8,["onClick"])])]))),128))]),_:1},8,["modelValue"])}}},rn=ae(sn,[["__scopeId","data-v-70c3eeda"]]),un={class:"home-container"},dn={class:"header-left"},cn={class:"header-right"},fn={class:"user-info"},pn={class:"main-content"},mn={class:"content"},vn={__name:"Home",setup(d){const M=qe(),$=ye(),N=B(null),U=B(null),F=B(!0),R=B(!1),x=B(null),f=B(!1),g=B(!1),y=B("");async function u(){try{const e=await et();$.setUser(e.data),$.resetToRoot()}catch{M.push("/login")}}u();function T(e){$.setCurrentFolder(e.id,e.breadcrumbs)}function S(e){$.setCurrentFolder(e.id,e.breadcrumbs)}function z(e){x.value=e,R.value=!0}function O(){var e;(e=N.value)==null||e.loadFiles()}function m(){y.value="",g.value=!0}async function o(){if(!y.value.trim()){Z.warning("请输入文件夹名称");return}try{await tt({name:y.value.trim(),parent_id:$.currentFolderID}),Z.success("文件夹创建成功"),g.value=!1,O()}catch{}}function l(e){var a,t;e==="logout"?ie.confirm("确定退出登录？","提示").then(()=>{We(),$.clearUser(),M.push("/login")}).catch(()=>{}):e==="quota"&&Z.info(`已用 ${n((a=$.userInfo)==null?void 0:a.storage_used)} / ${n((t=$.userInfo)==null?void 0:t.storage_quota)}`)}function n(e){if(!e)return"0 B";const a=["B","KB","MB","GB","TB"],t=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,t)).toFixed(1)+" "+a[t]}return(e,a)=>{const t=I("el-button"),r=I("el-dropdown-item"),k=I("el-dropdown-menu"),v=I("el-dropdown"),C=I("el-header"),w=I("el-input"),E=I("el-dialog");return b(),D("div",un,[c(C,{class:"header"},{default:p(()=>[V("div",dn,[c(t,{class:"menu-btn",icon:J(Ge),onClick:a[0]||(a[0]=A=>F.value=!F.value)},null,8,["icon"]),a[8]||(a[8]=V("h3",null,"mCloud",-1))]),V("div",cn,[c(t,{type:"primary",icon:J(Ze),onClick:a[1]||(a[1]=A=>{var K;return(K=U.value)==null?void 0:K.triggerUpload()})},{default:p(()=>[...a[9]||(a[9]=[H("上传",-1)])]),_:1},8,["icon"]),c(t,{icon:J(Xe),onClick:m},{default:p(()=>[...a[10]||(a[10]=[H("新建文件夹",-1)])]),_:1},8,["icon"]),c(t,{icon:J(Ye),onClick:a[2]||(a[2]=A=>f.value=!0)},{default:p(()=>[...a[11]||(a[11]=[H("回收站",-1)])]),_:1},8,["icon"]),c(v,{onCommand:l},{dropdown:p(()=>[c(k,null,{default:p(()=>[c(r,{command:"quota"},{default:p(()=>[...a[12]||(a[12]=[H("存储空间",-1)])]),_:1}),c(r,{command:"logout",divided:""},{default:p(()=>[...a[13]||(a[13]=[H("退出登录",-1)])]),_:1})]),_:1})]),default:p(()=>{var A,K;return[V("span",fn,q(((A=J($).userInfo)==null?void 0:A.nickname)||((K=J($).userInfo)==null?void 0:K.username)),1)]}),_:1})])]),_:1}),V("div",pn,[V("aside",{class:ge(["sidebar",{visible:F.value}])},[c(st,{onSelect:T})],2),V("main",mn,[c(Qt,{items:J($).breadcrumbs,onNavigate:S},null,8,["items"]),c(Vt,{"folder-id":J($).currentFolderID,ref_key:"fileListRef",ref:N,onPreview:z},null,8,["folder-id"])])]),c(Jt,{ref_key:"uploadRef",ref:U,"folder-id":J($).currentFolderID,onUploaded:O},null,8,["folder-id"]),c(Gt,{visible:R.value,"onUpdate:visible":a[3]||(a[3]=A=>R.value=A),file:x.value},null,8,["visible","file"]),c(rn,{visible:f.value,"onUpdate:visible":a[4]||(a[4]=A=>f.value=A),onRestored:O},null,8,["visible"]),c(E,{modelValue:g.value,"onUpdate:modelValue":a[7]||(a[7]=A=>g.value=A),title:"新建文件夹",width:"400px"},{footer:p(()=>[c(t,{onClick:a[6]||(a[6]=A=>g.value=!1)},{default:p(()=>[...a[14]||(a[14]=[H("取消",-1)])]),_:1}),c(t,{type:"primary",onClick:o},{default:p(()=>[...a[15]||(a[15]=[H("创建",-1)])]),_:1})]),default:p(()=>[c(w,{modelValue:y.value,"onUpdate:modelValue":a[5]||(a[5]=A=>y.value=A),placeholder:"请输入文件夹名称",onKeyup:Qe(o,["enter"])},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}},gn=ae(vn,[["__scopeId","data-v-c8ef7c20"]]);export{gn as default};
