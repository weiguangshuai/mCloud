import{i as _e,r as x,o as g,c as B,b as D,a as u,w as c,j as N,k as ie,n as se,F as ee,l as oe,t as J,h as U,m as Ve,p as we,q as Te,f as E,v as q,x as Re,y as Ne,z as Le,A as Z,d as Y,B as pe,C as Ee,D as re,G as le,E as X,H as Oe,u as Pe,I as je,J as He,K as Je,L as Ke,e as qe,M as Ge}from"./index-BdJXkKq0.js";import{u as he}from"./index-uy2miP5O.js";import{a as O,_ as te,g as Ze}from"./_plugin-vue_export-helper-BYrSLrYK.js";function me(r=0){return O.get("/folders",{params:{parent_id:r}})}function Xe(r){return O.post("/folders",r)}function Ye(r,I){return O.put(`/folders/${r}`,I)}function Qe(r){return O.delete(`/folders/${r}`)}const We={class:"folder-tree"},et=["onClick"],tt={__name:"FolderTree",emits:["select"],setup(r,{emit:I}){const F=I,V=he(),A=U([]),k=U(0);async function S(d=0){try{const _=await me(d);A.value=_.data||[]}catch{}}function y(d,_){k.value=d;const p=[{id:0,name:"根目录"}];d!==0&&p.push({id:d,name:_}),F("select",{id:d,breadcrumbs:p})}return _e(()=>V.currentFolderID,d=>{S(d)},{immediate:!0}),(d,_)=>{const p=x("el-icon");return g(),B("div",We,[D("div",{class:se(["tree-item root",{active:k.value===0}]),onClick:_[0]||(_[0]=f=>y(0,"根目录"))},[u(p,null,{default:c(()=>[u(N(ie))]),_:1}),_[1]||(_[1]=D("span",null,"全部文件",-1))],2),(g(!0),B(ee,null,oe(A.value,f=>(g(),B("div",{key:f.id,class:se(["tree-item",{active:k.value===f.id}]),onClick:M=>y(f.id,f.name)},[u(p,null,{default:c(()=>[u(N(ie))]),_:1}),D("span",null,J(f.name),1)],10,et))),128))])}}},nt=te(tt,[["__scopeId","data-v-9f044e9f"]]);function at(r){return O.get("/files",{params:r})}function lt(r,I){return O.post("/files/upload",r,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:I})}function ot(r){return O.post("/files/upload/init",r)}function it(r,I){return O.post("/files/upload/chunk",r,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:I})}function st(r){return O.post("/files/upload/complete",r)}function rt(r){return O.get(`/files/upload/status/${r}`)}function ut(r){return`/api/files/${r}/download`}function dt(r){return`/api/files/${r}/preview`}function ct(r){return`/api/files/${r}/thumbnail`}function ve(){return{Authorization:`Bearer ${Ve()}`}}function ft(r){return O.delete(`/files/${r}`)}function pt(r,I){return O.put(`/files/${r}/rename`,{name:I})}function mt(r,I){return O.put(`/files/${r}/move`,{folder_id:I})}function vt(r){return O.post("/files/batch/delete",{file_ids:r})}function _t(r,I){return O.post("/files/batch/move",{file_ids:r,folder_id:I})}const ht={class:"file-list-container"},gt={key:0,class:"toolbar"},yt={class:"toolbar-left"},bt={class:"toolbar-right"},wt={key:1,class:"loading"},Ct={key:2,class:"grid-view"},$t=["onClick","onContextmenu"],Ft={class:"file-name"},At=["onClick","onContextmenu"],Bt=["src"],kt={class:"file-name"},St={class:"file-size"},Ut={class:"list-name-cell"},xt=["src"],It={key:4,class:"empty"},zt={__name:"FileList",props:{folderId:{type:Number,default:0}},emits:["preview"],setup(r,{expose:I,emit:F}){const V=r,A=F,k=he(),S=U(!1),y=U([]),d=U([]),_=U({page:1,page_size:20,total:0}),p=U("grid"),f=U({visible:!1,x:0,y:0,target:null,type:""}),M=U([]),K=U(!1),G=re(()=>M.value.length>0&&M.value.length<d.value.length),R=U(!1),m=U(null),o=U([]),l=U([]);function a(i){return i.file_object||{}}function e(i){const s=ve();return`${ct(i)}?token=${encodeURIComponent(s.Authorization.replace("Bearer ",""))}`}const t=re(()=>{const i=y.value.map($=>({...$,_type:"folder"})),s=d.value.map($=>{const T=a($);return{...$,_type:"file",_isImage:T.is_image,_fileSize:T.file_size}});return[...i,...s]});function n({row:i}){return i._type==="file"&&L("file",i.id)?"selected-row":""}async function v(){var i,s;S.value=!0,M.value=[],K.value=!1;try{const[$,T]=await Promise.all([me(V.folderId),at({folder_id:V.folderId,page:_.value.page,page_size:_.value.page_size})]);y.value=$.data||[],d.value=((i=T.data)==null?void 0:i.files)||[],(s=T.data)!=null&&s.pagination&&(_.value=T.data.pagination)}catch{}S.value=!1}function b(i){const s=[...k.breadcrumbs,{id:i.id,name:i.name}];k.setCurrentFolder(i.id,s)}function w(i){a(i).is_image&&A("preview",i)}function C(i){_.value.page=i,v()}function L(i,s){return M.value.some($=>$.type===i&&$.id===s)}function P(i,s){const $=M.value.findIndex(T=>T.type===i&&T.id===s);$>=0?M.value.splice($,1):M.value.push({type:i,id:s}),K.value=M.value.length===d.value.length}function z(i){i?M.value=d.value.map(s=>({type:"file",id:s.id})):M.value=[]}function H(i,s){f.value={visible:!0,x:i.clientX,y:i.clientY,target:s,type:"file"}}function j(i,s){f.value={visible:!0,x:i.clientX,y:i.clientY,target:s,type:"folder"}}function ne(i,s,$){$.preventDefault(),i._type==="file"?H($,i):j($,i)}function de(i){i._type==="folder"?b(i):a(i).is_image&&A("preview",i)}function ce(){if(f.value.type==="file"){const i=ut(f.value.target.id),s=ve(),$=document.createElement("a");$.href=`${i}?token=${encodeURIComponent(s.Authorization.replace("Bearer ",""))}`,$.download=f.value.target.original_name,$.click()}f.value.visible=!1}async function ae(){const i=f.value.target,s=f.value.type,$=s==="file"?i.original_name:i.name;f.value.visible=!1;try{const{value:T}=await le.prompt("输入新名称","重命名",{inputValue:$,inputValidator:Q=>Q&&Q.trim()?!0:"名称不能为空"});if(T.trim()===$)return;s==="file"?await pt(i.id,T.trim()):await Ye(i.id,{name:T.trim()}),X.success("重命名成功"),v()}catch{}}async function fe(){const i=f.value.target,s=f.value.type;f.value.visible=!1;try{await le.confirm(`确定删除 ${s==="file"?i.original_name:i.name}？`,"确认删除"),s==="file"?await ft(i.id):await Qe(i.id),X.success("已移到回收站"),v()}catch{}}async function $e(){const i=M.value.filter(s=>s.type==="file").map(s=>s.id);if(i.length)try{await le.confirm(`确定删除选中的 ${i.length} 个文件？`,"批量删除"),await vt(i),X.success("已移到回收站"),v()}catch{}}async function ge(){try{const i=await me(0);o.value=[{id:0,name:"根目录",children:i.data||[]}]}catch{o.value=[{id:0,name:"根目录",children:[]}]}}function Fe(){l.value=[f.value.target.id],f.value.visible=!1,m.value=null,ge(),R.value=!0}function Ae(){l.value=M.value.filter(i=>i.type==="file").map(i=>i.id),l.value.length&&(m.value=null,ge(),R.value=!0)}function Be(i){m.value=i.id}async function ke(){if(m.value!==null)try{l.value.length===1?await mt(l.value[0],m.value):await _t(l.value,m.value),X.success("移动成功"),R.value=!1,v()}catch{X.error("移动失败")}}function ye(){f.value.visible=!1}function be(i){if(!i)return"0 B";const s=["B","KB","MB","GB"],$=Math.floor(Math.log(i)/Math.log(1024));return(i/Math.pow(1024,$)).toFixed(1)+" "+s[$]}function Se(i){return i?new Date(i).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""}return _e(()=>V.folderId,()=>{_.value.page=1,v()},{immediate:!0}),we(()=>document.addEventListener("click",ye)),Te(()=>document.removeEventListener("click",ye)),I({loadFiles:v}),(i,s)=>{const $=x("el-checkbox"),T=x("el-button"),Q=x("el-icon"),Ue=x("el-button-group"),ue=x("el-table-column"),xe=x("el-table"),Ie=x("el-empty"),ze=x("el-pagination"),De=x("el-tree"),Me=x("el-dialog");return g(),B("div",ht,[!S.value&&(y.value.length>0||d.value.length>0||M.value.length>0)?(g(),B("div",gt,[D("div",yt,[u($,{modelValue:K.value,"onUpdate:modelValue":s[0]||(s[0]=h=>K.value=h),onChange:z,indeterminate:G.value},{default:c(()=>[...s[8]||(s[8]=[E("全选",-1)])]),_:1},8,["modelValue","indeterminate"]),M.value.length>0?(g(),B(ee,{key:0},[u(T,{size:"small",type:"danger",onClick:$e},{default:c(()=>[E("删除 ("+J(M.value.length)+")",1)]),_:1}),u(T,{size:"small",onClick:Ae},{default:c(()=>[E("移动 ("+J(M.value.length)+")",1)]),_:1})],64)):q("",!0)]),D("div",bt,[u(Ue,null,{default:c(()=>[u(T,{size:"small",type:p.value==="grid"?"primary":"",onClick:s[1]||(s[1]=h=>p.value="grid")},{default:c(()=>[u(Q,null,{default:c(()=>[u(N(Re))]),_:1})]),_:1},8,["type"]),u(T,{size:"small",type:p.value==="list"?"primary":"",onClick:s[2]||(s[2]=h=>p.value="list")},{default:c(()=>[u(Q,null,{default:c(()=>[u(N(Ne))]),_:1})]),_:1},8,["type"])]),_:1})])])):q("",!0),S.value?(g(),B("div",wt,[u(Q,{class:"is-loading"},{default:c(()=>[u(N(Le))]),_:1}),s[9]||(s[9]=E(" 加载中...",-1))])):q("",!0),p.value==="grid"?(g(),B("div",Ct,[(g(!0),B(ee,null,oe(y.value,h=>(g(),B("div",{key:"f-"+h.id,class:"file-item folder",onClick:W=>b(h),onContextmenu:Y(W=>j(W,h),["prevent"])},[u(Q,{size:48,color:"#f0c040"},{default:c(()=>[u(N(ie))]),_:1}),D("span",Ft,J(h.name),1)],40,$t))),128)),(g(!0),B(ee,null,oe(d.value,h=>(g(),B("div",{key:"file-"+h.id,class:se(["file-item",{selected:L("file",h.id)}]),onClick:[Y(W=>w(h),["exact"]),Y(W=>P("file",h.id),["ctrl"])],onContextmenu:Y(W=>H(W,h),["prevent"])},[u($,{class:"item-checkbox","model-value":L("file",h.id),onChange:W=>P("file",h.id),onClick:s[3]||(s[3]=Y(()=>{},["stop"]))},null,8,["model-value","onChange"]),a(h).is_image?(g(),B("img",{key:0,src:e(h.id),class:"thumbnail",loading:"lazy"},null,8,Bt)):(g(),Z(Q,{key:1,size:48,color:"#909399"},{default:c(()=>[u(N(pe))]),_:1})),D("span",kt,J(h.original_name),1),D("span",St,J(be(a(h).file_size)),1)],42,At))),128))])):q("",!0),p.value==="list"&&!S.value?(g(),Z(xe,{key:3,data:t.value,onRowContextmenu:ne,onRowClick:de,style:{width:"100%"},"row-class-name":n},{default:c(()=>[u(ue,{width:"40"},{header:c(()=>[u($,{modelValue:K.value,"onUpdate:modelValue":s[4]||(s[4]=h=>K.value=h),onChange:z,indeterminate:G.value},null,8,["modelValue","indeterminate"])]),default:c(({row:h})=>[h._type==="file"?(g(),Z($,{key:0,"model-value":L("file",h.id),onChange:W=>P("file",h.id),onClick:s[5]||(s[5]=Y(()=>{},["stop"]))},null,8,["model-value","onChange"])):q("",!0)]),_:1}),u(ue,{label:"名称","min-width":"200"},{default:c(({row:h})=>[D("div",Ut,[h._type==="folder"?(g(),Z(Q,{key:0,size:20,color:"#f0c040"},{default:c(()=>[u(N(ie))]),_:1})):h._isImage?(g(),B("img",{key:1,src:e(h.id),class:"list-thumb"},null,8,xt)):(g(),Z(Q,{key:2,size:20,color:"#909399"},{default:c(()=>[u(N(pe))]),_:1})),D("span",null,J(h._type==="folder"?h.name:h.original_name),1)])]),_:1}),u(ue,{label:"大小",width:"100"},{default:c(({row:h})=>[E(J(h._type==="file"?be(h._fileSize):"-"),1)]),_:1}),u(ue,{label:"修改时间",width:"170"},{default:c(({row:h})=>[E(J(Se(h.created_at||h.CreatedAt)),1)]),_:1})]),_:1},8,["data"])):q("",!0),!S.value&&y.value.length===0&&d.value.length===0?(g(),B("div",It,[u(Ie,{description:"暂无文件"})])):q("",!0),_.value.total>_.value.page_size?(g(),Z(ze,{key:5,"current-page":_.value.page,"page-size":_.value.page_size,total:_.value.total,layout:"prev, pager, next",onCurrentChange:C,class:"pagination"},null,8,["current-page","page-size","total"])):q("",!0),f.value.visible?(g(),B("div",{key:6,class:"context-menu",style:Ee({left:f.value.x+"px",top:f.value.y+"px"})},[f.value.type==="file"?(g(),B("div",{key:0,class:"menu-item",onClick:ce},"下载")):q("",!0),D("div",{class:"menu-item",onClick:ae},"重命名"),f.value.type==="file"?(g(),B("div",{key:1,class:"menu-item",onClick:Fe},"移动")):q("",!0),D("div",{class:"menu-item menu-item-danger",onClick:fe},"删除")],4)):q("",!0),u(Me,{modelValue:R.value,"onUpdate:modelValue":s[7]||(s[7]=h=>R.value=h),title:"移动到",width:"400px"},{footer:c(()=>[u(T,{onClick:s[6]||(s[6]=h=>R.value=!1)},{default:c(()=>[...s[10]||(s[10]=[E("取消",-1)])]),_:1}),u(T,{type:"primary",onClick:ke,disabled:m.value===null},{default:c(()=>[...s[11]||(s[11]=[E("确定",-1)])]),_:1},8,["disabled"])]),default:c(()=>[u(De,{data:o.value,props:{label:"name",children:"children"},"node-key":"id","highlight-current":"",onNodeClick:Be},null,8,["data"])]),_:1},8,["modelValue"])])}}},Dt=te(zt,[["__scopeId","data-v-0b8c883d"]]);var Ce={exports:{}};(function(r,I){(function(F){r.exports=F()})(function(F){var V=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function A(o,l){var a=o[0],e=o[1],t=o[2],n=o[3];a+=(e&t|~e&n)+l[0]-680876936|0,a=(a<<7|a>>>25)+e|0,n+=(a&e|~a&t)+l[1]-389564586|0,n=(n<<12|n>>>20)+a|0,t+=(n&a|~n&e)+l[2]+606105819|0,t=(t<<17|t>>>15)+n|0,e+=(t&n|~t&a)+l[3]-1044525330|0,e=(e<<22|e>>>10)+t|0,a+=(e&t|~e&n)+l[4]-176418897|0,a=(a<<7|a>>>25)+e|0,n+=(a&e|~a&t)+l[5]+1200080426|0,n=(n<<12|n>>>20)+a|0,t+=(n&a|~n&e)+l[6]-1473231341|0,t=(t<<17|t>>>15)+n|0,e+=(t&n|~t&a)+l[7]-45705983|0,e=(e<<22|e>>>10)+t|0,a+=(e&t|~e&n)+l[8]+1770035416|0,a=(a<<7|a>>>25)+e|0,n+=(a&e|~a&t)+l[9]-1958414417|0,n=(n<<12|n>>>20)+a|0,t+=(n&a|~n&e)+l[10]-42063|0,t=(t<<17|t>>>15)+n|0,e+=(t&n|~t&a)+l[11]-1990404162|0,e=(e<<22|e>>>10)+t|0,a+=(e&t|~e&n)+l[12]+1804603682|0,a=(a<<7|a>>>25)+e|0,n+=(a&e|~a&t)+l[13]-40341101|0,n=(n<<12|n>>>20)+a|0,t+=(n&a|~n&e)+l[14]-1502002290|0,t=(t<<17|t>>>15)+n|0,e+=(t&n|~t&a)+l[15]+1236535329|0,e=(e<<22|e>>>10)+t|0,a+=(e&n|t&~n)+l[1]-165796510|0,a=(a<<5|a>>>27)+e|0,n+=(a&t|e&~t)+l[6]-1069501632|0,n=(n<<9|n>>>23)+a|0,t+=(n&e|a&~e)+l[11]+643717713|0,t=(t<<14|t>>>18)+n|0,e+=(t&a|n&~a)+l[0]-373897302|0,e=(e<<20|e>>>12)+t|0,a+=(e&n|t&~n)+l[5]-701558691|0,a=(a<<5|a>>>27)+e|0,n+=(a&t|e&~t)+l[10]+38016083|0,n=(n<<9|n>>>23)+a|0,t+=(n&e|a&~e)+l[15]-660478335|0,t=(t<<14|t>>>18)+n|0,e+=(t&a|n&~a)+l[4]-405537848|0,e=(e<<20|e>>>12)+t|0,a+=(e&n|t&~n)+l[9]+568446438|0,a=(a<<5|a>>>27)+e|0,n+=(a&t|e&~t)+l[14]-1019803690|0,n=(n<<9|n>>>23)+a|0,t+=(n&e|a&~e)+l[3]-187363961|0,t=(t<<14|t>>>18)+n|0,e+=(t&a|n&~a)+l[8]+1163531501|0,e=(e<<20|e>>>12)+t|0,a+=(e&n|t&~n)+l[13]-1444681467|0,a=(a<<5|a>>>27)+e|0,n+=(a&t|e&~t)+l[2]-51403784|0,n=(n<<9|n>>>23)+a|0,t+=(n&e|a&~e)+l[7]+1735328473|0,t=(t<<14|t>>>18)+n|0,e+=(t&a|n&~a)+l[12]-1926607734|0,e=(e<<20|e>>>12)+t|0,a+=(e^t^n)+l[5]-378558|0,a=(a<<4|a>>>28)+e|0,n+=(a^e^t)+l[8]-2022574463|0,n=(n<<11|n>>>21)+a|0,t+=(n^a^e)+l[11]+1839030562|0,t=(t<<16|t>>>16)+n|0,e+=(t^n^a)+l[14]-35309556|0,e=(e<<23|e>>>9)+t|0,a+=(e^t^n)+l[1]-1530992060|0,a=(a<<4|a>>>28)+e|0,n+=(a^e^t)+l[4]+1272893353|0,n=(n<<11|n>>>21)+a|0,t+=(n^a^e)+l[7]-155497632|0,t=(t<<16|t>>>16)+n|0,e+=(t^n^a)+l[10]-1094730640|0,e=(e<<23|e>>>9)+t|0,a+=(e^t^n)+l[13]+681279174|0,a=(a<<4|a>>>28)+e|0,n+=(a^e^t)+l[0]-358537222|0,n=(n<<11|n>>>21)+a|0,t+=(n^a^e)+l[3]-722521979|0,t=(t<<16|t>>>16)+n|0,e+=(t^n^a)+l[6]+76029189|0,e=(e<<23|e>>>9)+t|0,a+=(e^t^n)+l[9]-640364487|0,a=(a<<4|a>>>28)+e|0,n+=(a^e^t)+l[12]-421815835|0,n=(n<<11|n>>>21)+a|0,t+=(n^a^e)+l[15]+530742520|0,t=(t<<16|t>>>16)+n|0,e+=(t^n^a)+l[2]-995338651|0,e=(e<<23|e>>>9)+t|0,a+=(t^(e|~n))+l[0]-198630844|0,a=(a<<6|a>>>26)+e|0,n+=(e^(a|~t))+l[7]+1126891415|0,n=(n<<10|n>>>22)+a|0,t+=(a^(n|~e))+l[14]-1416354905|0,t=(t<<15|t>>>17)+n|0,e+=(n^(t|~a))+l[5]-57434055|0,e=(e<<21|e>>>11)+t|0,a+=(t^(e|~n))+l[12]+1700485571|0,a=(a<<6|a>>>26)+e|0,n+=(e^(a|~t))+l[3]-1894986606|0,n=(n<<10|n>>>22)+a|0,t+=(a^(n|~e))+l[10]-1051523|0,t=(t<<15|t>>>17)+n|0,e+=(n^(t|~a))+l[1]-2054922799|0,e=(e<<21|e>>>11)+t|0,a+=(t^(e|~n))+l[8]+1873313359|0,a=(a<<6|a>>>26)+e|0,n+=(e^(a|~t))+l[15]-30611744|0,n=(n<<10|n>>>22)+a|0,t+=(a^(n|~e))+l[6]-1560198380|0,t=(t<<15|t>>>17)+n|0,e+=(n^(t|~a))+l[13]+1309151649|0,e=(e<<21|e>>>11)+t|0,a+=(t^(e|~n))+l[4]-145523070|0,a=(a<<6|a>>>26)+e|0,n+=(e^(a|~t))+l[11]-1120210379|0,n=(n<<10|n>>>22)+a|0,t+=(a^(n|~e))+l[2]+718787259|0,t=(t<<15|t>>>17)+n|0,e+=(n^(t|~a))+l[9]-343485551|0,e=(e<<21|e>>>11)+t|0,o[0]=a+o[0]|0,o[1]=e+o[1]|0,o[2]=t+o[2]|0,o[3]=n+o[3]|0}function k(o){var l=[],a;for(a=0;a<64;a+=4)l[a>>2]=o.charCodeAt(a)+(o.charCodeAt(a+1)<<8)+(o.charCodeAt(a+2)<<16)+(o.charCodeAt(a+3)<<24);return l}function S(o){var l=[],a;for(a=0;a<64;a+=4)l[a>>2]=o[a]+(o[a+1]<<8)+(o[a+2]<<16)+(o[a+3]<<24);return l}function y(o){var l=o.length,a=[1732584193,-271733879,-1732584194,271733878],e,t,n,v,b,w;for(e=64;e<=l;e+=64)A(a,k(o.substring(e-64,e)));for(o=o.substring(e-64),t=o.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<t;e+=1)n[e>>2]|=o.charCodeAt(e)<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(A(a,n),e=0;e<16;e+=1)n[e]=0;return v=l*8,v=v.toString(16).match(/(.*?)(.{0,8})$/),b=parseInt(v[2],16),w=parseInt(v[1],16)||0,n[14]=b,n[15]=w,A(a,n),a}function d(o){var l=o.length,a=[1732584193,-271733879,-1732584194,271733878],e,t,n,v,b,w;for(e=64;e<=l;e+=64)A(a,S(o.subarray(e-64,e)));for(o=e-64<l?o.subarray(e-64):new Uint8Array(0),t=o.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<t;e+=1)n[e>>2]|=o[e]<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(A(a,n),e=0;e<16;e+=1)n[e]=0;return v=l*8,v=v.toString(16).match(/(.*?)(.{0,8})$/),b=parseInt(v[2],16),w=parseInt(v[1],16)||0,n[14]=b,n[15]=w,A(a,n),a}function _(o){var l="",a;for(a=0;a<4;a+=1)l+=V[o>>a*8+4&15]+V[o>>a*8&15];return l}function p(o){var l;for(l=0;l<o.length;l+=1)o[l]=_(o[l]);return o.join("")}p(y("hello")),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function o(l,a){return l=l|0||0,l<0?Math.max(l+a,0):Math.min(l,a)}ArrayBuffer.prototype.slice=function(l,a){var e=this.byteLength,t=o(l,e),n=e,v,b,w,C;return a!==F&&(n=o(a,e)),t>n?new ArrayBuffer(0):(v=n-t,b=new ArrayBuffer(v),w=new Uint8Array(b),C=new Uint8Array(this,t,v),w.set(C),b)}}();function f(o){return/[\u0080-\uFFFF]/.test(o)&&(o=unescape(encodeURIComponent(o))),o}function M(o,l){var a=o.length,e=new ArrayBuffer(a),t=new Uint8Array(e),n;for(n=0;n<a;n+=1)t[n]=o.charCodeAt(n);return l?t:e}function K(o){return String.fromCharCode.apply(null,new Uint8Array(o))}function G(o,l,a){var e=new Uint8Array(o.byteLength+l.byteLength);return e.set(new Uint8Array(o)),e.set(new Uint8Array(l),o.byteLength),e}function R(o){var l=[],a=o.length,e;for(e=0;e<a-1;e+=2)l.push(parseInt(o.substr(e,2),16));return String.fromCharCode.apply(String,l)}function m(){this.reset()}return m.prototype.append=function(o){return this.appendBinary(f(o)),this},m.prototype.appendBinary=function(o){this._buff+=o,this._length+=o.length;var l=this._buff.length,a;for(a=64;a<=l;a+=64)A(this._hash,k(this._buff.substring(a-64,a)));return this._buff=this._buff.substring(a-64),this},m.prototype.end=function(o){var l=this._buff,a=l.length,e,t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n;for(e=0;e<a;e+=1)t[e>>2]|=l.charCodeAt(e)<<(e%4<<3);return this._finish(t,a),n=p(this._hash),o&&(n=R(n)),this.reset(),n},m.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},m.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},m.prototype.setState=function(o){return this._buff=o.buff,this._length=o.length,this._hash=o.hash,this},m.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},m.prototype._finish=function(o,l){var a=l,e,t,n;if(o[a>>2]|=128<<(a%4<<3),a>55)for(A(this._hash,o),a=0;a<16;a+=1)o[a]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),t=parseInt(e[2],16),n=parseInt(e[1],16)||0,o[14]=t,o[15]=n,A(this._hash,o)},m.hash=function(o,l){return m.hashBinary(f(o),l)},m.hashBinary=function(o,l){var a=y(o),e=p(a);return l?R(e):e},m.ArrayBuffer=function(){this.reset()},m.ArrayBuffer.prototype.append=function(o){var l=G(this._buff.buffer,o),a=l.length,e;for(this._length+=o.byteLength,e=64;e<=a;e+=64)A(this._hash,S(l.subarray(e-64,e)));return this._buff=e-64<a?new Uint8Array(l.buffer.slice(e-64)):new Uint8Array(0),this},m.ArrayBuffer.prototype.end=function(o){var l=this._buff,a=l.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t,n;for(t=0;t<a;t+=1)e[t>>2]|=l[t]<<(t%4<<3);return this._finish(e,a),n=p(this._hash),o&&(n=R(n)),this.reset(),n},m.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},m.ArrayBuffer.prototype.getState=function(){var o=m.prototype.getState.call(this);return o.buff=K(o.buff),o},m.ArrayBuffer.prototype.setState=function(o){return o.buff=M(o.buff,!0),m.prototype.setState.call(this,o)},m.ArrayBuffer.prototype.destroy=m.prototype.destroy,m.ArrayBuffer.prototype._finish=m.prototype._finish,m.ArrayBuffer.hash=function(o,l){var a=d(new Uint8Array(o)),e=p(a);return l?R(e):e},m})})(Ce);var Mt=Ce.exports;const Vt=Oe(Mt),Tt={key:0,class:"drag-overlay"},Rt={class:"upload-name"},Nt={class:"upload-status-text"},Lt=5*1024*1024,Et=5*1024*1024,Ot={__name:"FileUpload",props:{folderId:{type:Number,default:0}},emits:["uploaded"],setup(r,{expose:I,emit:F}){const V=r,A=F,k=U(null),S=U(null),y=U(!1),d=U([]),_=U(!1);function p(){var t;(t=k.value)==null||t.click()}function f(){_.value=!0}function M(){_.value=!1}function K(t){_.value=!1;const n=Array.from(t.dataTransfer.files);n.length&&R(n)}function G(t){const n=Array.from(t.target.files);n.length&&R(n),k.value.value=""}async function R(t){var v,b;y.value=!0;const n=d.value.length;d.value.push(...t.map(w=>({name:w.name,progress:0,status:"",statusText:"等待中..."})));for(let w=0;w<t.length;w++){const C=n+w,L=t[w];try{L.size>Et?await o(L,C):await m(L,C),d.value[C].status="done",d.value[C].progress=100,d.value[C].statusText="上传完成"}catch(P){d.value[C].status="error";const z=((b=(v=P==null?void 0:P.response)==null?void 0:v.data)==null?void 0:b.message)||"上传失败";d.value[C].statusText=z,X.error(`${L.name}: ${z}`)}}A("uploaded")}async function m(t,n){d.value[n].statusText="上传中...";const v=new FormData;v.append("file",t),v.append("folder_id",V.folderId),await lt(v,b=>{b.total&&(d.value[n].progress=Math.round(b.loaded/b.total*100))})}async function o(t,n){var z,H;d.value[n].statusText="计算文件指纹...";const v=await l(t,j=>{d.value[n].progress=Math.round(j*20)});d.value[n].statusText="检查秒传...";const b=await ot({file_name:t.name,file_size:t.size,file_md5:v,folder_id:V.folderId});if(((z=b.data)==null?void 0:z.status)==="instant_upload"){d.value[n].statusText="秒传完成";return}const w=b.data.upload_id,C=b.data.total_chunks,L=b.data.chunk_size||Lt;a(w,t.name,t.size,v,C);let P=new Set;try{const j=await rt(w);(H=j.data)!=null&&H.uploaded_chunks&&j.data.uploaded_chunks.forEach(ne=>P.add(ne))}catch{}d.value[n].statusText="分片上传中...";for(let j=0;j<C;j++){if(P.has(j))continue;const ne=j*L,de=Math.min(ne+L,t.size),ce=t.slice(ne,de),ae=new FormData;ae.append("upload_id",w),ae.append("chunk_index",j),ae.append("chunk",ce),await it(ae);const fe=(j+1)/C*70;d.value[n].progress=Math.round(20+fe)}d.value[n].statusText="合并文件...",d.value[n].progress=90,await st({upload_id:w}),d.value[n].progress=100,e(w)}function l(t,n){return new Promise((v,b)=>{const w=new Vt.ArrayBuffer,C=new FileReader,L=Math.ceil(t.size/(2*1024*1024));let P=0;C.onload=H=>{w.append(H.target.result),P++,n&&n(P/L),P<L?z():v(w.end())},C.onerror=()=>b(new Error("MD5计算失败"));function z(){const H=P*2*1024*1024,j=Math.min(H+2*1024*1024,t.size);C.readAsArrayBuffer(t.slice(H,j))}z()})}function a(t,n,v,b,w){const C=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");C[t]={fileName:n,fileSize:v,md5:b,totalChunks:w,savedAt:Date.now()},localStorage.setItem("mcloud_upload_tasks",JSON.stringify(C))}function e(t){const n=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}");delete n[t],localStorage.setItem("mcloud_upload_tasks",JSON.stringify(n))}return we(()=>{const t=JSON.parse(localStorage.getItem("mcloud_upload_tasks")||"{}"),n=Date.now();let v=!1;for(const[b,w]of Object.entries(t))n-w.savedAt>24*60*60*1e3&&(delete t[b],v=!0);v&&localStorage.setItem("mcloud_upload_tasks",JSON.stringify(t))}),I({triggerUpload:p}),(t,n)=>{const v=x("el-progress"),b=x("el-button"),w=x("el-dialog");return g(),B("div",{ref_key:"dropZone",ref:S,class:se(["upload-wrapper",{"drag-over":_.value}]),onDragover:Y(f,["prevent"]),onDragleave:Y(M,["prevent"]),onDrop:Y(K,["prevent"])},[D("input",{ref_key:"fileInput",ref:k,type:"file",multiple:"",hidden:"",onChange:G},null,544),_.value?(g(),B("div",Tt,"释放文件以上传")):q("",!0),u(w,{modelValue:y.value,"onUpdate:modelValue":n[1]||(n[1]=C=>y.value=C),title:"上传文件","close-on-click-modal":!1,width:"500px"},{footer:c(()=>[u(b,{onClick:n[0]||(n[0]=C=>y.value=!1)},{default:c(()=>[...n[2]||(n[2]=[E("关闭",-1)])]),_:1})]),default:c(()=>[(g(!0),B(ee,null,oe(d.value,(C,L)=>(g(),B("div",{key:L,class:"upload-item"},[D("div",Rt,J(C.name),1),D("div",Nt,J(C.statusText),1),u(v,{percentage:C.progress,status:C.status==="error"?"exception":C.status==="done"?"success":""},null,8,["percentage","status"])]))),128))]),_:1},8,["modelValue"])],34)}}},Pt=te(Ot,[["__scopeId","data-v-45487e2e"]]),jt=["src"],Ht={__name:"ImagePreview",props:{visible:{type:Boolean,default:!1},file:{type:Object,default:null}},emits:["update:visible"],setup(r,{emit:I}){const F=r,V=I,A=re({get:()=>F.visible,set:S=>V("update:visible",S)}),k=re(()=>{if(!F.file)return"";const y=ve().Authorization.replace("Bearer ","");return`${dt(F.file.id)}?token=${encodeURIComponent(y)}`});return(S,y)=>{var _;const d=x("el-dialog");return g(),Z(d,{modelValue:A.value,"onUpdate:modelValue":y[2]||(y[2]=p=>A.value=p),title:(_=r.file)==null?void 0:_.original_name,fullscreen:"","append-to-body":""},{default:c(()=>[D("div",{class:"preview-container",onClick:y[1]||(y[1]=p=>A.value=!1)},[r.file?(g(),B("img",{key:0,src:k.value,class:"preview-image",onClick:y[0]||(y[0]=Y(()=>{},["stop"]))},null,8,jt)):q("",!0)])]),_:1},8,["modelValue","title"])}}},Jt=te(Ht,[["__scopeId","data-v-672e58e0"]]),Kt=["onClick"],qt={key:1},Gt={__name:"Breadcrumb",props:{items:{type:Array,default:()=>[]}},emits:["navigate"],setup(r,{emit:I}){const F=r,V=I;function A(k,S){const y=F.items.slice(0,S+1);V("navigate",{id:k.id,breadcrumbs:y})}return(k,S)=>{const y=x("el-breadcrumb-item"),d=x("el-breadcrumb");return g(),Z(d,{separator:"/"},{default:c(()=>[(g(!0),B(ee,null,oe(r.items,(_,p)=>(g(),Z(y,{key:_.id},{default:c(()=>[p<r.items.length-1?(g(),B("a",{key:0,href:"#",onClick:Y(f=>A(_,p),["prevent"])},J(_.name),9,Kt)):(g(),B("span",qt,J(_.name),1))]),_:2},1024))),128))]),_:1})}}},Zt=te(Gt,[["__scopeId","data-v-a839e2ec"]]);function Xt(r){return O.get("/recycle-bin",{params:r})}function Yt(r){return O.post(`/recycle-bin/${r}/restore`)}function Qt(r){return O.delete(`/recycle-bin/${r}`)}function Wt(){return O.post("/recycle-bin/empty")}const en={key:0,class:"empty"},tn={class:"item-info"},nn={class:"item-actions"},an={__name:"RecycleBin",props:{visible:{type:Boolean,default:!1}},emits:["update:visible","restored"],setup(r,{emit:I}){const F=r,V=I,A=re({get:()=>F.visible,set:p=>V("update:visible",p)}),k=U([]);async function S(){var p;try{const f=await Xt({page:1,page_size:50});k.value=((p=f.data)==null?void 0:p.items)||[]}catch{}}async function y(p){try{await Yt(p),X.success("恢复成功"),S(),V("restored")}catch{}}async function d(p){try{await le.confirm("永久删除后无法恢复，确定？","确认"),await Qt(p),X.success("已永久删除"),S()}catch{}}async function _(){try{await le.confirm("确定清空回收站？此操作不可恢复","确认"),await Wt(),X.success("回收站已清空"),k.value=[]}catch{}}return _e(()=>F.visible,p=>{p&&S()}),(p,f)=>{const M=x("el-empty"),K=x("el-icon"),G=x("el-button"),R=x("el-drawer");return g(),Z(R,{modelValue:A.value,"onUpdate:modelValue":f[0]||(f[0]=m=>A.value=m),title:"回收站",size:"400px"},{footer:c(()=>[u(G,{type:"danger",onClick:_,disabled:k.value.length===0},{default:c(()=>[...f[3]||(f[3]=[E("清空回收站",-1)])]),_:1},8,["disabled"])]),default:c(()=>[k.value.length===0?(g(),B("div",en,[u(M,{description:"回收站为空"})])):q("",!0),(g(!0),B(ee,null,oe(k.value,m=>(g(),B("div",{key:m.id,class:"recycle-item"},[D("div",tn,[u(K,null,{default:c(()=>[m.original_type==="file"?(g(),Z(N(pe),{key:0})):(g(),Z(N(ie),{key:1}))]),_:2},1024),D("span",null,J(m.original_name),1)]),D("div",nn,[u(G,{size:"small",type:"primary",text:"",onClick:o=>y(m.id)},{default:c(()=>[...f[1]||(f[1]=[E("恢复",-1)])]),_:1},8,["onClick"]),u(G,{size:"small",type:"danger",text:"",onClick:o=>d(m.id)},{default:c(()=>[...f[2]||(f[2]=[E("删除",-1)])]),_:1},8,["onClick"])])]))),128))]),_:1},8,["modelValue"])}}},ln=te(an,[["__scopeId","data-v-a26da451"]]),on={class:"home-container"},sn={class:"header-left"},rn={class:"header-right"},un={class:"user-info"},dn={class:"main-content"},cn={class:"content"},fn={__name:"Home",setup(r){const I=Pe(),F=he(),V=U(null),A=U(null),k=U(!0),S=U(!1),y=U(null),d=U(!1),_=U(!1),p=U("");async function f(){try{const e=await Ze();F.setUser(e.data)}catch{I.push("/login")}}f();function M(e){F.setCurrentFolder(e.id,e.breadcrumbs)}function K(e){F.setCurrentFolder(e.id,e.breadcrumbs)}function G(e){y.value=e,S.value=!0}function R(){var e;(e=V.value)==null||e.loadFiles()}function m(){p.value="",_.value=!0}async function o(){if(!p.value.trim()){X.warning("请输入文件夹名称");return}try{await Xe({name:p.value.trim(),parent_id:F.currentFolderID}),X.success("文件夹创建成功"),_.value=!1,R()}catch{}}function l(e){var t,n;e==="logout"?le.confirm("确定退出登录？","提示").then(()=>{Ge(),F.clearUser(),I.push("/login")}).catch(()=>{}):e==="quota"&&X.info(`已用 ${a((t=F.userInfo)==null?void 0:t.storage_used)} / ${a((n=F.userInfo)==null?void 0:n.storage_quota)}`)}function a(e){if(!e)return"0 B";const t=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,n)).toFixed(1)+" "+t[n]}return(e,t)=>{const n=x("el-button"),v=x("el-dropdown-item"),b=x("el-dropdown-menu"),w=x("el-dropdown"),C=x("el-header"),L=x("el-input"),P=x("el-dialog");return g(),B("div",on,[u(C,{class:"header"},{default:c(()=>[D("div",sn,[u(n,{class:"menu-btn",icon:N(je),onClick:t[0]||(t[0]=z=>k.value=!k.value)},null,8,["icon"]),t[8]||(t[8]=D("h3",null,"mCloud",-1))]),D("div",rn,[u(n,{type:"primary",icon:N(He),onClick:t[1]||(t[1]=z=>{var H;return(H=A.value)==null?void 0:H.triggerUpload()})},{default:c(()=>[...t[9]||(t[9]=[E("上传",-1)])]),_:1},8,["icon"]),u(n,{icon:N(Je),onClick:m},{default:c(()=>[...t[10]||(t[10]=[E("新建文件夹",-1)])]),_:1},8,["icon"]),u(n,{icon:N(Ke),onClick:t[2]||(t[2]=z=>d.value=!0)},{default:c(()=>[...t[11]||(t[11]=[E("回收站",-1)])]),_:1},8,["icon"]),u(w,{onCommand:l},{dropdown:c(()=>[u(b,null,{default:c(()=>[u(v,{command:"quota"},{default:c(()=>[...t[12]||(t[12]=[E("存储空间",-1)])]),_:1}),u(v,{command:"logout",divided:""},{default:c(()=>[...t[13]||(t[13]=[E("退出登录",-1)])]),_:1})]),_:1})]),default:c(()=>{var z,H;return[D("span",un,J(((z=N(F).userInfo)==null?void 0:z.nickname)||((H=N(F).userInfo)==null?void 0:H.username)),1)]}),_:1})])]),_:1}),D("div",dn,[D("aside",{class:se(["sidebar",{visible:k.value}])},[u(nt,{onSelect:M})],2),D("main",cn,[u(Zt,{items:N(F).breadcrumbs,onNavigate:K},null,8,["items"]),u(Dt,{"folder-id":N(F).currentFolderID,ref_key:"fileListRef",ref:V,onPreview:G},null,8,["folder-id"])])]),u(Pt,{ref_key:"uploadRef",ref:A,"folder-id":N(F).currentFolderID,onUploaded:R},null,8,["folder-id"]),u(Jt,{visible:S.value,"onUpdate:visible":t[3]||(t[3]=z=>S.value=z),file:y.value},null,8,["visible","file"]),u(ln,{visible:d.value,"onUpdate:visible":t[4]||(t[4]=z=>d.value=z),onRestored:R},null,8,["visible"]),u(P,{modelValue:_.value,"onUpdate:modelValue":t[7]||(t[7]=z=>_.value=z),title:"新建文件夹",width:"400px"},{footer:c(()=>[u(n,{onClick:t[6]||(t[6]=z=>_.value=!1)},{default:c(()=>[...t[14]||(t[14]=[E("取消",-1)])]),_:1}),u(n,{type:"primary",onClick:o},{default:c(()=>[...t[15]||(t[15]=[E("创建",-1)])]),_:1})]),default:c(()=>[u(L,{modelValue:p.value,"onUpdate:modelValue":t[5]||(t[5]=z=>p.value=z),placeholder:"请输入文件夹名称",onKeyup:qe(o,["enter"])},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}},_n=te(fn,[["__scopeId","data-v-ad8adf96"]]);export{_n as default};
