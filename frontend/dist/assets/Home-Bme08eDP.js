import{i as ee,r as y,o as r,c as _,b,a as s,w as u,j as x,k as j,n as Q,F as q,l as H,t as D,h as w,m as oe,p as ae,q as se,v as ie,f as V,x as E,y as S,z as re,A as X,E as T,d as Y,B as ne,C as W,u as ue,D as de,G as ce,H as pe,I as me,e as fe,J as ve}from"./index-5DOvWKRT.js";import{u as te}from"./index-BdKAYsRC.js";import{a as R,_ as P,g as _e}from"./_plugin-vue_export-helper-CeHH__RJ.js";function le(n=0){return R.get("/folders",{params:{parent_id:n}})}function ge(n){return R.post("/folders",n)}function ye(n){return R.delete(`/folders/${n}`)}const be={class:"folder-tree"},ke=["onClick"],we={__name:"FolderTree",emits:["select"],setup(n,{emit:C}){const d=C,$=te(),h=w([]),p=w(0);async function c(m=0){try{const o=await le(m);h.value=o.data||[]}catch{}}function i(m,o){p.value=m;const e=[{id:0,name:"根目录"}];m!==0&&e.push({id:m,name:o}),d("select",{id:m,breadcrumbs:e})}return ee(()=>$.currentFolderID,m=>{c(m)},{immediate:!0}),(m,o)=>{const e=y("el-icon");return r(),_("div",be,[b("div",{class:Q(["tree-item root",{active:p.value===0}]),onClick:o[0]||(o[0]=a=>i(0,"根目录"))},[s(e,null,{default:u(()=>[s(x(j))]),_:1}),o[1]||(o[1]=b("span",null,"全部文件",-1))],2),(r(!0),_(q,null,H(h.value,a=>(r(),_("div",{key:a.id,class:Q(["tree-item",{active:p.value===a.id}]),onClick:g=>i(a.id,a.name)},[s(e,null,{default:u(()=>[s(x(j))]),_:1}),b("span",null,D(a.name),1)],10,ke))),128))])}}},he=P(we,[["__scopeId","data-v-9f044e9f"]]);function $e(n){return R.get("/files",{params:n})}function Ce(n,C){return R.post("/files/upload",n,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:C})}function Fe(n){return`/api/files/${n}/download`}function xe(n){return`/api/files/${n}/preview`}function Ie(n){return`/api/files/${n}/thumbnail`}function Z(){return{Authorization:`Bearer ${oe()}`}}function Be(n){return R.delete(`/files/${n}`)}const ze={class:"file-list"},Ue={key:0,class:"loading"},Ve=["onClick","onContextmenu"],Me={class:"file-name"},Re=["onClick","onContextmenu"],De=["src"],Se={class:"file-name"},Te={class:"file-size"},Ne={key:1,class:"empty"},Ae={__name:"FileList",props:{folderId:{type:Number,default:0}},emits:["preview"],setup(n,{expose:C,emit:d}){const $=n,h=d,p=te(),c=w(!1),i=w([]),m=w([]),o=w({page:1,page_size:20,total:0}),e=w({visible:!1,x:0,y:0,target:null,type:""});function a(t){const v=Z();return`${Ie(t)}?token=${encodeURIComponent(v.Authorization.replace("Bearer ",""))}`}async function g(){var t,v;c.value=!0;try{const[F,N]=await Promise.all([le($.folderId),$e({folder_id:$.folderId,page:o.value.page,page_size:o.value.page_size})]);i.value=F.data||[],m.value=((t=N.data)==null?void 0:t.files)||[],(v=N.data)!=null&&v.pagination&&(o.value=N.data.pagination)}catch{}c.value=!1}function M(t){const v=[...p.breadcrumbs,{id:t.id,name:t.name}];p.setCurrentFolder(t.id,v)}function z(t){t.is_image&&h("preview",t)}function k(t){o.value.page=t,g()}function U(t,v){e.value={visible:!0,x:t.clientX,y:t.clientY,target:v,type:"file"}}function L(t,v){e.value={visible:!0,x:t.clientX,y:t.clientY,target:v,type:"folder"}}function J(){if(e.value.type==="file"){const t=Fe(e.value.target.id),v=Z(),F=document.createElement("a");F.href=`${t}?token=${encodeURIComponent(v.Authorization.replace("Bearer ",""))}`,F.download=e.value.target.original_name,F.click()}e.value.visible=!1}async function G(){const t=e.value.target,v=e.value.type;e.value.visible=!1;try{await X.confirm(`确定删除 ${v==="file"?t.original_name:t.name}？`,"确认删除"),v==="file"?await Be(t.id):await ye(t.id),T.success("已删除"),g()}catch{}}function f(){e.value.visible=!1}function l(t){if(!t)return"0 B";const v=["B","KB","MB","GB"],F=Math.floor(Math.log(t)/Math.log(1024));return(t/Math.pow(1024,F)).toFixed(1)+" "+v[F]}return ee(()=>$.folderId,()=>{o.value.page=1,g()},{immediate:!0}),ae(()=>document.addEventListener("click",f)),se(()=>document.removeEventListener("click",f)),C({loadFiles:g}),(t,v)=>{const F=y("el-icon"),N=y("el-empty"),O=y("el-pagination");return r(),_("div",ze,[c.value?(r(),_("div",Ue,[s(F,{class:"is-loading"},{default:u(()=>[s(x(ie))]),_:1}),v[0]||(v[0]=V(" 加载中...",-1))])):E("",!0),(r(!0),_(q,null,H(i.value,I=>(r(),_("div",{key:"f-"+I.id,class:"file-item folder",onClick:A=>M(I),onContextmenu:Y(A=>L(A,I),["prevent"])},[s(F,{size:48,color:"#f0c040"},{default:u(()=>[s(x(j))]),_:1}),b("span",Me,D(I.name),1)],40,Ve))),128)),(r(!0),_(q,null,H(m.value,I=>(r(),_("div",{key:"file-"+I.id,class:"file-item",onClick:A=>z(I),onContextmenu:Y(A=>U(A,I),["prevent"])},[I.is_image?(r(),_("img",{key:0,src:a(I.id),class:"thumbnail",loading:"lazy"},null,8,De)):(r(),S(F,{key:1,size:48,color:"#909399"},{default:u(()=>[s(x(ne))]),_:1})),b("span",Se,D(I.original_name),1),b("span",Te,D(l(I.file_size)),1)],40,Re))),128)),!c.value&&i.value.length===0&&m.value.length===0?(r(),_("div",Ne,[s(N,{description:"暂无文件"})])):E("",!0),o.value.total>o.value.page_size?(r(),S(O,{key:2,"current-page":o.value.page,"page-size":o.value.page_size,total:o.value.total,layout:"prev, pager, next",onCurrentChange:k,class:"pagination"},null,8,["current-page","page-size","total"])):E("",!0),e.value.visible?(r(),_("div",{key:3,class:"context-menu",style:re({left:e.value.x+"px",top:e.value.y+"px"})},[b("div",{class:"menu-item",onClick:J},"下载"),b("div",{class:"menu-item",onClick:G},"删除")],4)):E("",!0)])}}},Pe=P(Ae,[["__scopeId","data-v-02a58c13"]]),Le={class:"upload-name"},Ee={__name:"FileUpload",props:{folderId:{type:Number,default:0}},emits:["uploaded"],setup(n,{expose:C,emit:d}){const $=n,h=d,p=w(null),c=w(!1),i=w([]);function m(){var e;(e=p.value)==null||e.click()}async function o(e){const a=Array.from(e.target.files);if(a.length){c.value=!0,i.value=a.map(g=>({name:g.name,progress:0,status:""}));for(let g=0;g<a.length;g++){const M=a[g],z=new FormData;z.append("file",M),z.append("folder_id",$.folderId);try{await Ce(z,k=>{k.total&&(i.value[g].progress=Math.round(k.loaded/k.total*100))}),i.value[g].status="done",i.value[g].progress=100}catch{i.value[g].status="error",T.error(`${M.name} 上传失败`)}}h("uploaded"),p.value.value=""}}return C({triggerUpload:m}),(e,a)=>{const g=y("el-progress"),M=y("el-button"),z=y("el-dialog");return r(),_("div",null,[b("input",{ref_key:"fileInput",ref:p,type:"file",multiple:"",hidden:"",onChange:o},null,544),s(z,{modelValue:c.value,"onUpdate:modelValue":a[1]||(a[1]=k=>c.value=k),title:"上传文件","close-on-click-modal":!1,width:"500px"},{footer:u(()=>[s(M,{onClick:a[0]||(a[0]=k=>c.value=!1)},{default:u(()=>[...a[2]||(a[2]=[V("关闭",-1)])]),_:1})]),default:u(()=>[(r(!0),_(q,null,H(i.value,(k,U)=>(r(),_("div",{key:U,class:"upload-item"},[b("div",Le,D(k.name),1),s(g,{percentage:k.progress,status:k.status==="error"?"exception":k.status==="done"?"success":""},null,8,["percentage","status"])]))),128))]),_:1},8,["modelValue"])])}}},qe=P(Ee,[["__scopeId","data-v-ce4d35fd"]]),He=["src"],Ke={__name:"ImagePreview",props:{visible:{type:Boolean,default:!1},file:{type:Object,default:null}},emits:["update:visible"],setup(n,{emit:C}){const d=n,$=C,h=W({get:()=>d.visible,set:c=>$("update:visible",c)}),p=W(()=>{if(!d.file)return"";const i=Z().Authorization.replace("Bearer ","");return`${xe(d.file.id)}?token=${encodeURIComponent(i)}`});return(c,i)=>{var o;const m=y("el-dialog");return r(),S(m,{modelValue:h.value,"onUpdate:modelValue":i[2]||(i[2]=e=>h.value=e),title:(o=n.file)==null?void 0:o.original_name,fullscreen:"","append-to-body":""},{default:u(()=>[b("div",{class:"preview-container",onClick:i[1]||(i[1]=e=>h.value=!1)},[n.file?(r(),_("img",{key:0,src:p.value,class:"preview-image",onClick:i[0]||(i[0]=Y(()=>{},["stop"]))},null,8,He)):E("",!0)])]),_:1},8,["modelValue","title"])}}},Ge=P(Ke,[["__scopeId","data-v-672e58e0"]]),je=["onClick"],Xe={key:1},Ye={__name:"Breadcrumb",props:{items:{type:Array,default:()=>[]}},emits:["navigate"],setup(n,{emit:C}){const d=n,$=C;function h(p,c){const i=d.items.slice(0,c+1);$("navigate",{id:p.id,breadcrumbs:i})}return(p,c)=>{const i=y("el-breadcrumb-item"),m=y("el-breadcrumb");return r(),S(m,{separator:"/"},{default:u(()=>[(r(!0),_(q,null,H(n.items,(o,e)=>(r(),S(i,{key:o.id},{default:u(()=>[e<n.items.length-1?(r(),_("a",{key:0,href:"#",onClick:Y(a=>h(o,e),["prevent"])},D(o.name),9,je)):(r(),_("span",Xe,D(o.name),1))]),_:2},1024))),128))]),_:1})}}},Je=P(Ye,[["__scopeId","data-v-a839e2ec"]]);function Oe(n){return R.get("/recycle-bin",{params:n})}function Qe(n){return R.post(`/recycle-bin/${n}/restore`)}function We(n){return R.delete(`/recycle-bin/${n}`)}function Ze(){return R.post("/recycle-bin/empty")}const et={key:0,class:"empty"},tt={class:"item-info"},nt={class:"item-actions"},lt={__name:"RecycleBin",props:{visible:{type:Boolean,default:!1}},emits:["update:visible","restored"],setup(n,{emit:C}){const d=n,$=C,h=W({get:()=>d.visible,set:e=>$("update:visible",e)}),p=w([]);async function c(){var e;try{const a=await Oe({page:1,page_size:50});p.value=((e=a.data)==null?void 0:e.items)||[]}catch{}}async function i(e){try{await Qe(e),T.success("恢复成功"),c(),$("restored")}catch{}}async function m(e){try{await X.confirm("永久删除后无法恢复，确定？","确认"),await We(e),T.success("已永久删除"),c()}catch{}}async function o(){try{await X.confirm("确定清空回收站？此操作不可恢复","确认"),await Ze(),T.success("回收站已清空"),p.value=[]}catch{}}return ee(()=>d.visible,e=>{e&&c()}),(e,a)=>{const g=y("el-empty"),M=y("el-icon"),z=y("el-button"),k=y("el-drawer");return r(),S(k,{modelValue:h.value,"onUpdate:modelValue":a[0]||(a[0]=U=>h.value=U),title:"回收站",size:"400px"},{footer:u(()=>[s(z,{type:"danger",onClick:o,disabled:p.value.length===0},{default:u(()=>[...a[3]||(a[3]=[V("清空回收站",-1)])]),_:1},8,["disabled"])]),default:u(()=>[p.value.length===0?(r(),_("div",et,[s(g,{description:"回收站为空"})])):E("",!0),(r(!0),_(q,null,H(p.value,U=>(r(),_("div",{key:U.id,class:"recycle-item"},[b("div",tt,[s(M,null,{default:u(()=>[U.original_type==="file"?(r(),S(x(ne),{key:0})):(r(),S(x(j),{key:1}))]),_:2},1024),b("span",null,D(U.original_name),1)]),b("div",nt,[s(z,{size:"small",type:"primary",text:"",onClick:L=>i(U.id)},{default:u(()=>[...a[1]||(a[1]=[V("恢复",-1)])]),_:1},8,["onClick"]),s(z,{size:"small",type:"danger",text:"",onClick:L=>m(U.id)},{default:u(()=>[...a[2]||(a[2]=[V("删除",-1)])]),_:1},8,["onClick"])])]))),128))]),_:1},8,["modelValue"])}}},ot=P(lt,[["__scopeId","data-v-a26da451"]]),at={class:"home-container"},st={class:"header-left"},it={class:"header-right"},rt={class:"user-info"},ut={class:"main-content"},dt={class:"content"},ct={__name:"Home",setup(n){const C=ue(),d=te(),$=w(null),h=w(null),p=w(!0),c=w(!1),i=w(null),m=w(!1),o=w(!1),e=w("");async function a(){try{const f=await _e();d.setUser(f.data)}catch{C.push("/login")}}a();function g(f){d.setCurrentFolder(f.id,f.breadcrumbs)}function M(f){d.setCurrentFolder(f.id,f.breadcrumbs)}function z(f){i.value=f,c.value=!0}function k(){var f;(f=$.value)==null||f.loadFiles()}function U(){e.value="",o.value=!0}async function L(){if(!e.value.trim()){T.warning("请输入文件夹名称");return}try{await ge({name:e.value.trim(),parent_id:d.currentFolderID}),T.success("文件夹创建成功"),o.value=!1,k()}catch{}}function J(f){var l,t;f==="logout"?X.confirm("确定退出登录？","提示").then(()=>{ve(),d.clearUser(),C.push("/login")}).catch(()=>{}):f==="quota"&&T.info(`已用 ${G((l=d.userInfo)==null?void 0:l.storage_used)} / ${G((t=d.userInfo)==null?void 0:t.storage_quota)}`)}function G(f){if(!f)return"0 B";const l=["B","KB","MB","GB","TB"],t=Math.floor(Math.log(f)/Math.log(1024));return(f/Math.pow(1024,t)).toFixed(1)+" "+l[t]}return(f,l)=>{const t=y("el-button"),v=y("el-dropdown-item"),F=y("el-dropdown-menu"),N=y("el-dropdown"),O=y("el-header"),I=y("el-input"),A=y("el-dialog");return r(),_("div",at,[s(O,{class:"header"},{default:u(()=>[b("div",st,[s(t,{class:"menu-btn",icon:x(de),onClick:l[0]||(l[0]=B=>p.value=!p.value)},null,8,["icon"]),l[8]||(l[8]=b("h3",null,"mCloud",-1))]),b("div",it,[s(t,{type:"primary",icon:x(ce),onClick:l[1]||(l[1]=B=>{var K;return(K=h.value)==null?void 0:K.triggerUpload()})},{default:u(()=>[...l[9]||(l[9]=[V("上传",-1)])]),_:1},8,["icon"]),s(t,{icon:x(pe),onClick:U},{default:u(()=>[...l[10]||(l[10]=[V("新建文件夹",-1)])]),_:1},8,["icon"]),s(t,{icon:x(me),onClick:l[2]||(l[2]=B=>m.value=!0)},{default:u(()=>[...l[11]||(l[11]=[V("回收站",-1)])]),_:1},8,["icon"]),s(N,{onCommand:J},{dropdown:u(()=>[s(F,null,{default:u(()=>[s(v,{command:"quota"},{default:u(()=>[...l[12]||(l[12]=[V("存储空间",-1)])]),_:1}),s(v,{command:"logout",divided:""},{default:u(()=>[...l[13]||(l[13]=[V("退出登录",-1)])]),_:1})]),_:1})]),default:u(()=>{var B,K;return[b("span",rt,D(((B=x(d).userInfo)==null?void 0:B.nickname)||((K=x(d).userInfo)==null?void 0:K.username)),1)]}),_:1})])]),_:1}),b("div",ut,[b("aside",{class:Q(["sidebar",{visible:p.value}])},[s(he,{onSelect:g})],2),b("main",dt,[s(Je,{items:x(d).breadcrumbs,onNavigate:M},null,8,["items"]),s(Pe,{"folder-id":x(d).currentFolderID,ref_key:"fileListRef",ref:$,onPreview:z},null,8,["folder-id"])])]),s(qe,{ref_key:"uploadRef",ref:h,"folder-id":x(d).currentFolderID,onUploaded:k},null,8,["folder-id"]),s(Ge,{visible:c.value,"onUpdate:visible":l[3]||(l[3]=B=>c.value=B),file:i.value},null,8,["visible","file"]),s(ot,{visible:m.value,"onUpdate:visible":l[4]||(l[4]=B=>m.value=B),onRestored:k},null,8,["visible"]),s(A,{modelValue:o.value,"onUpdate:modelValue":l[7]||(l[7]=B=>o.value=B),title:"新建文件夹",width:"400px"},{footer:u(()=>[s(t,{onClick:l[6]||(l[6]=B=>o.value=!1)},{default:u(()=>[...l[14]||(l[14]=[V("取消",-1)])]),_:1}),s(t,{type:"primary",onClick:L},{default:u(()=>[...l[15]||(l[15]=[V("创建",-1)])]),_:1})]),default:u(()=>[s(I,{modelValue:e.value,"onUpdate:modelValue":l[5]||(l[5]=B=>e.value=B),placeholder:"请输入文件夹名称",onKeyup:fe(L,["enter"])},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}},vt=P(ct,[["__scopeId","data-v-ad8adf96"]]);export{vt as default};
